
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintha Helping Hand</title>
    
    <!-- Google Font for a professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome 6.5.1 CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- GLASSMORPHISM THEME & LAYOUT REDESIGN --- */
        
        /* --- 1. Variables & General Styling --- */
        :root {
            --primary-color: #185a9d; /* Vibrant Purple */
            --secondary-color: #ffeb3b; /* Bright Yellow */
            --dark-bg-gradient: linear-gradient(145deg, #42cea2 0%, #185a9d 100%);
            
            --text-primary-light: #ffffff;
            --text-secondary-light: rgba(230, 230, 230, 0.8);
            
            --success-color: #81c784; /* Light Green */
            --pending-color: #ffb74d; /* Light Orange */
            --loss-color: #e57373; /* Light Red */
            --reject-color: #9e9e9e; /* Grey */

            /* Glassmorphism Variables */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-hover: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(10, 0, 30, 0.37);
            --glass-blur: 2px;
            --glass-radius: 16px;
            
            --glow-color: rgba(255, 235, 59, 0.8);
            --spin-duration: 8s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        html { scroll-behavior: smooth; }

        body {
            background: var(--dark-bg-gradient);
            color: var(--text-primary-light);
            padding-bottom: 75px; /* Space for bottom nav */
            min-height: 100vh;
            overflow-x: hidden; /* Prevent blobs from causing scroll */
            position: relative;
        }
        
        /* Decorative background blobs */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            z-index: -1;
            opacity: 0.7;
        }
        body::before {
            width: 350px;
            height: 350px;
            background: rgba(255, 235, 59, 0.15);
            top: -100px;
            left: -150px;
        }
        body::after {
            width: 450px;
            height: 450px;
            background: rgba(156, 39, 176, 0.2);
            bottom: -150px;
            right: -150px;
        }

        .container {
            padding: 15px; /* MODIFIED */
            max-width: 1200px;
            margin: 0 auto;
        }

        .page { display: none; }
        .page.active { display: block; }

        h1, h2, h3, h4 { color: var(--text-primary-light); margin-bottom: 0.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); text-align: center; }
        h1 { font-size: 1.6rem; } /* MODIFIED */
        h2 { font-size: 1.3rem; } /* MODIFIED */
        
        /* --- 2. Buttons, Inputs & Forms (Glassmorphism Style) --- */
        button, .btn {
            padding: 8px 14px; border: 1px solid var(--glass-border); border-radius: 8px; cursor: pointer; /* MODIFIED */
            font-size: 0.85rem; font-weight: 600; transition: all 0.25s ease-in-out; text-align: center; /* MODIFIED */
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary-light);
        }
        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        button:disabled { background-color: rgba(100,100,100,0.2); border-color: rgba(100,100,100,0.3); color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-primary { background: var(--primary-color); border-color: var(--primary-color); }
        .btn-secondary { background: var(--secondary-color); border-color: var(--secondary-color); color: #333; }
        .btn-danger { background: var(--loss-color); border-color: var(--loss-color); }
        
        .btn-icon {
            background: none; padding: 5px 8px; font-size: 1rem; box-shadow: none; color: var(--text-secondary-light); border: none; /* MODIFIED */
        }
        .btn-icon:hover { background-color: rgba(255,255,255,0.1); transform: scale(1); }
        .btn-icon.edit { color: var(--primary-color); }
        .btn-icon.delete { color: var(--loss-color); }
        .btn-icon.book { color: var(--success-color); }
        .btn-icon-accept { color: var(--success-color); }
        .btn-icon-reject { color: var(--loss-color); }

        input, select, textarea {
            width: 100%; padding: 8px; margin-bottom: 1rem; /* MODIFIED */
            border-radius: 8px; font-size: 0.85rem; /* MODIFIED */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary-light);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input::placeholder, textarea::placeholder { color: var(--text-secondary-light); }
        select option { background: #333; }

        input[type="file"] {
            padding: 4px; /* MODIFIED */
        }
        input[type="file"]::-webkit-file-upload-button {
             background: var(--primary-color);
             border: none;
             padding: 5px 8px; /* MODIFIED */
             border-radius: 6px;
             color: white;
             cursor: pointer;
             margin-right: 10px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(24, 90, 157, 0.5);
        }
        
        .search-container { position: relative; margin: 20px 0; }
        .search-container .fa-search {
            position: absolute; left: 15px; top: 50%;
            transform: translateY(-50%); color: var(--text-secondary-light);
        }
        .search-container input { padding-left: 40px; }

        /* --- 3. Card & List Styles (Glassmorphism Style) --- */
        .lottery-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: var(--glass-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            margin-bottom: 20px; overflow: hidden;
            transition: transform 0.2s, background 0.2s;
        }
        .lottery-card:hover {
             transform: translateY(-5px);
             background: var(--glass-bg-hover);
        }
        .lottery-card[onclick] { cursor: pointer; }
        
        .lottery-card img { 
            width: 100%; 
            height: auto; 
            display: block;
        }
        .lottery-card-content { padding: 15px; } /* MODIFIED */
        .lottery-card-content h3 { margin-top: 0; margin-bottom: 8px; font-size: 1.1rem; text-align: center; } /* MODIFIED */
        .lottery-card-content p { color: var(--text-secondary-light); font-size: 0.8rem; margin-bottom: 8px; } /* MODIFIED */
        .lottery-card-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .lottery-card-buttons button { flex-grow: 1; }

        /* --- 4. Table Styles (Glassmorphism Style) --- */
        .table-wrapper { 
            overflow-x: auto; 
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--glass-radius);
            padding: 10px;
            margin: 20px 0;
            box-shadow: var(--glass-shadow);
        }
        table {
            width: 100%; border-collapse: collapse;
        }
        th, td {
            padding: 10px 6px; text-align: left; /* MODIFIED */
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-secondary-light);
            font-size: 0.8rem; /* MODIFIED */
        }
        th { 
            background-color: rgba(255,255,255,0.1); 
            color: var(--text-primary-light); 
            font-weight: 600; font-size: 0.75rem; text-transform: uppercase; /* MODIFIED */
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: rgba(255,255,255,0.08); }
        .status-win, .status-confirmed { color: var(--success-color); font-weight: 600; }
        .status-loss { color: var(--loss-color); font-weight: 600; }
        .status-pending { color: var(--pending-color); font-weight: 600; }
        .status-rejected { color: var(--reject-color); font-weight: 600; text-decoration: line-through; }
        .ticket-actions { white-space: nowrap; }

        /* --- 5. Modal Styling (Glassmorphism Style) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(10, 0, 30, 0.4);
            justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            margin: auto; padding: 20px; /* MODIFIED */
            width: 90%; max-width: 500px; border-radius: var(--glass-radius); position: relative;
        }
        .close-btn {
            color: #ccc; position: absolute; top: 10px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover { color: #fff; }

        /* --- 6. Bottom Navigation Bar (Glassmorphism Style) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex; justify-content: space-around;
            border-top: 1px solid var(--glass-border);
            z-index: 999;
        }
        .nav-btn {
            background: none; border: none; color: #bbb; display: flex; flex-direction: column;
            align-items: center; font-size: 0.7rem; /* MODIFIED */ cursor: pointer; transition: color 0.2s, transform 0.2s; 
            flex-grow: 1; height: 100%; justify-content: center;
        }
        .nav-btn.active { 
            color: var(--secondary-color); 
            font-weight: 600;
            transform: translateY(-3px);
        }
        .nav-btn:hover {
             color: var(--text-primary-light);
        }
        .nav-btn .fas { font-size: 20px; margin-bottom: 5px; }

        /* --- 7. Admin Dashboard & Reports (Glassmorphism Style) --- */
        #admin-dashboard-page .admin-nav {
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */
            gap: 10px;
            margin-bottom: 20px;
        }
        #admin-dashboard-page .admin-nav .btn.active {
            background: var(--primary-color);
            color: var(--text-primary-light);
            box-shadow: 0 4px 15px rgba(24, 90, 157, 0.4);
            transform: translateY(-2px);
        }
        #admin-dashboard-page .admin-nav .btn:not(.active) {
            background: var(--glass-bg);
        }

        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .manageable-lottery-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-radius: 12px; margin-bottom: 10px; /* MODIFIED */
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        .manageable-lottery-item:hover { background-color: var(--glass-bg-hover); }
        .manageable-lottery-item-info { flex-grow: 1; cursor: pointer; padding-right: 10px; }
        .manageable-lottery-item-info strong { font-size: 0.9rem; } /* MODIFIED */
        .manageable-lottery-item-info small { font-size: 0.7rem; } /* MODIFIED */
        .manageable-lottery-item-actions { display: flex; align-items: center; }

        .report-lottery-item {
            background: var(--glass-bg); padding: 15px; border-radius: 12px; margin-bottom: 12px;
            border-left: 5px solid var(--primary-color); cursor: pointer;
            transition: all 0.2s ease;
        }
        .report-lottery-item:hover {
            transform: translateX(5px);
            background: var(--glass-bg-hover);
        }
        .report-stats { display: flex; justify-content: space-between; margin-top: 10px; flex-wrap: wrap; gap: 10px;}
        .report-stats span { font-weight: 600; }
        .report-stats .amount { color: var(--success-color); }

        /* --- 8. LIVE DRAW PAGE STYLES --- */
        .live-draw-container {
            background: radial-gradient(circle, #185a9d 0%, #1a2a45 100%);
            padding: 20px 15px; border-radius: var(--glass-radius); /* MODIFIED */
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid var(--secondary-color);
        }
        #live-status {
            text-align: center; font-size: 1.1rem; font-weight: bold; /* MODIFIED */
            color: white; text-shadow: 2px 2px 4px black; margin-bottom: 20px;
        }
        #admin-controls {
            display: none;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
        }
        .admin-controls-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .admin-controls-buttons button { flex-grow: 1; }
        .spinners-container {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; margin-bottom: 30px;
        }
        .spinner-wrapper { text-align: center; }
        .spinner-wrapper h3 {
            color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-size: 1rem; margin-bottom: 15px; /* MODIFIED */
        }

        .spinner-container {
            position: relative;
            width: min(75vw, 250px); /* MODIFIED: Responsive size for mobile */
            height: min(75vw, 250px); /* MODIFIED */
            margin: 0 auto;
            border-radius: 50%;
            box-shadow: 0 0 20px var(--glow-color);
            background: #1a2a45;
            border: 5px solid var(--secondary-color);
            overflow: hidden;
            transition: transform var(--spin-duration) cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .spinner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .spinner-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 30px solid var(--loss-color);
            z-index: 2;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }
        
        @media (min-width: 768px) {
            .spinners-container { 
                flex-direction: row; 
                justify-content: space-around; 
                align-items: flex-start; 
            }
             #admin-dashboard-page .admin-nav {
                flex-direction: row;
                flex-wrap: wrap;
            }
            #logout-btn {
                margin-left: auto;
            }
        }

        /* --- 9. Status Popup --- */
        #status-popup {
            display: none; position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); color: white; padding: 15px 25px;
            border-radius: 8px; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 0; transition: opacity 0.5s, transform 0.5s;
        }
        #status-popup.show {
            display: block; opacity: 1; transform: translateX(-50%) translateY(-10px);
        }
        
        /* --- 10. Loading Animation --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg-gradient);
            display: grid; 
            place-items: center; 
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            text-align: center; 
        }
        /* Wrapper for positioning the icon and rotating border */
        .loader-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
        }
        /* The rotating border */
        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid var(--glass-border);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            box-shadow: var(--glass-shadow);
        }
        /* The static icon in the center */
        .loader-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            color: var(--secondary-color);
            animation: pulse 2s infinite ease-in-out;
        }
        #loading-overlay p {
            position: absolute; 
            top: calc(50% + 60px); 
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            color: var(--text-primary-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader-wrapper">
            <div class="loader"></div>
            <i class="fas fa-hands-helping loader-icon"></i>
        </div>
        <p>Loading Sintha Helping Hand...</p>
    </div>


    <div id="app">

        <!-- HOME PAGE -->
        <div id="lottery-page" class="page active">
            <div class="container">
                <h1>Sintha Helping Hand</h1>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-bar" placeholder="Search for a lottery...">
                </div>
                <h2>Upcoming Draws</h2>
                <div id="lottery-list"></div>
            </div>
        </div>

        <!-- LIVE DRAW PAGE -->
        <div id="live-page" class="page">
            <div class="container">
                <div class="live-draw-container">
                    
                    <p id="live-status">Game not Start...</p>
                    
                    <div id="admin-controls">
                         
                         <label for="spin-interval">Spin Duration (seconds)</label>
                         <input type="number" id="spin-interval" value="8" min="2">
                         <div class="admin-controls-buttons">
                             <button id="start-draw-btn" class="btn btn-primary">Start Draw!</button>
                             <button id="reset-draw-btn" class="btn btn-secondary">Reset Lottery</button>
                         </div>
                    </div>

                    <div class="spinners-container">
                        <div class="spinner-wrapper">
                            <h3>Next Participant</h3>
                            <div id="name-spinner-container" class="spinner-container">
                                <canvas id="wheelCanvas"></canvas>
                                <div class="spinner-pointer"></div>
                            </div>
                        </div>
                        <div class="spinner-wrapper">
                            <h3>Result</h3>
                            <div id="result-spinner-container" class="spinner-container">
                                <canvas id="resultCanvas"></canvas>
                                <div class="spinner-pointer"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3>üèÜ Winners List</h3>
                <div class="table-wrapper">
                    <table id="winners-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3>üéüÔ∏è All Other Tickets</h3>
                <div class="table-wrapper">
                     <table id="losers-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- HISTORY PAGE -->
        <div id="history-page" class="page">
            <div class="container">
                <h1>Lottery History</h1>
                <div id="lottery-history-list"></div>
            </div>
        </div>

        <!-- HISTORY DETAILS PAGE -->
        <div id="lottery-details-page" class="page">
             <div class="container">
                <button onclick="showPage('history-page')" class="btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Back to History</button>
                <h1 id="details-lottery-title"></h1>
                <div class="lottery-card">
                    <img id="details-lottery-img" src="" alt="Lottery Image">
                    <div class="lottery-card-content">
                        <p><strong>Draw Date:</strong> <span id="details-lottery-datetime"></span></p>
                        <p id="details-lottery-desc"></p>
                    </div>
                </div>
                <h3>üèÜ Winners List</h3>
                <div class="table-wrapper">
                    <table id="details-winners-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Prize</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3>üéüÔ∏è All Other Tickets</h3>
                <div class="table-wrapper">
                     <table id="details-losers-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PUBLIC TICKET LIST PAGE -->
        <div id="lottery-for-tickets-page" class="page">
             <div class="container">
                <h1>Select Lottery to View Tickets</h1>
                <div id="lottery-selection-list"></div>
            </div>
        </div>

        <!-- TICKET DETAILS PAGE (for public) -->
        <div id="ticket-details-for-lottery-page" class="page">
            <div class="container">
                <button onclick="showPage('lottery-for-tickets-page')" class="btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Back to Lotteries</button>
                <div id="ticket-lottery-details-container"></div>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="public-ticket-search" placeholder="Search by Ticket No. or Name...">
                </div>
                <div class="table-wrapper">
                    <table id="public-lottery-ticket-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ADMIN LOGIN PAGE -->
        <div id="login-page" class="page">
             <div class="container" style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
                <form id="login-form" class="lottery-card" style="width: 100%; max-width: 400px; padding: 20px;">
                    <h2>Admin Login</h2>
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
                </form>
            </div>
        </div>

        <!-- ADMIN DASHBOARD PAGE -->
        <div id="admin-dashboard-page" class="page">
             <div class="container">
                <h2>Admin Dashboard</h2>
                <div class="admin-nav">
                    <button id="show-manage-lottery" class="btn active">Manage Lottery</button>
                    <button id="show-manage-tickets" class="btn">Manage Tickets</button>
                    <button id="show-reports" class="btn">Book Details</button>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>
                </div>

                <!-- Tab 1: Manage Lotteries -->
                <div id="manage-lottery-tab" class="admin-tab-content active">
                    <div id="admin-lottery-main-view">
                        <div class="lottery-card">
                            <div class="lottery-card-content">
                                <form id="upload-lottery-form">
                                    <input type="hidden" id="editing-lottery-id">
                                    <input type="hidden" id="existing-image-url"> <!-- To keep old base64 if no new file is selected -->
                                    <h4 id="upload-form-title">Upload New Lottery</h4>
                                    <input type="text" id="lottery-title" placeholder="Lottery Title" required>
                                    <textarea id="lottery-details" placeholder="Lottery Details/Description" required></textarea>
                                    
                                    <label for="lottery-image-file">Lottery Image</label>
                                    <input type="file" id="lottery-image-file" accept="image/*">
                                    <img id="image-preview" src="" alt="Image Preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border-radius: 8px;">

                                    <input type="number" id="lottery-ticket-price" placeholder="Ticket Price (‚Çπ)" required style="margin-top: 1rem;">
                                    <label for="lottery-datetime">Draw Date & Time</label>
                                    <input type="datetime-local" id="lottery-datetime" required>
                                    
                                    <div id="prize-inputs-container" style="margin-top: 1rem;">
                                        <label>Prizes</label>
                                    </div>
                                    <button type="button" id="add-prize-btn" class="btn" style="margin-bottom: 1rem;"><i class="fas fa-plus"></i> Add Prize</button>

                                    <button type="submit" class="btn btn-primary" id="upload-lottery-submit-btn">Upload Lottery</button>
                                    <button type="button" class="btn" id="cancel-edit-btn" style="display:none; margin-top:10px;">Cancel Edit</button>
                                </form>
                            </div>
                        </div>
                        <hr style="margin: 25px 0; border-color: var(--glass-border);">
                        <h3>Upcoming Lotteries</h3>
                        <div id="upcoming-lottery-list"></div>
                        <hr style="margin: 25px 0; border-color: var(--glass-border);">
                        <h3>Past Lotteries (History)</h3>
                        <div id="past-lottery-list"></div>
                    </div>
                    <div id="admin-lottery-ticket-view" style="display:none;">
                        <button id="back-to-admin-lotteries-btn" class="btn" style="margin-bottom: 20px;">&larr; Back to Lotteries</button>
                        <div id="admin-ticket-lottery-details-container"></div>
                        <div class="search-container">
                            <i class="fas fa-search"></i><input type="text" id="admin-ticket-search" placeholder="Search tickets...">
                        </div>
                        <div class="table-wrapper">
                            <table id="admin-specific-ticket-table">
                                <thead><tr><th>Ticket #</th><th>Name</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Manage ALL Tickets -->
                <div id="manage-tickets-tab" class="admin-tab-content">
                    <h3>Manage All Booked Tickets</h3>
                    <div class="table-wrapper">
                        <table id="ticket-management-table">
                            <thead><tr><th>Ticket #</th><th>Name</th><th>Mobile</th><th>Lottery</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab 3: Reports / Book Details -->
                <div id="reports-tab" class="admin-tab-content">
                    <h3>Book & Sales Reports</h3>
                    <div id="report-lottery-list-view">
                        <p>Select a lottery to view its detailed sales report.</p>
                        <div id="report-lottery-list"></div>
                    </div>
                    <div id="report-details-view" style="display:none;">
                        <button id="back-to-reports-list-btn" class="btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Back to Lottery List</button>
                        <h3 id="report-details-title"></h3>
                        <div class="table-wrapper">
                            <table id="report-details-table">
                                <thead><tr><th>Buyer Name</th><th>Sold Tickets</th><th>Total Amount (‚Çπ)</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="buy-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="buy-modal-title">Buy Tickets</h2><form id="buy-ticket-form"><input type="text" id="buyer-name" placeholder="Your Name" required><input type="tel" id="buyer-mobile" placeholder="Mobile Number" required><label for="ticket-quantity">Quantity</label><input type="number" id="ticket-quantity" placeholder="Enter quantity" min="1" value="1" required><button type="submit" class="btn btn-primary" style="width:100%;">Request Ticket</button></form></div></div>
    <div id="admin-select-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Contact an Admin</h2><p>Please select an admin to send your ticket request via WhatsApp.</p><ul id="admin-list" style="list-style:none; padding:0;"></ul></div></div>
    <div id="edit-ticket-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Edit Ticket Holder Info</h2><form id="edit-ticket-form"><input type="hidden" id="edit-purchase-id"><label for="edit-buyer-name">Buyer's Name</label><input type="text" id="edit-buyer-name" required><label for="edit-buyer-mobile">Buyer's Mobile</label><input type="tel" id="edit-buyer-mobile" required><label for="edit-ticket-status">Status</label><select id="edit-ticket-status"><option value="pending">Pending</option><option value="confirmed">Confirmed</option><option value="rejected">Rejected</option></select><button type="submit" class="btn btn-primary" style="width:100%;">Save Changes</button></form></div></div>
    
    <!-- Admin Book Ticket Modal -->
    <div id="admin-book-ticket-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="admin-book-modal-title">Book Tickets</h2>
            <form id="admin-book-ticket-form">
                <input type="hidden" id="admin-book-lottery-id">
                <input type="text" id="admin-book-buyer-name" placeholder="Buyer's Name" required>
                <input type="tel" id="admin-book-buyer-mobile" placeholder="Mobile Number" required>
                <label for="admin-book-ticket-quantity">Quantity</label>
                <input type="number" id="admin-book-ticket-quantity" placeholder="Enter quantity" min="1" value="1" required>
                <button type="submit" class="btn btn-primary" style="width:100%;">Book and Confirm Ticket</button>
            </form>
        </div>
    </div>


    <!-- Status Popup -->
    <div id="status-popup"></div>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-page="lottery-page"><i class="fas fa-home"></i> Home</button>
        <button class="nav-btn" data-page="live-page"><i class="fas fa-play-circle"></i> Live</button>
        <button class="nav-btn" data-page="history-page"><i class="fas fa-history"></i> History</button>
        <button class="nav-btn" data-page="lottery-for-tickets-page"><i class="fas fa-clipboard-list"></i> Tickets</button>
        <button class="nav-btn" data-page="login-page"><i class="fas fa-user-shield"></i> Admin</button>
    </nav>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBVRvgTNHgL288wHQNuLxaeiF4UQV4xSIQ", // Replace with your actual API key
          authDomain: "sinthateamtambola.firebaseapp.com", // Replace with your actual auth domain
          databaseURL: "https://sinthateamtambola-default-rtdb.firebaseio.com", // Replace with your actual database URL
          projectId: "sinthateamtambola", // Replace with your actual project ID
          storageBucket: "sinthateamtambola.appspot.com", // Replace with your actual storage bucket
          messagingSenderId: "678704264927", // Replace with your actual sender ID
          appId: "1:678704264927:web:f6f1e06531bbb890179b6a", // Replace with your actual app ID
        };

        // --- INITIALIZE FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const liveDrawRef = db.ref('liveDraw');

        // --- GLOBAL STATE & CACHES ---
        let currentLotteryId = null;
        let purchaseData = {};
        let isSpinning = false;
        let allLotteriesCache = {};
        let allTicketsCache = {};
        let lotteryTicketCounts = {};
        let countdownInterval;

        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const modals = document.querySelectorAll('.modal');
        const statusPopup = document.getElementById('status-popup');

        // Spinner Elements
        const wheelCanvas = document.getElementById('wheelCanvas');
        const ctx = wheelCanvas.getContext('2d');
        const nameSpinnerContainer = document.getElementById('name-spinner-container');
        const resultCanvas = document.getElementById('resultCanvas');
        const resultCtx = resultCanvas.getContext('2d');
        const resultSpinnerContainer = document.getElementById('result-spinner-container');


        // --- CORE APP LOGIC ---

        // 1. PAGE NAVIGATION
        const showPage = (pageId) => {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
            navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
            const adminNavBtn = document.querySelector('.nav-btn[data-page="login-page"]');
            if (auth.currentUser) {
                adminNavBtn.innerHTML = `<i class="fas fa-tachometer-alt"></i> Dashboard`;
            } else {
                adminNavBtn.innerHTML = `<i class="fas fa-user-shield"></i> Admin`;
            }
            if (pageId === 'lottery-page') {
                startCountdownTimers();
            } else {
                if (countdownInterval) clearInterval(countdownInterval);
            }
            window.scrollTo(0, 0);
        };

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                if (pageId === 'login-page' && auth.currentUser) {
                    showPage('admin-dashboard-page');
                } else {
                    showPage(pageId);
                }
            });
        });
        
        // 2. MODAL HANDLING
        const openModal = (modalId) => document.getElementById(modalId).classList.add('show');
        const closeModal = () => modals.forEach(modal => modal.classList.remove('show'));
        document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', closeModal));
        window.addEventListener('click', (e) => modals.forEach(m => { if (e.target === m) closeModal(); }));

        // 3. UTILITY FUNCTIONS
        const showStatus = (message, isSuccess = true) => {
            statusPopup.textContent = message;
            const successColor = "rgba(129, 199, 132, 0.7)"; // From --success-color
            const errorColor = "rgba(229, 115, 115, 0.7)"; // From --loss-color
            statusPopup.style.backgroundColor = isSuccess ? successColor : errorColor;
            statusPopup.classList.add('show');
            setTimeout(() => statusPopup.classList.remove('show'), 3000);
        };
        
        const filterTable = (input, table) => {
            const filter = input.value.toUpperCase();
            const rows = table.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let textContent = rows[i].textContent || rows[i].innerText;
                if (textContent.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        };
        document.getElementById('public-ticket-search').addEventListener('keyup', () => filterTable(document.getElementById('public-ticket-search'), document.querySelector('#public-lottery-ticket-table tbody')));
        document.getElementById('admin-ticket-search').addEventListener('keyup', () => filterTable(document.getElementById('admin-ticket-search'), document.querySelector('#admin-specific-ticket-table tbody')));
        document.getElementById('search-bar').addEventListener('keyup', () => {
            const filter = document.getElementById('search-bar').value.toUpperCase();
            const cards = document.querySelectorAll('#lottery-list .lottery-card');
            cards.forEach(card => {
                const text = card.textContent || card.innerText;
                card.style.display = text.toUpperCase().includes(filter) ? "" : "none";
            });
        });

        // 4. DATA LISTENERS (FOR REAL-TIME UPDATES)
        db.ref('lotteries').on('value', (snapshot) => {
            allLotteriesCache = snapshot.val() || {};
            renderAllLotteryLists();
            // Also refresh admin view if it's active
            if (auth.currentUser && document.getElementById('manage-lottery-tab').classList.contains('active')) {
                loadManageableLotteries();
            }
        });
        
        db.ref('tickets').on('value', snapshot => {
            allTicketsCache = snapshot.val() || {};
            processTicketCounts(); 
            if (auth.currentUser) {
                loadManageableLotteries(); // Refresh counts on lotteries
                loadAllTicketsManagementTable();
                if (document.getElementById('reports-tab').classList.contains('active')) {
                    loadReportsData();
                }
                const adminTicketView = document.getElementById('admin-lottery-ticket-view');
                if(adminTicketView.style.display === 'block' && adminTicketView.dataset.currentLottery) {
                    viewAdminLotteryTickets(adminTicketView.dataset.currentLottery);
                }
            }
        });

        // 5. RENDER LOTTERY LISTS & COUNTDOWN
        const startCountdownTimers = () => {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                document.querySelectorAll('.countdown').forEach(el => {
                    const drawTime = new Date(el.dataset.drawTime).getTime();
                    const now = new Date().getTime();
                    const distance = drawTime - now;

                    if (distance < 0) {
                        el.innerHTML = "DRAW COMPLETED";
                        const card = el.closest('.lottery-card');
                        if (card) {
                            const buyButton = card.querySelector('.buy-btn');
                            if (buyButton) {
                                buyButton.disabled = true;
                                buyButton.textContent = 'Draw Closed';
                            }
                        }
                        return;
                    }
                    const d = Math.floor(distance/(1000*60*60*24)), h = Math.floor((distance%(1000*60*60*24))/(1000*60*60)), m = Math.floor((distance%(1000*60*60))/(1000*60)), s = Math.floor((distance%(1000*60))/1000);
                    el.innerHTML = `<strong>${d}d ${h}h ${m}m ${s}s</strong>`;
                });
            }, 1000);
        };

        const renderAllLotteryLists = () => {
            const now = new Date();
            const lotteries = Object.entries(allLotteriesCache).sort((a,b) => new Date(b[1].datetime) - new Date(a[1].datetime));
            const upcoming = lotteries.filter(([,l]) => new Date(l.datetime) > now).sort((a,b) => new Date(a[1].datetime) - new Date(b[1].datetime));
            const past = lotteries.filter(([,l]) => new Date(l.datetime) <= now);
            renderLotteryCards(upcoming, document.getElementById('lottery-list'), 'home');
            renderLotteryCards(past, document.getElementById('lottery-history-list'), 'history');
            renderLotteryCards(lotteries, document.getElementById('lottery-selection-list'), 'selection');
            startCountdownTimers();
        };

        const renderLotteryCards = (lotteryArray, element, type) => {
            element.innerHTML = '';
            if (lotteryArray.length === 0) {
                 element.innerHTML = `<p style="text-align: center;">No lotteries found.</p>`;
                 return;
            }
            lotteryArray.forEach(([id, lottery]) => {
                const card = document.createElement('div');
                card.className = 'lottery-card';
                let contentHtml = `
                    <img src="${lottery.imageUrl || 'https://via.placeholder.com/600x400.png?text=No+Image'}" alt="${lottery.title}" loading="lazy">
                    <div class="lottery-card-content">
                        <h3>${lottery.title}</h3>
                        <p>${lottery.details || 'No description available.'}</p>
                        <p><strong>Draw on:</strong> ${new Date(lottery.datetime).toLocaleString()}</p>
                    </div>`;
                if (type === 'home') {
                    contentHtml += `<div class="lottery-card-content" style="padding-top:0;">
                        <p class="countdown" data-draw-time="${lottery.datetime}" style="text-align:center; font-size:1.1rem; color: var(--secondary-color);"></p>
                        <div class="lottery-card-buttons">
                           <button class="btn btn-primary buy-btn" data-id="${id}">Buy Ticket (‚Çπ${lottery.price})</button>
                        </div>
                    </div>`;
                } else if (type === 'history') {
                    card.setAttribute('onclick', `viewHistoryDetails('${id}')`);
                } else if (type === 'selection') {
                    card.setAttribute('onclick', `viewPublicLotteryTickets('${id}')`);
                }
                card.innerHTML = contentHtml;
                element.appendChild(card);
            });
        };

        // 6. TICKET PURCHASE FLOW
        document.getElementById('lottery-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('buy-btn')) {
                e.stopPropagation();
                currentLotteryId = e.target.dataset.id;
                const lottery = allLotteriesCache[currentLotteryId];
                document.getElementById('buy-modal-title').textContent = `Buy Tickets for ${lottery.title}`;
                openModal('buy-modal');
            }
        });
        
        document.getElementById('buy-ticket-form').addEventListener('submit', (e) => {
            e.preventDefault();
            purchaseData = {
                name: document.getElementById('buyer-name').value, mobile: document.getElementById('buyer-mobile').value,
                quantity: document.getElementById('ticket-quantity').value, lotteryId: currentLotteryId,
            };
            db.ref('admins').once('value', (snapshot) => {
                const admins = snapshot.val(); const adminListEl = document.getElementById('admin-list');
                adminListEl.innerHTML = '';
                if(admins) {
                    Object.values(admins).forEach(admin => { 
                        const li = document.createElement('li');
                        li.dataset.number = admin.whatsappNumber;
                        li.textContent = admin.name;
                        li.style.cssText = "padding: 12px; background: rgba(0,0,0,0.2); margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s;";
                        adminListEl.appendChild(li);
                    });
                    closeModal(); openModal('admin-select-modal');
                } else { showStatus('No admins available to contact.', false); }
            });
        });

        document.getElementById('admin-list').addEventListener('click', (e) => {
            if (e.target.tagName !== 'LI' || !e.target.dataset.number) return;
            const newPurchaseRef = db.ref('tickets').push();
            const tickets = Array.from({length: purchaseData.quantity}, () => Math.floor(100000 + Math.random() * 900000));
            newPurchaseRef.set({ ...purchaseData, tickets, status: 'pending', timestamp: new Date().toISOString() });
            const lotteryTitle = allLotteriesCache[purchaseData.lotteryId].title;
            const message = `Hello, I'd like to buy ${purchaseData.quantity} ticket(s) for "${lotteryTitle}".\nName: ${purchaseData.name}\nMobile: ${purchaseData.mobile}`;
            window.open(`https://wa.me/${e.target.dataset.number}?text=${encodeURIComponent(message)}`, '_blank');
            closeModal(); showStatus('Request sent! Please complete payment on WhatsApp.');
            document.getElementById('buy-ticket-form').reset();
        });
        
        // 7. PUBLIC-FACING PAGE VIEWS
        window.viewPublicLotteryTickets = async (lotteryId) => {
            const lottery = allLotteriesCache[lotteryId];
            document.getElementById('ticket-lottery-details-container').innerHTML = `<div class="lottery-card"><img src="${lottery.imageUrl}" alt="${lottery.title}"><div class="lottery-card-content"><h3>${lottery.title}</h3><p>${lottery.details}</p></div></div>`;
            const tableBody = document.querySelector('#public-lottery-ticket-table tbody');
            tableBody.innerHTML = '<tr><td colspan="3">Loading tickets...</td></tr>';
            const ticketsSnapshot = await db.ref('tickets').orderByChild('lotteryId').equalTo(lotteryId).once('value');
            let ticketsHtml = '';
            if (ticketsSnapshot.exists()) {
                ticketsSnapshot.forEach(purchaseSnap => {
                    const p = purchaseSnap.val();
                    if(p.status === 'confirmed') { // Only show confirmed tickets publicly
                        p.tickets.forEach(ticketNum => {
                            ticketsHtml += `<tr><td>${ticketNum}</td><td>${p.name}</td><td class="status-${p.status}">${p.status}</td></tr>`;
                        });
                    }
                });
            }
            tableBody.innerHTML = ticketsHtml || '<tr><td colspan="3">No confirmed tickets found for this draw.</td></tr>';
            showPage('ticket-details-for-lottery-page');
        };

        window.viewHistoryDetails = async (lotteryId) => {
            const lottery = allLotteriesCache[lotteryId];
            const resultSnap = await db.ref(`lotteryResults/${lotteryId}`).once('value');
            const result = resultSnap.val();
            document.getElementById('details-lottery-title').textContent = lottery.title;
            document.getElementById('details-lottery-img').src = lottery.imageUrl;
            document.getElementById('details-lottery-datetime').textContent = new Date(lottery.datetime).toLocaleString();
            document.getElementById('details-lottery-desc').textContent = lottery.details;
            const winnersTbody = document.querySelector('#details-winners-table tbody');
            const losersTbody = document.querySelector('#details-losers-table tbody');
            winnersTbody.innerHTML = ''; losersTbody.innerHTML = '';
            if (result) {
                (result.allWinners || []).forEach(p => winnersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-win">${p.prize || 'Winner'}</td></tr>`);
                (result.allLosers || []).forEach(p => losersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-loss">Not a winner</td></tr>`);
            } else { winnersTbody.innerHTML = '<tr><td colspan="3">Results not yet available for this draw.</td></tr>'; }
            showPage('lottery-details-page');
        };

        // 8. LIVE DRAW PAGE & SPINNER LOGIC
        const colors = ['#ffeb3b', '#81c784', '#64b5f6', '#fdd835', '#aed581', '#4dd0e1'];
        let participants = [];

        const drawWheel = () => {
            const numParticipants = participants.length;
            if (numParticipants === 0) {
                 ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
                 return;
            };
            const arcSize = (2 * Math.PI) / numParticipants;
            const radius = wheelCanvas.width / 2;
            ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            ctx.save();
            ctx.translate(radius, radius);
            for (let i = 0; i < numParticipants; i++) {
                const angle = i * arcSize;
                ctx.beginPath();
                ctx.arc(0, 0, radius, angle, angle + arcSize);
                ctx.lineTo(0,0);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.save();
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Poppins';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textAngle = angle + arcSize / 2;
                ctx.rotate(textAngle);
                ctx.fillText(participants[i].name.split(" ")[0], radius * 0.7, 0);
                ctx.restore();
            }
            ctx.restore();
        };

        const drawResultWheel = () => {
            const segments = [
                { text: 'WIN', color: 'var(--success-color)' },
                { text: 'LOSS', color: 'var(--loss-color)' }
            ];
            const numSegments = segments.length;
            const arcSize = (2 * Math.PI) / numSegments;
            const radius = resultCanvas.width / 2;

            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.save();
            resultCtx.translate(radius, radius);

            for (let i = 0; i < numSegments; i++) {
                const angle = i * arcSize;
                resultCtx.beginPath();
                resultCtx.arc(0, 0, radius, angle, angle + arcSize);
                resultCtx.lineTo(0,0);
                resultCtx.fillStyle = segments[i].color;
                resultCtx.fill();

                resultCtx.save();
                resultCtx.fillStyle = 'white';
                resultCtx.font = 'bold 24px Poppins'; // Bigger font for just two segments
                resultCtx.textAlign = 'center';
                resultCtx.textBaseline = 'middle';
                const textAngle = angle + arcSize / 2;
                resultCtx.rotate(textAngle);
                resultCtx.fillText(segments[i].text, radius * 0.6, 0);
                resultCtx.restore();
            }
            resultCtx.restore();
        };

        const spinNameWheel = (winningIndex) => {
            if (isSpinning || participants.length === 0) return;
            isSpinning = true;
            document.getElementById('start-draw-btn').disabled = true;
            const arcSize = 360 / participants.length;
            const randomOffset = Math.random() * arcSize * 0.8 - (arcSize * 0.4);
            const stopAngle = (winningIndex * arcSize) + randomOffset;
            const totalRotation = 360 * 10 - stopAngle;
            const spinDuration = document.getElementById('spin-interval').value || 8;
            nameSpinnerContainer.style.transition = `transform ${spinDuration}s cubic-bezier(0.2, 0.8, 0.2, 1)`;
            nameSpinnerContainer.style.transform = `rotate(${totalRotation}deg)`;
            setTimeout(() => {
                isSpinning = false;
                document.getElementById('start-draw-btn').disabled = false;
            }, spinDuration * 1000);
        };

        const spinResultWheel = (isWin) => {
            const winningIndex = isWin ? 0 : 1; // 0 for WIN, 1 for LOSS
            const numSegments = 2;
            const arcSize = 360 / numSegments;
            
            const randomOffset = Math.random() * arcSize * 0.6 - (arcSize * 0.3);
            const stopAngle = (winningIndex * arcSize) + randomOffset;
            
            const totalRotation = 360 * 5 - stopAngle;
            const spinDuration = 4;
            
            resultSpinnerContainer.style.transition = `transform ${spinDuration}s cubic-bezier(0.25, 1, 0.5, 1)`;
            resultSpinnerContainer.style.transform = `rotate(${totalRotation}deg)`;
        };
        
        liveDrawRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            participants = data.participants || [];
            
            if(wheelCanvas.width !== nameSpinnerContainer.clientWidth || wheelCanvas.width === 0) {
                wheelCanvas.width = wheelCanvas.height = nameSpinnerContainer.clientWidth;
                resultCanvas.width = resultCanvas.height = resultSpinnerContainer.clientWidth;
                drawResultWheel();
            }
            drawWheel();

            document.getElementById('live-status').textContent = data.status || 'Waiting to start...';
            
            if (data.spinTo !== null && data.spinTo !== undefined && !isSpinning) {
                spinNameWheel(data.spinTo);
            }

            if (data.result) {
                if (resultSpinnerContainer.dataset.lastResult !== data.result.status) {
                    spinResultWheel(data.result.status === 'WIN');
                    resultSpinnerContainer.dataset.lastResult = data.result.status;
                }
            } else {
                resultSpinnerContainer.dataset.lastResult = "";
            }

            const winnersTbody = document.querySelector('#winners-table tbody');
            const losersTbody = document.querySelector('#losers-table tbody');
            winnersTbody.innerHTML = ''; losersTbody.innerHTML = '';
            (data.allWinners || []).forEach(p => { winnersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-win">${p.status}</td></tr>`; });
            (data.allLosers || []).forEach(p => { losersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-loss">${p.status}</td></tr>`; });
            
            if (data.isReset) {
                 nameSpinnerContainer.style.transition = 'none';
                 nameSpinnerContainer.style.transform = 'rotate(0deg)';
                 resultSpinnerContainer.style.transition = 'none';
                 resultSpinnerContainer.style.transform = 'rotate(0deg)';
                 isSpinning = false;
                 document.getElementById('start-draw-btn').disabled = false;
                 liveDrawRef.update({ isReset: false });
            }
        });

        document.getElementById('start-draw-btn').addEventListener('click', () => {
             if (participants.length > 0) {
                 const winnerIndex = Math.floor(Math.random() * participants.length);
                 const winner = participants[winnerIndex];
                 
                 const isWinner = Math.random() < 0.2; // 20% chance to win
                 const result = isWinner ? { status: "WIN" } : { status: "LOSS" };
                 
                 liveDrawRef.update({
                     status: `Spinning for ${winner.name}...`,
                     spinTo: winnerIndex,
                     result: null
                 });

                 const spinDuration = (document.getElementById('spin-interval').value || 8) * 1000;
                 setTimeout(() => {
                    liveDrawRef.update({ 
                        status: `${winner.name} got ${result.status}!`,
                        result: result,
                     });
                 }, spinDuration + 500);
             } else {
                 alert('No participants to draw from! Load a lottery first.');
             }
        });

        document.getElementById('reset-draw-btn').addEventListener('click', () => {
             if(confirm('This will clear the live draw board. Are you sure?')) {
                 liveDrawRef.set({ status: "Waiting for Admin...", isReset: true, participants: [], allWinners: [], allLosers: [] });
             }
        });

        // 9. ADMIN AUTH & DASHBOARD
        auth.onAuthStateChanged(user => {
            document.getElementById('admin-controls').style.display = user ? 'block' : 'none';
            const pageId = document.querySelector('.page.active').id;
            // if user logs out while on an admin page, redirect them home
            if (!user && (pageId.startsWith('admin-'))) { 
                showPage('lottery-page'); 
            }
            showPage(pageId); // Re-run to update nav bar text
            if (user) {
                loadAllTicketsManagementTable();
                loadManageableLotteries();
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
            .then(() => showPage('admin-dashboard-page'))
            .catch(error => showStatus(error.message, false));
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

        document.querySelectorAll('#admin-dashboard-page .admin-nav .btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (e.target.id === 'logout-btn') return;
                document.querySelectorAll('#admin-dashboard-page .admin-nav .btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.remove('active'));
                const tabId = e.target.id.replace('show-', '') + '-tab';
                document.getElementById(tabId).classList.add('active');
                if (tabId === 'reports-tab') {
                    loadReportsData();
                }
            });
        });

        // 10. ADMIN: MANAGE LOTTERIES & PRIZES
        const addPrizeInput = (value = '') => {
            const container = document.getElementById('prize-inputs-container');
            const prizeDiv = document.createElement('div');
            prizeDiv.style.display = 'flex';
            prizeDiv.style.gap = '10px';
            prizeDiv.style.marginBottom = '10px';
            prizeDiv.innerHTML = `
                <input type="text" class="lottery-prize-input" placeholder="Enter prize description" value="${value}" required style="margin-bottom: 0;">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(prizeDiv);
        };
        document.getElementById('add-prize-btn').addEventListener('click', () => addPrizeInput());
        
        function uploadImageAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        document.getElementById('lottery-image-file').addEventListener('change', function(event) {
            const preview = document.getElementById('image-preview');
            const file = event.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
                preview.src = '';
            }
        });

        const resetUploadForm = () => {
            document.getElementById('upload-lottery-form').reset();
            document.getElementById('editing-lottery-id').value = '';
            document.getElementById('existing-image-url').value = '';
            document.getElementById('upload-form-title').textContent = 'Upload New Lottery';
            document.getElementById('upload-lottery-submit-btn').textContent = 'Upload Lottery';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('prize-inputs-container').innerHTML = '<label>Prizes</label>';
            document.getElementById('image-preview').style.display = 'none';
            addPrizeInput();
        };

        document.getElementById('cancel-edit-btn').addEventListener('click', resetUploadForm);
        
        document.getElementById('upload-lottery-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('upload-lottery-submit-btn');
            const editingId = document.getElementById('editing-lottery-id').value;
            const prizeInputs = document.querySelectorAll('.lottery-prize-input');
            const prizes = Array.from(prizeInputs).map(input => input.value.trim()).filter(p => p);
            if (prizes.length === 0) {
                showStatus('Please add at least one prize.', false);
                return;
            }

            let imageUrl = document.getElementById('existing-image-url').value;
            const imageFile = document.getElementById('lottery-image-file').files[0];

            if (imageFile) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Converting Image...';
                try {
                    imageUrl = await uploadImageAsBase64(imageFile); 
                } catch (error) {
                    showStatus('Image conversion failed: ' + error.message, false);
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingId ? 'Save Changes' : 'Upload Lottery';
                    return; 
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingId ? 'Save Changes' : 'Upload Lottery';
                }
            } else if (!editingId) {
                showStatus('Please select an image for the new lottery.', false);
                return;
            }

            const lotteryData = {
                title: document.getElementById('lottery-title').value,
                details: document.getElementById('lottery-details').value,
                imageUrl: imageUrl, 
                price: document.getElementById('lottery-ticket-price').value,
                datetime: document.getElementById('lottery-datetime').value,
                prizes: prizes
            };
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            const ref = editingId ? db.ref('lotteries/' + editingId) : db.ref('lotteries').push();
            ref.set(lotteryData)
                .then(() => {
                    showStatus(`Lottery ${editingId ? 'updated' : 'uploaded'} successfully!`);
                    resetUploadForm();
                })
                .catch(err => showStatus(err.message, false))
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingId ? 'Save Changes' : 'Upload Lottery';
                });
        });
        
        const processTicketCounts = () => {
            const tempCounts = {};
            for (const purchase of Object.values(allTicketsCache)) {
                if (!tempCounts[purchase.lotteryId]) tempCounts[purchase.lotteryId] = { confirmed: 0 };
                if (purchase.status === 'confirmed') tempCounts[purchase.lotteryId].confirmed += purchase.tickets.length;
            }
            lotteryTicketCounts = tempCounts;
        };
        
        // **IMPLEMENTED REQUEST: Show and manage past lotteries (history)**
        const loadManageableLotteries = () => {
            const upcomingListEl = document.getElementById('upcoming-lottery-list');
            const pastListEl = document.getElementById('past-lottery-list');
            upcomingListEl.innerHTML = '';
            pastListEl.innerHTML = '';

            const now = new Date();
            const all = Object.entries(allLotteriesCache);
            const upcoming = all.filter(([,l]) => new Date(l.datetime) > now).sort((a,b) => new Date(a[1].datetime) - new Date(b[1].datetime));
            const past = all.filter(([,l]) => new Date(l.datetime) <= now).sort((a,b) => new Date(b[1].datetime) - new Date(a[1].datetime));

            const renderList = (lotteries, element) => {
                if (lotteries.length === 0) { 
                    element.innerHTML = '<p>No lotteries found in this category.</p>'; 
                    return; 
                }
                lotteries.forEach(([id, lottery]) => {
                    const soldCount = lotteryTicketCounts[id] ? lotteryTicketCounts[id].confirmed : 0;
                    const item = document.createElement('div');
                    item.className = 'manageable-lottery-item';
                    item.innerHTML = `
                        <div class="manageable-lottery-item-info" onclick="viewAdminLotteryTickets('${id}')">
                            <strong>${lottery.title}</strong><br>
                            <small>Draw: ${new Date(lottery.datetime).toLocaleDateString()} | <strong>Sold: ${soldCount}</strong></small>
                        </div>
                        <div class="manageable-lottery-item-actions">
                            <button class="btn-icon book" onclick="openAdminBookModal(event, '${id}')" title="Book Ticket"><i class="fas fa-ticket-alt"></i></button>
                            <button class="btn-icon edit" onclick="editLottery(event, '${id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon delete" onclick="removeLottery(event, '${id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>`;
                    element.appendChild(item);
                });
            };

            renderList(upcoming, upcomingListEl);
            renderList(past, pastListEl);
        };

        window.removeLottery = (e, id) => { 
            e.stopPropagation(); 
            if (confirm('Are you sure you want to permanently delete this lottery and all associated ticket data? This action cannot be undone.')) {
                db.ref('lotteries/' + id).remove().then(() => {
                    // Also remove associated tickets
                    db.ref('tickets').orderByChild('lotteryId').equalTo(id).once('value', snapshot => {
                        const updates = {};
                        snapshot.forEach(child => {
                            updates[child.key] = null;
                        });
                        db.ref('tickets').update(updates);
                    });
                    showStatus('Lottery deleted successfully.', true);
                }).catch(err => showStatus(err.message, false));
            } 
        };

        window.editLottery = (e, id) => {
            e.stopPropagation();
            const lottery = allLotteriesCache[id];
            document.getElementById('editing-lottery-id').value = id;
            document.getElementById('lottery-title').value = lottery.title;
            document.getElementById('lottery-details').value = lottery.details;
            
            document.getElementById('existing-image-url').value = lottery.imageUrl;
            const preview = document.getElementById('image-preview');
            preview.src = lottery.imageUrl; 
            preview.style.display = 'block';

            document.getElementById('lottery-ticket-price').value = lottery.price;
            document.getElementById('lottery-datetime').value = lottery.datetime;
            document.getElementById('upload-form-title').textContent = 'Edit Lottery';
            document.getElementById('upload-lottery-submit-btn').textContent = 'Save Changes';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            const prizeContainer = document.getElementById('prize-inputs-container');
            prizeContainer.innerHTML = '<label>Prizes</label>';
            if (lottery.prizes && Array.isArray(lottery.prizes)) {
                lottery.prizes.forEach(prize => addPrizeInput(prize));
            } else {
                addPrizeInput();
            }
            window.scrollTo(0, 0);
        };
        
        // 11. ADMIN: TICKET VIEW & MANAGEMENT (INCLUDING NEW "BOOK" FLOW)
        window.viewAdminLotteryTickets = (lotteryId) => { 
            const lottery = allLotteriesCache[lotteryId];
            const adminTicketView = document.getElementById('admin-lottery-ticket-view');
            adminTicketView.dataset.currentLottery = lotteryId;
            document.getElementById('admin-ticket-lottery-details-container').innerHTML = `<h3>Tickets for: ${lottery.title}</h3>`;
            const tableBody = document.querySelector('#admin-specific-ticket-table tbody');
            tableBody.innerHTML = '';
            Object.entries(allTicketsCache)
                .filter(([,p]) => p.lotteryId === lotteryId)
                .forEach(([id, p]) => {
                    p.tickets.forEach(ticketNum => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `<td>${ticketNum}</td><td>${p.name}</td><td>${p.mobile}</td><td class="status-${p.status}">${p.status}</td><td class="ticket-actions">${p.status === 'pending' ? `<button class="btn-icon btn-icon-accept" title="Accept" onclick="updateTicketStatus('${id}', 'confirmed')"><i class="fas fa-check"></i></button><button class="btn-icon btn-icon-reject" title="Reject" onclick="updateTicketStatus('${id}', 'rejected')"><i class="fas fa-times"></i></button>` : ''}<button class="btn-icon edit" title="Edit" onclick="editTicket('${id}')"><i class="fas fa-edit"></i></button><button class="btn-icon delete" title="Delete" onclick="removeTicket('${id}')"><i class="fas fa-trash"></i></button></td>`;
                    });
                });
            document.getElementById('admin-lottery-main-view').style.display = 'none';
            adminTicketView.style.display = 'block';
        };
        document.getElementById('back-to-admin-lotteries-btn').addEventListener('click', () => {
            document.getElementById('admin-lottery-main-view').style.display = 'block';
            const adminTicketView = document.getElementById('admin-lottery-ticket-view');
            adminTicketView.style.display = 'none';
            delete adminTicketView.dataset.currentLottery;
        });

        const loadAllTicketsManagementTable = () => {
             const tableBody = document.querySelector('#ticket-management-table tbody');
             tableBody.innerHTML = '';
             const purchases = Object.entries(allTicketsCache).reverse();
             purchases.forEach(([id, p]) => {
                 const lotteryTitle = allLotteriesCache[p.lotteryId] ? allLotteriesCache[p.lotteryId].title : 'Unknown Lottery';
                 p.tickets.forEach(ticketNum => {
                     const row = tableBody.insertRow();
                     row.innerHTML = `
                         <td>${ticketNum}</td><td>${p.name}</td><td>${p.mobile}</td><td>${lotteryTitle}</td>
                         <td class="status-${p.status}">${p.status}</td>
                         <td class="ticket-actions">
                             ${p.status === 'pending' ? `<button class="btn-icon btn-icon-accept" title="Accept" onclick="updateTicketStatus('${id}', 'confirmed')"><i class="fas fa-check"></i></button><button class="btn-icon btn-icon-reject" title="Reject" onclick="updateTicketStatus('${id}', 'rejected')"><i class="fas fa-times"></i></button>` : ''}
                             <button class="btn-icon edit" title="Edit" onclick="editTicket('${id}')"><i class="fas fa-edit"></i></button>
                             <button class="btn-icon delete" title="Delete" onclick="removeTicket('${id}')"><i class="fas fa-trash"></i></button>
                         </td>`;
                 });
             });
        };
        window.updateTicketStatus = (id, status) => db.ref(`tickets/${id}/status`).set(status);
        window.removeTicket = (id) => { if (confirm('Delete this ticket purchase record? This cannot be undone.')) db.ref('tickets/' + id).remove(); };
        window.editTicket = (id) => {
            const purchase = allTicketsCache[id];
            document.getElementById('edit-purchase-id').value = id;
            document.getElementById('edit-buyer-name').value = purchase.name;
            document.getElementById('edit-buyer-mobile').value = purchase.mobile;
            document.getElementById('edit-ticket-status').value = purchase.status;
            openModal('edit-ticket-modal');
        };
        document.getElementById('edit-ticket-form').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('edit-purchase-id').value;
            db.ref('tickets/' + id).update({
                name: document.getElementById('edit-buyer-name').value,
                mobile: document.getElementById('edit-buyer-mobile').value,
                status: document.getElementById('edit-ticket-status').value,
            }).then(() => { closeModal(); showStatus('Ticket updated.'); });
        });
        
        window.openAdminBookModal = (e, lotteryId) => {
            e.stopPropagation();
            const lottery = allLotteriesCache[lotteryId];
            if (!lottery) return;
            document.getElementById('admin-book-lottery-id').value = lotteryId;
            document.getElementById('admin-book-modal-title').textContent = `Book for: ${lottery.title}`;
            openModal('admin-book-ticket-modal');
        };

        document.getElementById('admin-book-ticket-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const lotteryId = document.getElementById('admin-book-lottery-id').value;
            const quantity = parseInt(document.getElementById('admin-book-ticket-quantity').value, 10);
            
            const purchaseDetails = {
                lotteryId: lotteryId,
                name: document.getElementById('admin-book-buyer-name').value,
                mobile: document.getElementById('admin-book-buyer-mobile').value,
                quantity: quantity,
                tickets: Array.from({ length: quantity }, () => Math.floor(100000 + Math.random() * 900000)),
                status: 'confirmed', 
                timestamp: new Date().toISOString()
            };
            
            db.ref('tickets').push(purchaseDetails)
                .then(() => {
                    closeModal();
                    showStatus(`${quantity} ticket(s) booked successfully for ${purchaseDetails.name}!`);
                    document.getElementById('admin-book-ticket-form').reset();
                })
                .catch(err => {
                    showStatus(`Error: ${err.message}`, false);
                });
        });


        // 12. ADMIN REPORTS / BOOK DETAILS LOGIC
        const loadReportsData = () => {
            const listEl = document.getElementById('report-lottery-list');
            listEl.innerHTML = '';
            Object.entries(allLotteriesCache).sort((a,b) => new Date(b[1].datetime) - new Date(a[1].datetime)).forEach(([id, lottery]) => {
                let soldTickets = 0; let totalAmount = 0;
                Object.values(allTicketsCache).filter(p => p.lotteryId === id && p.status === 'confirmed').forEach(p => {
                    const ticketCount = p.tickets.length;
                    soldTickets += ticketCount;
                    totalAmount += ticketCount * lottery.price;
                });
                const item = document.createElement('div');
                item.className = 'report-lottery-item';
                item.setAttribute('onclick', `viewReportDetails('${id}')`);
                item.innerHTML = `<strong>${lottery.title}</strong><div class="report-stats"><span>Sold Tickets: <strong>${soldTickets}</strong></span><span class="amount">Total: <strong>‚Çπ${totalAmount.toLocaleString('en-IN')}</strong></span></div>`;
                listEl.appendChild(item);
            });
        };

        window.viewReportDetails = (lotteryId) => {
            const lottery = allLotteriesCache[lotteryId]; if (!lottery) return;
            document.getElementById('report-details-title').textContent = `Sales Details for: ${lottery.title}`;
            const tableBody = document.querySelector('#report-details-table tbody');
            tableBody.innerHTML = '';
            Object.values(allTicketsCache).filter(p => p.lotteryId === lotteryId && p.status === 'confirmed').forEach(purchase => {
                const ticketCount = purchase.tickets.length;
                const amount = ticketCount * lottery.price;
                tableBody.innerHTML += `<tr><td>${purchase.name}</td><td>${ticketCount}</td><td>‚Çπ${amount.toLocaleString('en-IN')}</td></tr>`;
            });
            document.getElementById('report-lottery-list-view').style.display = 'none';
            document.getElementById('report-details-view').style.display = 'block';
        };

        document.getElementById('back-to-reports-list-btn').addEventListener('click', () => {
            document.getElementById('report-lottery-list-view').style.display = 'block';
            document.getElementById('report-details-view').style.display = 'none';
        });

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('loading-overlay');

            // Wait for both lotteries and tickets to load before hiding the loader
            const lotteriesPromise = db.ref('lotteries').once('value');
            const ticketsPromise = db.ref('tickets').once('value');

            Promise.all([lotteriesPromise, ticketsPromise]).then(() => {
                // Initial data processing
                processTicketCounts();
                renderAllLotteryLists();
                
                showPage('lottery-page');
                addPrizeInput(); // Add one prize input to the form by default

                // Initialize spinner canvases
                wheelCanvas.width = wheelCanvas.height = nameSpinnerContainer.clientWidth;
                resultCanvas.width = resultCanvas.height = resultSpinnerContainer.clientWidth;
                drawResultWheel(); // Draw the static result wheel initially

                // Fade out the loader
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);

            }).catch(error => {
                console.error("Firebase initial data load failed:", error);
                loader.innerHTML = '<p style="color:var(--loss-color); text-align:center; padding: 20px;">Failed to load data from the server.<br>Please check your connection and refresh the page.</p>';
            });
        });
    </script>
</body>
</html>
