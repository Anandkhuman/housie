
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Lottery</title>
    <!-- ADDED: Google Font for a cleaner look -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styling & CSS Reset --- */
        :root {
            /* IMPROVED: Refined color palette */
            --primary-color: #6a1b9a;
            --secondary-color: #ffd600;
            --dark-bg: #1a032b;
            --light-gray: #f0f2f5;
            --dark-gray: #333;
            --success-color: #4caf50;
            --pending-color: #ff9800;
            --loss-color: #f44336;
            --reject-color: #757575; /* NEW: for rejected status */
            --glow-color: rgba(255, 214, 0, 0.8);

            /* NEW: Spinner specific colors */
            --spinner-segment-color1: #a047e1; /* Lighter primary */
            --spinner-segment-color2: #8430bd; /* Slightly darker primary */
            --spinner-result-win: var(--secondary-color);
            --spinner-result-loss: #4f4f4f; /* Darker gray for loss */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* IMPROVED: Using the new font */
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            padding-bottom: 70px; /* Space for bottom nav */
        }

        .container {
            padding: 15px;
        }

        /* --- Page Containers --- */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        /* --- Buttons & Inputs --- */
        button, .btn-icon {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #7e2fb0;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--dark-gray);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #ffdf33;
        }
        
        .btn-danger {
            background-color: var(--loss-color);
            color: white;
        }
         .btn-danger:hover:not(:disabled) {
            background-color: #d32f2f;
        }
        
        /* NEW: Icon button styles */
        .btn-icon {
            padding: 6px 10px;
            font-size: 1.2rem;
            background: none;
            box-shadow: none;
            color: var(--dark-gray);
        }
        .btn-icon:hover {
            background-color: #e0e0e0;
        }
        .btn-icon-accept { color: var(--success-color); }
        .btn-icon-reject { color: var(--loss-color); }


        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }

        /* --- Lottery Page & History Page Styling --- */
        #search-bar {
            margin-bottom: 20px;
        }

        .lottery-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .lottery-card:hover {
             transform: translateY(-5px);
             box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        
        /* NEW: Add cursor pointer for history cards */
        #lottery-history-list .lottery-card {
            cursor: pointer;
        }

        .lottery-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .lottery-card-content {
            padding: 15px;
        }

        .lottery-card-content h3 {
            margin-top: 0;
        }

        .lottery-card-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .lottery-card-buttons button {
            flex-grow: 1;
        }
        
        .winner-list-history {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .winner-list-history li {
            padding: 8px;
            background: #e8f5e9;
            border-left: 4px solid var(--success-color);
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .winner-list-history li strong {
            color: var(--primary-color);
        }
        
        /* --- Modal Styling --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        /* NEW: Scope Modal Action Buttons */
        .scope-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-direction: column;
        }
        .scope-modal-actions button {
            width: 100%;
        }
        @media (min-width: 600px) {
             .scope-modal-actions {
                flex-direction: row;
            }
        }


        .prize-list {
            list-style-type: none;
            padding: 0;
        }
        .prize-list li {
            background: var(--light-gray);
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        #admin-list {
            list-style: none;
            padding: 0;
        }
        #admin-list li {
            padding: 12px;
            background: #f0f0f0;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #admin-list li:hover {
            background: #e0e0e0;
        }


        /* --- Live Page & History Details Styling --- */
        .live-draw-container, .history-details-container {
            background: radial-gradient(circle, #3c1053 0%, var(--dark-bg) 100%);
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 0 20px rgba(0,0,0,0.5);
            border: 2px solid var(--primary-color);
            position: relative;
        }
        
        .spinners-container {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .spinner-wrapper {
            text-align: center;
        }
        .spinner-wrapper h3 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        @media (min-width: 600px) {
            .spinners-container {
                flex-direction: row; 
                justify-content: space-around;
                align-items: initial;
            }
             .spinner-wrapper h3 {
                font-size: 1.5rem;
             }
        }

        /* ---- NEW SPINNER WHEEL STYLES ---- */
        .wheel-container {
            position: relative;
            width: 75vw;
            height: 75vw;
            max-width: 280px;
            max-height: 280px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid var(--secondary-color);
            z-index: 10;
            filter: drop-shadow(0px -2px 3px rgba(0,0,0,0.5));
        }

        .wheel {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.7), inset 0 0 15px rgba(255,255,255,0.3);
            overflow: hidden;
            background: var(--dark-bg); /* Fallback, JS sets conic-gradient */
        }

        .wheel-inner {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            /* This is the part that will rotate */
            transition: transform 8s cubic-bezier(0.1, 0.7, 0.2, 1); /* Easing: starts fast, ends slow */
        }

        .wheel-item {
            position: absolute;
            top: 0;
            left: 50%;
            /* Position text around a circle */
            transform-origin: 0% 50%; 
            height: 50%;
            width: 50%;
            padding-left: 15px; /* Push text away from center */
            display: flex;
            align-items: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 0.7rem;

            /* To prevent text overflow */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 45%; /* Don't let text go too far */
        }
        
        .admin-controls {
            display: none; 
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .admin-controls-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .admin-controls-buttons button {
            flex-grow: 1;
        }

        #live-status {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px black;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        th, td {
            border-bottom: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
            vertical-align: middle; /* Align icons nicely */
        }
        th {
            background-color: var(--primary-color);
            color: white;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #ticket-management-table tbody tr {
            cursor: pointer;
        }
        .status-win, .status-confirmed { color: var(--success-color); font-weight: bold; }
        .status-loss { color: var(--loss-color); font-weight: bold; }
        .status-pending { color: var(--pending-color); font-weight: bold; }
        .status-rejected { color: var(--reject-color); font-weight: bold; text-decoration: line-through; } /* NEW */

        /* --- Admin Page Styling --- */
        #admin-dashboard-page .admin-nav {
            display: flex;
            flex-wrap: wrap; 
            margin-bottom: 20px;
            gap: 10px;
        }
        .admin-tab-content {
            display: none;
        }
        .admin-tab-content.active {
            display: block;
        }
        .ticket-actions button, .manage-lottery-actions button {
            margin-right: 5px;
            padding: 5px 8px;
            font-size: 0.8rem;
        }
        /* NEW: Styling for manageable lottery list */
        .manageable-lottery-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* --- Login/Register Page --- */
        #registration-form { display: none; }
        .form-toggle {
            text-align: center;
            margin-top: 15px;
        }
        .form-toggle a {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }

        /* --- Bottom Nav Bar --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #888;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color 0.2s; 
            flex-grow: 1; 
            height: 100%;
            justify-content: center;
        }

        .nav-btn.active {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .nav-btn svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        /* --- Popup for Status --- */
        #status-popup {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark-gray);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
        }
        #status-popup.show {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        
        #ticket-details-card p {
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #ticket-details-card p:last-child {
            border-bottom: none;
        }
        #ticket-details-card strong {
            color: var(--primary-color);
            display: inline-block;
            width: 120px;
        }
        
        /* NEW: Prize input styling */
        .prize-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .prize-input-container input {
            margin-bottom: 0;
        }
        .remove-prize-btn {
            padding: 0;
            width: 30px;
            height: 30px;
            font-size: 1.5rem;
            line-height: 30px;
            flex-shrink: 0;
        }

    </style>
</head>
<body>

    <!-- Main App Container -->
    <div id="app">

        <!-- ============== LOTTERY PAGE ============== -->
        <div id="lottery-page" class="page active">
            <div class="container">
                <h1>Mega Lottery Draws</h1>
                <input type="text" id="search-bar" placeholder="Search for a lottery...">
                <div id="lottery-list">
                    <!-- Lottery cards will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- ============== LIVE PAGE ============== -->
        <div id="live-page" class="page">
            <div class="container">
                <div class="live-draw-container">
                    <h2 style="color:white; text-align:center;">Live Draw!</h2>
                    <p id="live-status">Waiting for Admin to start the draw...</p>
                    
                    <div id="admin-controls" class="admin-controls">
                         <h3>Admin Controls</h3>
                         <label for="spin-interval">Spin Duration (seconds)</label>
                         <input type="number" id="spin-interval" value="8" min="2">
                         <div class="admin-controls-buttons">
                             <button id="start-draw-btn" class="btn-primary">Start Draw!</button>
                             <button id="reset-draw-btn" class="btn-secondary">Reset Lottery</button>
                         </div>
                    </div>

                    <div class="spinners-container">
                        <div class="spinner-wrapper">
                            <h3>Name</h3>
                            <div class="wheel-container">
                                <div class="wheel-pointer"></div>
                                <div class="wheel" id="name-wheel">
                                    <div class="wheel-inner" id="name-wheel-inner"></div>
                                </div>
                            </div>
                        </div>
                         <div class="spinner-wrapper">
                            <h3>Result</h3>
                            <div class="wheel-container">
                                <div class="wheel-pointer"></div>
                                <div class="wheel" id="result-wheel">
                                    <div class="wheel-inner" id="result-wheel-inner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3>🏆 Winners List</h3>
                <div style="overflow-x:auto;">
                    <table id="winners-table">
                        <thead>
                            <tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <br>
                <h3>🎟️ All Other Tickets</h3>
                <div style="overflow-x:auto;">
                     <table id="losers-table">
                        <thead>
                            <tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ============== HISTORY PAGE ============== -->
        <div id="history-page" class="page">
            <div class="container">
                <h1>Lottery History</h1>
                <div id="lottery-history-list"></div>
            </div>
        </div>

        <!-- NEW: HISTORY DETAILS PAGE -->
        <div id="history-details-page" class="page">
             <div class="container">
                <button id="back-to-history-btn" class="btn-secondary" style="margin-bottom: 20px;">&larr; Back to History</button>
                <h1 id="history-details-title"></h1>
                
                <h3>🏆 Winners List</h3>
                <div style="overflow-x:auto;">
                    <table id="history-winners-table">
                        <thead>
                            <tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <br>
                <h3>🎟️ All Other Tickets</h3>
                <div style="overflow-x:auto;">
                     <table id="history-losers-table">
                        <thead>
                            <tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- ============== LOGIN PAGE ============== -->
        <div id="login-page" class="page">
             <div class="container">
                <form id="login-form">
                    <h2>Admin Login</h2>
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
                <form id="registration-form">
                    <h2>Admin Registration</h2>
                    <input type="text" id="reg-name" placeholder="Admin Name (e.g., John)" required>
                    <input type="tel" id="reg-whatsapp" placeholder="WhatsApp Number (e.g., 14155552671)" required>
                    <input type="email" id="reg-email" placeholder="Email" required>
                    <input type="password" id="reg-password" placeholder="Password" required>
                    <button type="submit" class="btn-primary">Register</button>
                </form>
                <div class="form-toggle">
                    <span id="login-toggle-text">Don't have an account? <a id="show-reg-form">Register here</a></span>
                    <span id="reg-toggle-text" style="display: none;">Already have an account? <a id="show-log-form">Login here</a></span>
                </div>
            </div>
        </div>

        <!-- ============== ADMIN DASHBOARD PAGE ============== -->
        <div id="admin-dashboard-page" class="page">
             <div class="container">
                <h2>Admin Dashboard</h2>
                <div class="admin-nav">
                    <button id="show-manage-tickets" class="btn-secondary">Manage Tickets</button>
                    <button id="show-book-ticket" class="btn-secondary">Book Ticket</button>
                    <button id="show-manage-lottery" class="btn-secondary">Manage Lottery</button>
                    <button id="show-upload-lottery" class="btn-secondary">Upload Lottery</button>
                    <button id="logout-btn" class="btn-primary" style="margin-left: auto;">Logout</button>
                </div>

                <!-- Admin Tab 1: Manage Tickets -->
                <div id="manage-tickets-tab" class="admin-tab-content active">
                    <h3>Manage Booked Tickets</h3>
                    <p>Click on a row to see full details.</p>
                    <div style="overflow-x:auto;">
                        <table id="ticket-management-table">
                            <thead>
                                <tr><th>Ticket #</th><th>Name</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin Tab 2: Book Ticket Manually -->
                <div id="book-ticket-tab" class="admin-tab-content">
                    <h3>Book Ticket Manually</h3>
                    <form id="manual-book-form">
                        <label for="manual-lottery-select">Select Lottery</label>
                        <select id="manual-lottery-select" required><option value="">Loading lotteries...</option></select>
                        <label for="manual-buyer-name">Buyer's Name</label>
                        <input type="text" id="manual-buyer-name" placeholder="Enter buyer's name" required>
                        <label for="manual-buyer-mobile">Buyer's Mobile Number</label>
                        <input type="tel" id="manual-buyer-mobile" placeholder="Enter buyer's mobile" required>
                        <label for="manual-ticket-quantity">Quantity</label>
                        <select id="manual-ticket-quantity">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="10">10</option>
                        </select>
                        <button type="submit" class="btn-primary" style="width: 100%;">Book Confirmed Ticket</button>
                    </form>
                </div>
                
                <!-- Admin Tab 3: Manage Lottery -->
                <div id="manage-lottery-tab" class="admin-tab-content">
                    <h3>Manage Upcoming Lotteries</h3>
                    <div id="upcoming-lottery-list"></div>
                </div>

                <!-- Admin Tab 4: Upload Lottery -->
                <div id="upload-lottery-tab" class="admin-tab-content">
                    <h3 id="upload-form-title">Upload New Lottery</h3>
                    <form id="upload-lottery-form">
                        <input type="hidden" id="editing-lottery-id">
                        <input type="text" id="lottery-title" placeholder="Lottery Title" required>
                        <textarea id="lottery-details" placeholder="Lottery Details/Description" required></textarea>
                        <label for="lottery-image">Lottery Image (Required for new, optional for update)</label>
                        <input type="file" id="lottery-image" accept="image/*">
                        <input type="number" id="lottery-ticket-price" placeholder="Ticket Price" required>
                        <label for="lottery-datetime">Draw Date & Time</label>
                        <input type="datetime-local" id="lottery-datetime" required>
                        
                        <!-- NEW: Dynamic Prize Input Area -->
                        <label>Prizes</label>
                        <div id="prize-container">
                            <!-- Prize inputs will be added here by JS -->
                        </div>
                        <button type="button" id="add-prize-btn" class="btn-secondary" style="margin-bottom: 20px;">+ Add Prize</button>
                        
                        <button type="submit" class="btn-primary" id="upload-lottery-submit-btn">Upload Lottery</button>
                        <button type="button" class="btn-secondary" id="cancel-edit-btn" style="display:none; margin-top:10px;">Cancel Edit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ============== MODALS ============== -->

    <!-- Lottery Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <img id="modal-details-img" src="" alt="Lottery Image">
            <h2 id="modal-details-title"></h2>
            <p><strong>Draw Date:</strong> <span id="modal-details-datetime"></span></p>
            <p><strong>Ticket Price:</strong> $<span id="modal-details-price"></span></p>
            <p id="modal-details-desc"></p>
            <h3>Prizes</h3>
            <ul id="modal-details-prizes" class="prize-list"></ul>
            <button class="btn-primary buy-btn-modal" style="width:100%; margin-top: 15px;">Buy Ticket</button>
        </div>
    </div>

    <!-- Buy Ticket Modal -->
    <div id="buy-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Buy Tickets</h2>
            <form id="buy-ticket-form">
                <input type="text" id="buyer-name" placeholder="Your Name" required>
                <input type="tel" id="buyer-mobile" placeholder="Mobile Number" required>
                <label for="ticket-quantity">Quantity</label>
                <select id="ticket-quantity">
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                    <option value="4">4</option><option value="5">5</option><option value="10">10</option>
                </select>
                <button type="submit" class="btn-primary" style="width:100%;">Request Ticket</button>
            </form>
        </div>
    </div>

    <!-- Admin Select Modal -->
    <div id="admin-select-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Contact an Admin to Confirm</h2>
            <p>Please select an admin to send your ticket request via WhatsApp.</p>
            <ul id="admin-list"></ul>
        </div>
    </div>
    
    <!-- Ticket Details Card Modal -->
    <div id="ticket-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Ticket Purchase Details</h2>
            <div id="ticket-details-card"></div>
        </div>
    </div>
    
    <!-- Edit Ticket Modal -->
    <div id="edit-ticket-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Ticket Holder Info</h2>
            <form id="edit-ticket-form">
                <input type="hidden" id="edit-purchase-id">
                <label for="edit-buyer-name">Buyer's Name</label>
                <input type="text" id="edit-buyer-name" required>
                <label for="edit-buyer-mobile">Buyer's Mobile</label>
                <input type="tel" id="edit-buyer-mobile" required>
                <!-- NEW: Status change dropdown -->
                <label for="edit-ticket-status">Status</label>
                <select id="edit-ticket-status">
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="rejected">Rejected</option>
                </select>
                <button type="submit" class="btn-primary" style="width:100%;">Save Changes</button>
            </form>
        </div>
    </div>
    
    <!-- NEW: Action Scope Modal -->
    <div id="scope-modal" class="modal">
      <div class="modal-content">
        <h2 id="scope-modal-title">Confirm Action</h2>
        <p id="scope-modal-text">How would you like to apply this change?</p>
        <div class="scope-modal-actions">
          <button id="scope-action-single" class="btn-primary"></button>
          <button id="scope-action-all" class="btn-secondary"></button>
          <button id="scope-action-cancel" class="btn-danger">Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- Status Popup -->
    <div id="status-popup"></div>

    <!-- ============== BOTTOM NAVIGATION BAR ============== -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-page="lottery-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 18V6h16v12H4zm6-7.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S12.33 12 11.5 12 10 11.33 10 10.5zm-5 0c0-.83.67-1.5 1.5-1.5S8 9.67 8 10.5 7.33 12 6.5 12 5 11.33 5 10.5zm10 0c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5z"/></svg>
            Lottery
        </button>
        <button class="nav-btn" data-page="live-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h-2zm0 6h2v2h-2z"/></svg>
            Live
        </button>
        <button class="nav-btn" data-page="history-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-4-9h8v2H8zm0-4h8v2H8z"/></svg>
            History
        </button>
        <button class="nav-btn" data-page="login-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Admin
        </button>
    </nav>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBVRvgTNHgL288wHQNuLxaeiF4UQV4xSIQ",
          authDomain: "sinthateamtambola.firebaseapp.com",
          databaseURL: "https://sinthateamtambola-default-rtdb.firebaseio.com",
          projectId: "sinthateamtambola",
          storageBucket: "sinthateamtambola.firebasestorage.app",
          messagingSenderId: "678704264927",
          appId: "1:678704264927:web:f6f1e06531bbb890179b6a",
          measurementId: "G-YYSCBRPQY1"
        };


        // --- INITIALIZE FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const liveDrawRef = db.ref('liveDraw');

        // --- GLOBAL VARIABLES & STATE ---
        let currentLotteryId = null;
        let purchaseData = {}; 
        let isSpinning = false; 

        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const modals = document.querySelectorAll('.modal');
        const closeButtons = document.querySelectorAll('.close-btn');
        const lotteryList = document.getElementById('lottery-list');
        const searchBar = document.getElementById('search-bar');
        const statusPopup = document.getElementById('status-popup');

        // --- CORE APP LOGIC ---

        // 1. PAGE NAVIGATION
        const showPage = (pageId) => {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
                
                if (btn.dataset.page === 'login-page') {
                    const icon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                    btn.innerHTML = `${icon} ${auth.currentUser ? 'Dashboard' : 'Admin'}`;
                }
            });
            
            if (pageId === 'admin-dashboard-page') {
                document.getElementById('login-page').classList.remove('active');
            }
            if (pageId === 'history-page') {
                loadLotteryHistory();
            }
        };

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                if (pageId === 'login-page' && auth.currentUser) {
                    showPage('admin-dashboard-page');
                } else {
                    showPage(pageId);
                }
            });
        });

        // 2. MODAL HANDLING
        const openModal = (modalId) => document.getElementById(modalId).classList.add('show');
        const closeModal = () => modals.forEach(modal => modal.classList.remove('show'));
        
        closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
        window.addEventListener('click', (event) => {
            modals.forEach(modal => {
                if (event.target === modal) closeModal();
            });
        });

        // 3. SHOW STATUS POPUP
        const showStatus = (message, isSuccess = true) => {
            statusPopup.textContent = message;
            statusPopup.style.backgroundColor = isSuccess ? 'var(--success-color)' : 'var(--loss-color)';
            statusPopup.classList.add('show');
            setTimeout(() => statusPopup.classList.remove('show'), 3000);
        };

        // 4. LOTTERY PAGE LOGIC
        const renderLotteries = (lotteries) => {
            lotteryList.innerHTML = '';
            if (!lotteries) {
                lotteryList.innerHTML = '<p>No lotteries available right now. Check back later!</p>';
                return;
            }
            const upcomingLotteries = Object.entries(lotteries)
                .filter(([id, lottery]) => new Date(lottery.datetime) > new Date())
                .reverse();
            
            if (upcomingLotteries.length === 0) {
                 lotteryList.innerHTML = '<p>No upcoming lotteries scheduled. Please check the History page for past results.</p>';
                 return;
            }

            upcomingLotteries.forEach(([id, lottery]) => {
                const card = document.createElement('div');
                card.className = 'lottery-card';
                card.innerHTML = `
                    <img src="${lottery.imageUrl}" alt="${lottery.title}">
                    <div class="lottery-card-content">
                        <h3>${lottery.title}</h3>
                        <p>Draw on: ${new Date(lottery.datetime).toLocaleString()}</p>
                        <div class="lottery-card-buttons">
                            <button class="btn-secondary details-btn" data-id="${id}">Details</button>
                            <button class="btn-primary buy-btn" data-id="${id}">Buy Ticket ($${lottery.price})</button>
                        </div>
                    </div>
                `;
                lotteryList.appendChild(card);
            });
        };

        db.ref('lotteries').on('value', (snapshot) => {
            renderLotteries(snapshot.val());
            if (document.getElementById('manage-lottery-tab').classList.contains('active')) {
                loadManageableLotteries();
            }
        });

        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const cards = lotteryList.querySelectorAll('.lottery-card');
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = title.includes(searchTerm) ? 'block' : 'none';
            });
        });

        lotteryList.addEventListener('click', (e) => {
            const lotteryId = e.target.dataset.id;
            if (!lotteryId) return;

            if (e.target.classList.contains('details-btn')) {
                db.ref('lotteries/' + lotteryId).once('value', (snapshot) => {
                    const lottery = snapshot.val();
                    document.getElementById('modal-details-img').src = lottery.imageUrl;
                    document.getElementById('modal-details-title').textContent = lottery.title;
                    document.getElementById('modal-details-datetime').textContent = new Date(lottery.datetime).toLocaleString();
                    document.getElementById('modal-details-price').textContent = lottery.price;
                    document.getElementById('modal-details-desc').textContent = lottery.details;
                    
                    const prizeListEl = document.getElementById('modal-details-prizes');
                    prizeListEl.innerHTML = '';
                    (lottery.prizes || '').split(',').forEach(prize => {
                        prizeListEl.innerHTML += `<li>${prize.trim()}</li>`;
                    });
                    
                    document.querySelector('.buy-btn-modal').dataset.id = lotteryId;
                    openModal('details-modal');
                });
            }

            if (e.target.classList.contains('buy-btn')) {
                currentLotteryId = lotteryId;
                openModal('buy-modal');
            }
        });
        
        document.querySelector('.buy-btn-modal').addEventListener('click', (e) => {
            currentLotteryId = e.target.dataset.id;
            closeModal();
            openModal('buy-modal');
        });

        // 5. TICKET PURCHASE FLOW
        document.getElementById('buy-ticket-form').addEventListener('submit', (e) => {
            e.preventDefault();
            purchaseData = {
                name: document.getElementById('buyer-name').value,
                mobile: document.getElementById('buyer-mobile').value,
                quantity: document.getElementById('ticket-quantity').value,
                lotteryId: currentLotteryId,
            };

            db.ref('admins').once('value', (snapshot) => {
                const admins = snapshot.val();
                const adminListEl = document.getElementById('admin-list');
                adminListEl.innerHTML = '';
                if(admins) {
                    Object.entries(admins).forEach(([id, admin]) => {
                         adminListEl.innerHTML += `<li data-number="${admin.whatsappNumber}">${admin.name}</li>`;
                    });
                } else {
                    adminListEl.innerHTML = '<li>No admins available. Please try again later.</li>';
                }
                closeModal();
                openModal('admin-select-modal');
            });
        });

        document.getElementById('admin-list').addEventListener('click', (e) => {
            if (e.target.tagName === 'LI' && e.target.dataset.number) {
                const adminNumber = e.target.dataset.number;
                const newPurchaseRef = db.ref('tickets').push();
                const purchaseId = newPurchaseRef.key;

                const tickets = Array.from({length: purchaseData.quantity}, () => Math.floor(100000 + Math.random() * 900000));

                const finalPurchaseData = { ...purchaseData, tickets, status: 'pending', timestamp: new Date().toISOString() };
                newPurchaseRef.set(finalPurchaseData);

                const confirmationLink = `${window.location.origin}${window.location.pathname}?confirm=${purchaseId}`;
                db.ref('lotteries/' + purchaseData.lotteryId).once('value', snapshot => {
                    const lotteryTitle = snapshot.val().title;
                    let message = `Hello, I would like to buy ${purchaseData.quantity} ticket(s) for the "${lotteryTitle}" lottery.\n\nName: ${purchaseData.name}\nMobile: ${purchaseData.mobile}\n\nPlease confirm my purchase by clicking this link after payment:\n${confirmationLink}`;
                    const whatsappUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
                    
                    window.open(whatsappUrl, '_blank');
                    closeModal();
                    showStatus('Request sent! Please complete payment on WhatsApp.');
                    document.getElementById('buy-ticket-form').reset();
                });
            }
        });

        // 6. TICKET CONFIRMATION LOGIC
        const checkUrlForConfirmation = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const purchaseId = urlParams.get('confirm');
            if (purchaseId) {
                db.ref('tickets/' + purchaseId + '/status').set('confirmed').then(() => {
                    showStatus('Ticket confirmed successfully!');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }).catch(err => showStatus('Error confirming ticket.', false));
            }
        };


        // 7. LIVE PAGE & SYNCED SPINNER LOGIC (REWORKED FOR WHEEL)
        const prepareAndStartDraw = async () => {
            const startBtn = document.getElementById('start-draw-btn');
            startBtn.disabled = true;
            startBtn.textContent = 'Preparing...';

            try {
                // Find the next upcoming lottery
                const lotteriesSnapshot = await db.ref('lotteries').orderByChild('datetime').once('value');
                let nextLottery = null;
                if (lotteriesSnapshot.exists()) {
                    const allLotteries = Object.entries(lotteriesSnapshot.val());
                    const upcoming = allLotteries.filter(([id, l]) => new Date(l.datetime) > new Date());
                    if (upcoming.length > 0) {
                        // Sort to get the soonest upcoming lottery
                        upcoming.sort((a, b) => new Date(a[1].datetime) - new Date(b[1].datetime));
                        nextLottery = upcoming[0]; 
                    }
                }

                if (!nextLottery) throw new Error("No upcoming lotteries to start a draw.");

                const [lotteryId, lottery] = nextLottery;
                
                const ticketSnapshot = await db.ref('tickets').orderByChild('lotteryId').equalTo(lotteryId).once('value');
                const allTickets = [];
                if (ticketSnapshot.exists()) {
                    ticketSnapshot.forEach(child => {
                        const purchase = child.val();
                        if (purchase.status === 'confirmed') {
                            purchase.tickets.forEach(ticketNum => {
                                allTickets.push({ name: purchase.name, ticket: ticketNum });
                            });
                        }
                    });
                }
                
                if (allTickets.length === 0) throw new Error("No confirmed tickets to start a draw.");

                const prizes = lottery.prizes.split(',').map(p => p.split(':')[0].trim());
                const winners = [];
                const remainingTickets = [...allTickets];

                for (const prize of prizes) {
                    if (remainingTickets.length > 0) {
                        const winnerIndex = Math.floor(Math.random() * remainingTickets.length);
                        const winner = remainingTickets.splice(winnerIndex, 1)[0];
                        winners.push({ ...winner, status: prize });
                    }
                }
                const losers = remainingTickets.map(t => ({ ...t, status: 'Loss' }));
                
                // Shuffle participants to distribute winners evenly on the wheel visually
                const participants = [...winners, ...losers].sort(() => Math.random() - 0.5); 
                
                const interval = document.getElementById('spin-interval').value;
                await liveDrawRef.set({
                    lotteryId: lotteryId,
                    lotteryTitle: lottery.title,
                    participants: participants,
                    winnerCount: winners.length,
                    intervalSeconds: parseInt(interval, 10) || 8,
                    currentWinnerIndex: 0,
                    state: 'spinning',
                    revealedWinners: []
                });

            } catch (error) {
                alert(error.message);
                startBtn.disabled = false;
                startBtn.textContent = 'Start Draw!';
            }
        };

        const syncLiveDrawState = (snapshot) => {
            const drawData = snapshot.val();
            const startBtn = document.getElementById('start-draw-btn');
            const liveStatus = document.getElementById('live-status');
            
            const nameWheelInner = document.getElementById('name-wheel-inner');
            const resultWheelInner = document.getElementById('result-wheel-inner');
            
            if (!drawData || drawData.state === 'idle') {
                liveStatus.textContent = 'Waiting for Admin to start the draw...';
                if(auth.currentUser) {
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Draw!';
                }
                isSpinning = false;
                nameWheelInner.innerHTML = ''; // Clear items on reset
                resultWheelInner.innerHTML = ''; // Clear items on reset
                document.querySelector('#winners-table tbody').innerHTML = '';
                document.querySelector('#losers-table tbody').innerHTML = '';
                // Reset wheel styles
                document.getElementById('name-wheel').style.background = 'var(--dark-bg)';
                document.getElementById('result-wheel').style.background = 'var(--dark-bg)';
                return;
            }

            // Only initialize wheel segments if they haven't been created yet
            if(nameWheelInner.children.length === 0){
                const nameWheel = document.getElementById('name-wheel');
                const resultWheel = document.getElementById('result-wheel');
                const participants = drawData.participants;
                const numParticipants = participants.length;
                const segmentAngle = 360 / numParticipants;

                const nameColors = [];
                const resultColors = [];
                
                // Colors from the provided image
                const segmentColor1 = 'var(--spinner-segment-color1)'; 
                const segmentColor2 = 'var(--spinner-segment-color2)';

                participants.forEach((item, i) => {
                    const itemAngle = (i * segmentAngle) - (segmentAngle / 2); // Center text in segment

                    const nameItem = document.createElement('div');
                    nameItem.className = 'wheel-item';
                    nameItem.textContent = `${item.name} (${item.ticket})`;
                    nameItem.style.transform = `rotate(${itemAngle}deg) translateX(5%)`;
                    nameWheelInner.appendChild(nameItem);

                    const resultItem = document.createElement('div');
                    resultItem.className = 'wheel-item';
                    resultItem.textContent = item.status;
                    resultItem.style.transform = `rotate(${itemAngle}deg) translateX(5%)`;
                    resultWheelInner.appendChild(resultItem);

                    const color = i % 2 === 0 ? segmentColor1 : segmentColor2;
                    nameColors.push(`${color} ${i * segmentAngle}deg, ${color} ${(i + 1) * segmentAngle}deg`);
                    
                    const resultColor = item.status !== 'Loss' ? 'var(--spinner-result-win)' : (i % 2 === 0 ? 'var(--spinner-result-loss)' : 'var(--dark-gray)');
                    resultColors.push(`${resultColor} ${i * segmentAngle}deg, ${resultColor} ${(i + 1) * segmentAngle}deg`);
                });

                nameWheel.style.background = `conic-gradient(${nameColors.join(', ')})`;
                resultWheel.style.background = `conic-gradient(${resultColors.join(', ')})`;
            }

            const winnersTable = document.querySelector('#winners-table tbody');
            winnersTable.innerHTML = '';
            if(drawData.revealedWinners){
                 drawData.revealedWinners.forEach(w => {
                    winnersTable.innerHTML += `<tr><td>${w.ticket}</td><td>${w.name}</td><td class="status-win">${w.status}</td></tr>`;
                });
            }

            if(drawData.state === 'spinning' && !isSpinning) {
                isSpinning = true;
                if(auth.currentUser) startBtn.disabled = true;
                liveStatus.textContent = `Revealing winner ${drawData.currentWinnerIndex + 1} of ${drawData.winnerCount}...`;
                animateSpin(drawData);
            } else if (drawData.state === 'finished') {
                liveStatus.textContent = `Draw for "${drawData.lotteryTitle}" has finished!`;
                if(auth.currentUser) {
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start New Draw';
                }
                isSpinning = false;
                const losersTable = document.querySelector('#losers-table tbody');
                losersTable.innerHTML = '';
                drawData.participants.forEach(p => {
                    if (p.status === 'Loss') {
                        losersTable.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-loss">${p.status}</td></tr>`;
                    }
                });
            }
        };

        const animateSpin = (drawData) => {
            const nameWheelInner = document.getElementById('name-wheel-inner');
            const resultWheelInner = document.getElementById('result-wheel-inner');

            const interval = drawData.intervalSeconds;
            const participants = drawData.participants;
            
            const allWinners = participants.filter(p => p.status !== 'Loss');
            const currentWinnerData = allWinners[drawData.currentWinnerIndex];
            
            if (!currentWinnerData) return;

            const landIndex = participants.findIndex(p => p.ticket === currentWinnerData.ticket);
            
            const segmentAngle = 360 / participants.length;
            // Aim for the center of the segment, with a slight random offset for realism
            const targetAngleForCentering = (segmentAngle / 2) - (segmentAngle * landIndex); 
            const randomOffset = (Math.random() - 0.5) * segmentAngle * 0.4; // Smaller random offset
            const totalRotations = 360 * (Math.floor(Math.random() * 5) + 5); // 5-9 full spins
            const finalSpinAmount = totalRotations + targetAngleForCentering + randomOffset;
            
            const spinWheel = (wheel, delay, duration) => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        // Reset transition for instant snap to 0, then re-enable for spin
                        wheel.style.transition = 'none';
                        wheel.style.transform = `rotate(0deg)`;
                        void wheel.offsetWidth; // Force reflow for instant change

                        wheel.style.transition = `transform ${duration}s cubic-bezier(0.1, 0.7, 0.2, 1)`;
                        wheel.style.transform = `rotate(${finalSpinAmount}deg)`;

                        wheel.addEventListener('transitionend', () => {
                            // Snap to the closest full rotation of the target angle to prevent cumulative error
                            const finalAngle = finalSpinAmount % 360;
                            wheel.style.transition = 'none';
                            wheel.style.transform = `rotate(${finalAngle}deg)`;
                            resolve();
                        }, { once: true });
                    }, delay);
                });
            };
            
            // Spin both wheels, with a slight delay for the result wheel to simulate reveal
            spinWheel(nameWheelInner, 0, interval - 0.5);
            spinWheel(resultWheelInner, 300, interval) // Result wheel spins a bit longer
                .then(() => {
                    if (auth.currentUser) {
                        setTimeout(() => {
                            advanceToNextWinner(currentWinnerData);
                        }, 2000); // Wait 2 seconds after spin to advance
                    }
                });
        };
        
        const advanceToNextWinner = async (revealedWinner) => {
             const currentState = (await liveDrawRef.once('value')).val();
             if(!currentState || (currentState.revealedWinners && currentState.revealedWinners.some(w => w.ticket === revealedWinner.ticket))) {
                 isSpinning = false;
                 return;
             }
             
             const updatedRevealed = [...(currentState.revealedWinners || []), revealedWinner];

             if (updatedRevealed.length < currentState.winnerCount) {
                 await liveDrawRef.update({
                     currentWinnerIndex: currentState.currentWinnerIndex + 1,
                     revealedWinners: updatedRevealed,
                     state: 'spinning' // Keep spinning state for next winner
                 });
             } else {
                 const finalState = {
                     ...currentState,
                     state: 'finished',
                     revealedWinners: updatedRevealed
                 };
                 await liveDrawRef.update(finalState);
                 // Also save the final result to history
                 await db.ref(`lotteryResults/${currentState.lotteryId}`).set(finalState);
             }
             isSpinning = false;
        };


        // --- 8. LOTTERY HISTORY PAGE LOGIC ---
        const loadLotteryHistory = async () => {
            const historyListEl = document.getElementById('lottery-history-list');
            historyListEl.innerHTML = '<p>Loading history...</p>';

            const lotteriesSnapshot = await db.ref('lotteries').once('value');
            const resultsSnapshot = await db.ref('lotteryResults').once('value');
            
            const lotteries = lotteriesSnapshot.val() || {};
            const results = resultsSnapshot.val() || {};

            const pastLotteries = Object.entries(lotteries)
                .filter(([id, lottery]) => new Date(lottery.datetime) <= new Date())
                .reverse();

            if (pastLotteries.length === 0) {
                historyListEl.innerHTML = '<p>No past lotteries found.</p>';
                return;
            }

            historyListEl.innerHTML = '';
            pastLotteries.forEach(([id, lottery]) => {
                const resultData = results[id];
                let winnersHtml = '<p>No winner information available for this draw.</p>';

                if (resultData && resultData.revealedWinners) {
                    winnersHtml = '<ul class="winner-list-history">';
                    resultData.revealedWinners.forEach(winner => {
                        winnersHtml += `<li><strong>${winner.status}:</strong> ${winner.name} (Ticket #${winner.ticket})</li>`;
                    });
                    winnersHtml += '</ul>';
                }

                const card = document.createElement('div');
                card.className = 'lottery-card';
                card.dataset.id = id; // IMPORTANT: Add id for click listener
                card.innerHTML = `
                    <img src="${lottery.imageUrl}" alt="${lottery.title}">
                    <div class="lottery-card-content">
                        <h3>${lottery.title}</h3>
                        <p>Draw was on: ${new Date(lottery.datetime).toLocaleString()}</p>
                        <h4>🏆 Winners</h4>
                        ${winnersHtml}
                    </div>
                `;
                historyListEl.appendChild(card);
            });
        };

        // NEW: Show detailed history view
        document.getElementById('lottery-history-list').addEventListener('click', async e => {
            const card = e.target.closest('.lottery-card');
            if (!card || !card.dataset.id) return;

            const lotteryId = card.dataset.id;
            
            const lotterySnap = await db.ref(`lotteries/${lotteryId}`).once('value');
            const resultSnap = await db.ref(`lotteryResults/${lotteryId}`).once('value');
            
            if (!lotterySnap.exists() || !resultSnap.exists()) {
                showStatus('Could not load details for this lottery.', false);
                return;
            }
            
            const lottery = lotterySnap.val();
            const result = resultSnap.val();
            
            document.getElementById('history-details-title').textContent = lottery.title;
            
            const winnersTbody = document.querySelector('#history-winners-table tbody');
            const losersTbody = document.querySelector('#history-losers-table tbody');
            winnersTbody.innerHTML = '';
            losersTbody.innerHTML = '';
            
            result.participants.forEach(p => {
                if (p.status !== 'Loss') {
                    winnersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-win">${p.status}</td></tr>`;
                } else {
                    losersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-loss">${p.status}</td></tr>`;
                }
            });
            
            showPage('history-details-page');
        });
        
        document.getElementById('back-to-history-btn').addEventListener('click', () => {
            showPage('history-page');
        });


        // --- 9. ADMIN AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            const adminControls = document.getElementById('admin-controls');
            if (user) {
                adminControls.style.display = 'block';
                if(document.querySelector('.page.active').id === 'login-page') {
                    showPage('admin-dashboard-page');
                }
                loadAdminData();
            } else {
                adminControls.style.display = 'none';
                if(document.getElementById('admin-dashboard-page').classList.contains('active')){
                    showPage('lottery-page');
                }
            }
            // Re-render nav buttons to update 'Admin' to 'Dashboard' or vice versa
            navButtons.forEach(btn => {
                if (btn.dataset.page === 'login-page') {
                    const icon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                    btn.innerHTML = `${icon} ${auth.currentUser ? 'Dashboard' : 'Admin'}`;
                }
            });
        });
        
        document.getElementById('show-reg-form').addEventListener('click', () => {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('registration-form').style.display = 'block';
            document.getElementById('login-toggle-text').style.display = 'none';
            document.getElementById('reg-toggle-text').style.display = 'block';
        });
        document.getElementById('show-log-form').addEventListener('click', () => {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('registration-form').style.display = 'none';
            document.getElementById('login-toggle-text').style.display = 'block';
            document.getElementById('reg-toggle-text').style.display = 'none';
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert(error.message));
        });
        
        document.getElementById('registration-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const whatsapp = document.getElementById('reg-whatsapp').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const adminId = userCredential.user.uid;
                    return db.ref('admins/' + adminId).set({ name, whatsappNumber: whatsapp, email });
                })
                .then(() => showStatus('Registration successful! You are now logged in.'))
                .catch(error => alert(error.message));
        });

        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        
        // --- 10. ADMIN DASHBOARD LOGIC ---
        const adminTabs = document.querySelectorAll('.admin-tab-content');
        const adminNavBtns = document.querySelectorAll('#admin-dashboard-page .admin-nav button');

        adminNavBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if(e.target.id === 'logout-btn') return;
                adminNavBtns.forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-secondary');
                });
                e.target.classList.add('btn-primary');
                e.target.classList.remove('btn-secondary');

                adminTabs.forEach(tab => tab.classList.remove('active'));
                const tabId = e.target.id.replace('show-', '') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        const resetUploadForm = () => {
            document.getElementById('upload-lottery-form').reset();
            document.getElementById('prize-container').innerHTML = ''; // Clear prizes
            document.getElementById('editing-lottery-id').value = '';
            document.getElementById('upload-form-title').textContent = 'Upload New Lottery';
            document.getElementById('upload-lottery-submit-btn').textContent = 'Upload Lottery';
            document.getElementById('lottery-image').required = true;
            document.getElementById('cancel-edit-btn').style.display = 'none';
            // Add one default prize input back
            document.getElementById('add-prize-btn').click(); 
        }

        document.getElementById('cancel-edit-btn').addEventListener('click', resetUploadForm);

        // NEW: Dynamic Prize Input Logic
        const prizeContainer = document.getElementById('prize-container');
        document.getElementById('add-prize-btn').addEventListener('click', () => {
            const prizeInputDiv = document.createElement('div');
            prizeInputDiv.className = 'prize-input-container';
            prizeInputDiv.innerHTML = `
                <input type="text" class="prize-input" placeholder="e.g., 1st Prize: $1000" required>
                <button type="button" class="btn-danger remove-prize-btn">&times;</button>
            `;
            prizeContainer.appendChild(prizeInputDiv);
        });
        prizeContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-prize-btn')) {
                e.target.parentElement.remove();
            }
        });

        document.getElementById('upload-lottery-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const editingId = document.getElementById('editing-lottery-id').value;
            const title = document.getElementById('lottery-title').value;
            const details = document.getElementById('lottery-details').value;
            const imageFile = document.getElementById('lottery-image').files[0];
            const price = document.getElementById('lottery-ticket-price').value;
            const datetime = document.getElementById('lottery-datetime').value;
            
            // NEW: Collect prizes from dynamic inputs
            const prizeInputs = document.querySelectorAll('.prize-input');
            const prizes = Array.from(prizeInputs).map(input => input.value.trim()).filter(Boolean).join(','); // Filter empty prizes

            if (!prizes) {
                alert('Please add at least one prize.');
                return;
            }
            
            const lotteryData = { title, details, price, datetime, prizes };

            const handleDbOperation = (imageUrl) => {
                if (imageUrl) lotteryData.imageUrl = imageUrl;
                
                const dbRef = editingId ? db.ref('lotteries/' + editingId) : db.ref('lotteries').push();
                if (!editingId) lotteryData.createdAt = new Date().toISOString();
                
                const operation = editingId ? dbRef.update(lotteryData) : dbRef.set(lotteryData);

                operation.then(() => {
                    showStatus(`Lottery ${editingId ? 'updated' : 'uploaded'} successfully!`);
                    resetUploadForm();
                }).catch(err => showStatus('Operation failed: ' + err.message, false));
            };
            
            if (imageFile) {
                const reader = new FileReader();
                reader.readAsDataURL(imageFile);
                reader.onload = () => handleDbOperation(reader.result);
            } else {
                if(editingId) { // Allow updating without changing image if editing
                    handleDbOperation(null);
                }
                else {
                    alert('Please select an image for a new lottery.');
                }
            }
        });
        
        const populateLotterySelect = () => {
            const selectEl = document.getElementById('manual-lottery-select');
            db.ref('lotteries').once('value', snapshot => {
                const lotteries = snapshot.val();
                selectEl.innerHTML = '<option value="">-- Select a Lottery --</option>';
                if(lotteries) {
                    const sorted = Object.entries(lotteries)
                        .filter(([id, lottery]) => new Date(lottery.datetime) > new Date())
                        .reverse();
                    sorted.forEach(([id, lottery]) => {
                        selectEl.innerHTML += `<option value="${id}">${lottery.title}</option>`;
                    });
                }
            });
        };
        document.getElementById('manual-book-form').addEventListener('submit', e => {
            e.preventDefault();
            const lotteryId = document.getElementById('manual-lottery-select').value;
            const name = document.getElementById('manual-buyer-name').value;
            const mobile = document.getElementById('manual-buyer-mobile').value;
            const quantity = parseInt(document.getElementById('manual-ticket-quantity').value, 10);
            if (!lotteryId) { alert('Please select a lottery.'); return; }

            const tickets = Array.from({length: quantity}, () => Math.floor(100000 + Math.random() * 900000));
            db.ref('tickets').push({ lotteryId, name, mobile, quantity, tickets, status: 'confirmed', timestamp: new Date().toISOString() })
            .then(() => {
                showStatus(`${quantity} ticket(s) booked successfully for ${name}.`);
                e.target.reset();
            }).catch(err => showStatus('Booking failed: ' + err.message, false));
        });

        // --- 11. ADMIN DATA LOADING & ACTIONS (HEAVILY MODIFIED) ---
        const loadAdminData = () => {
            populateLotterySelect();
            loadManageableLotteries();

            db.ref('tickets').on('value', (snapshot) => {
                const ticketsTableBody = document.querySelector('#ticket-management-table tbody');
                ticketsTableBody.innerHTML = '';
                const purchases = snapshot.val();
                if(purchases){
                    // Convert to array, sort by timestamp descending, then iterate
                    const sortedPurchases = Object.entries(purchases)
                        .sort(([, a], [, b]) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by newest first
                        
                    sortedPurchases.forEach(([id, purchase]) => {
                        // Display each individual ticket within a purchase
                        purchase.tickets.forEach(ticketNum => {
                            const row = document.createElement('tr');
                            Object.assign(row.dataset, purchase, { 
                                purchaseId: id, 
                                tickets: purchase.tickets.join(', '), // Store all tickets in data-tickets
                                singleTicketNum: ticketNum // Store the specific ticket number for this row
                            });
                            
                            // NEW: Add icons for pending status
                            let pendingActions = '';
                            if (purchase.status === 'pending') {
                                pendingActions = `
                                    <button class="btn-icon btn-icon-accept" title="Accept">&#10004;</button>
                                    <button class="btn-icon btn-icon-reject" title="Reject">&#10006;</button>
                                `;
                            }

                            row.innerHTML = `
                                <td>${ticketNum}</td>
                                <td>${purchase.name}</td>
                                <td class="status-${purchase.status}">${purchase.status}</td>
                                <td class="ticket-actions">
                                    ${pendingActions}
                                    <button class="btn-primary edit-ticket-btn">Edit</button>
                                    <button class="btn-danger remove-ticket-btn">Remove</button>
                                </td>
                            `;
                            ticketsTableBody.appendChild(row);
                        });
                    });
                }
            });
        };
        
        document.querySelector('#ticket-management-table tbody').addEventListener('click', e => {
            const row = e.target.closest('tr');
            if (!row) return;

            const purchaseData = { ...row.dataset };

            if (e.target.classList.contains('remove-ticket-btn')) {
                showScopeModal('remove', purchaseData);
            } else if (e.target.classList.contains('edit-ticket-btn')) {
                document.getElementById('edit-purchase-id').value = purchaseData.purchaseId;
                document.getElementById('edit-buyer-name').value = purchaseData.name;
                document.getElementById('edit-buyer-mobile').value = purchaseData.mobile;
                document.getElementById('edit-ticket-status').value = purchaseData.status; // Set status
                openModal('edit-ticket-modal');
            } else if (e.target.classList.contains('btn-icon-accept')) {
                showScopeModal('updateStatus', purchaseData, 'confirmed');
            } else if (e.target.classList.contains('btn-icon-reject')) {
                showScopeModal('updateStatus', purchaseData, 'rejected');
            } else {
                const detailsCard = document.getElementById('ticket-details-card');
                detailsCard.innerHTML = `
                    <p><strong>Name:</strong> ${purchaseData.name}</p>
                    <p><strong>Mobile:</strong> ${purchaseData.mobile}</p>
                    <p><strong>Status:</strong> <span class="status-${purchaseData.status}">${purchaseData.status}</span></p>
                    <p><strong>Tickets:</strong> ${purchaseData.tickets}</p>
                    <p><strong>Quantity:</strong> ${purchaseData.quantity}</p>
                    <p><strong>Purchase ID:</strong> ${purchaseData.purchaseId.slice(-8)}</p>
                    <p><strong>Date:</strong> ${new Date(purchaseData.timestamp).toLocaleString()}</p>
                `;
                openModal('ticket-details-modal');
            }
        });

        document.getElementById('edit-ticket-form').addEventListener('submit', e => {
            e.preventDefault();
            const purchaseId = document.getElementById('edit-purchase-id').value;
            const name = document.getElementById('edit-buyer-name').value;
            const mobile = document.getElementById('edit-buyer-mobile').value;
            const status = document.getElementById('edit-ticket-status').value;
            
            const purchaseData = { purchaseId, name, mobile, status };
            showScopeModal('updateAll', purchaseData);
        });
        
        // --- 12. NEW SCOPE MODAL & ACTION LOGIC ---
        const scopeModal = document.getElementById('scope-modal');
        let currentScopeHandler = { single: null, all: null };
        
        const showScopeModal = (actionType, purchaseData, newStatus = null) => {
            const titleEl = document.getElementById('scope-modal-title');
            const singleBtn = document.getElementById('scope-action-single');
            const allBtn = document.getElementById('scope-action-all');
            const textEl = document.getElementById('scope-modal-text'); // Get the paragraph element
            
            let actionText = '';
            
            if (actionType === 'remove') {
                actionText = 'remove';
                titleEl.textContent = `Remove Ticket Purchase`;
                textEl.textContent = `You are about to remove a ticket purchase associated with "${purchaseData.name}". Would you like to remove just this specific entry or all purchases made by this user?`;
            } else if (actionType === 'updateStatus') {
                actionText = `update status to '${newStatus}'`;
                titleEl.textContent = `Update Ticket Status`;
                textEl.textContent = `You are about to change the status of a ticket purchase to "${newStatus}". Would you like to apply this change only to this purchase or to all purchases made by "${purchaseData.name}"?`;
            } else if (actionType === 'updateAll') {
                actionText = 'save changes';
                titleEl.textContent = `Save Changes`;
                textEl.textContent = `You are about to update details for a ticket purchase. Would you like to apply these changes only to this purchase or to all purchases made by "${purchaseData.name}"?`;
            }
            
            singleBtn.textContent = `${actionText.charAt(0).toUpperCase() + actionText.slice(1)} for This Purchase`;
            allBtn.textContent = `${actionText.charAt(0).toUpperCase() + actionText.slice(1)} for ALL Purchases by ${purchaseData.name}`;

            currentScopeHandler.single = () => performAction(actionType, purchaseData, 'single', newStatus);
            currentScopeHandler.all = () => performAction(actionType, purchaseData, 'all', newStatus);

            openModal('scope-modal');
        }
        
        scopeModal.addEventListener('click', e => {
            if (e.target.id === 'scope-action-single' && currentScopeHandler.single) currentScopeHandler.single();
            if (e.target.id === 'scope-action-all' && currentScopeHandler.all) currentScopeHandler.all();
            if (e.target.id === 'scope-action-cancel' || e.target === scopeModal) {
                 currentScopeHandler = { single: null, all: null }; // Clear handlers
                 closeModal();
            }
        });
        
        const performAction = async (type, data, scope, newStatus) => {
            closeModal();
            
            const processUpdates = (updates, successMsg) => {
                db.ref().update(updates)
                    .then(() => showStatus(successMsg))
                    .catch(err => showStatus('Error: ' + err.message, false));
            };
            
            if (scope === 'single') {
                const updates = {};
                if (type === 'remove') updates[`/tickets/${data.purchaseId}`] = null;
                else if (type === 'updateStatus') updates[`/tickets/${data.purchaseId}/status`] = newStatus;
                else if (type === 'updateAll') {
                    updates[`/tickets/${data.purchaseId}/name`] = data.name;
                    updates[`/tickets/${data.purchaseId}/mobile`] = data.mobile;
                    updates[`/tickets/${data.purchaseId}/status`] = data.status;
                }
                processUpdates(updates, 'Action completed for single purchase.');
            } 
            else if (scope === 'all') {
                const snapshot = await db.ref('tickets').orderByChild('name').equalTo(data.name).once('value');
                if (!snapshot.exists()) {
                    showStatus('No other purchases found for this owner.', false);
                    return;
                }
                
                const updates = {};
                snapshot.forEach(childSnap => {
                    const purchaseId = childSnap.key;
                    if (type === 'remove') updates[`/tickets/${purchaseId}`] = null;
                    else if (type === 'updateStatus') updates[`/tickets/${purchaseId}/status`] = newStatus;
                    else if (type === 'updateAll') {
                         updates[`/tickets/${purchaseId}/name`] = data.name;
                         updates[`/tickets/${purchaseId}/mobile`] = data.mobile;
                         updates[`/tickets/${purchaseId}/status`] = data.status;
                    }
                });
                processUpdates(updates, `Action completed for all purchases by ${data.name}.`);
            }
            
            currentScopeHandler = { single: null, all: null }; // Reset handlers
        };

        // --- 13. MANAGE LOTTERY TAB FUNCTIONS ---
        const loadManageableLotteries = () => {
            const listEl = document.getElementById('upcoming-lottery-list');
            db.ref('lotteries').once('value', snapshot => {
                listEl.innerHTML = '';
                const lotteries = snapshot.val();
                if (lotteries) {
                    const upcoming = Object.entries(lotteries)
                        .filter(([id, lot]) => new Date(lot.datetime) > new Date())
                        .sort(([, a], [, b]) => new Date(a.datetime) - new Date(b.datetime)); // Sort by soonest upcoming
                    
                    if (upcoming.length === 0) {
                        listEl.innerHTML = '<p>No upcoming lotteries to manage.</p>';
                        return;
                    }
                    
                    upcoming.forEach(([id, lottery]) => {
                        const item = document.createElement('div');
                        item.className = 'manageable-lottery-item';
                        item.innerHTML = `
                            <div>
                                <strong>${lottery.title}</strong>
                                <br>
                                <small>Draw: ${new Date(lottery.datetime).toLocaleDateString()}</small>
                            </div>
                            <div class="manage-lottery-actions">
                                <button class="btn-primary" onclick="editLottery('${id}')">Edit</button>
                                <button class="btn-danger" onclick="removeLottery('${id}')">Remove</button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });
                }
            });
        };
        window.removeLottery = (lotteryId) => {
            if (confirm('Are you sure you want to permanently delete this lottery?')) {
                db.ref('lotteries/' + lotteryId).remove()
                    .then(() => showStatus('Lottery removed.'))
                    .catch(err => showStatus('Error: ' + err.message, false));
            }
        };

        window.editLottery = (lotteryId) => {
            db.ref('lotteries/' + lotteryId).once('value', snapshot => {
                const lottery = snapshot.val();
                document.getElementById('show-upload-lottery').click();

                document.getElementById('editing-lottery-id').value = lotteryId;
                document.getElementById('lottery-title').value = lottery.title;
                document.getElementById('lottery-details').value = lottery.details;
                document.getElementById('lottery-ticket-price').value = lottery.price;
                document.getElementById('lottery-datetime').value = lottery.datetime;
                
                // NEW: Populate dynamic prize inputs
                prizeContainer.innerHTML = '';
                if(lottery.prizes){
                    lottery.prizes.split(',').forEach(prizeText => {
                        const prizeInputDiv = document.createElement('div');
                        prizeInputDiv.className = 'prize-input-container';
                        prizeInputDiv.innerHTML = `
                            <input type="text" class="prize-input" value="${prizeText.trim()}" required>
                            <button type="button" class="btn-danger remove-prize-btn">&times;</button>
                        `;
                        prizeContainer.appendChild(prizeInputDiv);
                    });
                } else {
                    // If no prizes are defined, add a default empty input
                    document.getElementById('add-prize-btn').click(); 
                }

                document.getElementById('upload-form-title').textContent = 'Editing: ' + lottery.title;
                document.getElementById('upload-lottery-submit-btn').textContent = 'Update Lottery';
                document.getElementById('lottery-image').required = false;
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            });
        };

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            checkUrlForConfirmation();
            showPage('lottery-page');
            // Ensure at least one prize input is present on load
            if (prizeContainer.children.length === 0) {
                document.getElementById('add-prize-btn').click();
            }
        });

    </script>
</body>
</html>
