<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintha Lagao</title>
    <!-- Google Fonts for the theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ================== FIREBASE SDKs ================== -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<style>
    /* ==================== GLOBAL & THEME STYLES ==================== */
    :root {
        --gold: #FFD700;
        --deep-red: #8B0000;
        --dark-red: #4a0404;
        --table-green: #00ffff;
        --light-gold: #fffbeb;
        --dark-gray: #333;
    }

    body {
        margin: 0 0 80px 0; /* Add bottom margin for nav bar */
        font-family: 'Poppins', sans-serif;
        background-color: var(--dark-red);
        background-image: radial-gradient(var(--deep-red) 1px, transparent 1px),
                          radial-gradient(var(--deep-red) 1px, var(--dark-red) 1px);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
        color: white;
        padding: 1rem;
        box-sizing: border-box;
    }
    
    .page {
        display: none; /* Hide all pages by default */
        min-height: calc(100vh - 110px);
        justify-content: center;
        align-items: center;
        width: 100%;
        flex-direction: column; /* Allow multiple containers vertically */
    }

    .page.active {
        display: flex; /* Show the active page */
    }
    
    .content-container {
        width: 100%;
        max-width: 600px;
        background-color: rgba(0, 0, 0, 0.4);
        border: 3px solid var(--gold);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .page-title {
        font-family: 'Cinzel Decorative', cursive;
        color: var(--gold);
        font-size: 1.5rem;
        margin: 0;
        text-shadow: 2px 2px 4px var(--deep-red);
        text-align: center;
        border-bottom: 2px solid var(--gold);
        padding-bottom: 10px;
    }

    /* ==================== GAME STYLES (Existing & NEW) ==================== */
    .game-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
    .game-title { font-family: 'Cinzel Decorative', cursive; color: var(--gold); font-size: 1.5rem; margin: 0; text-shadow: 2px 2px 4px var(--deep-red); }
    .wallet { background-color: var(--gold); color: var(--deep-red); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
    .game-state { text-align: center; }
    .period-info { text-align: center; font-size: 1.1rem; color: var(--gold); margin-bottom: 5px; font-weight: 600; }
    .timer-display { font-size: 4rem; font-weight: 700; line-height: 1; color: #4ade80; transition: color 0.5s; }
    .timer-display.locked { color: #f87171; }
    .status-message { font-size: 1.2rem; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; min-height: 22px; }
    .dice-tray { display: flex; justify-content: center; gap: 10px; perspective: 800px; min-height: 54px; }
    .dice { width: 50px; height: 50px; background-color: #fef08a; border: 2px solid #ca8a04; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; color: var(--deep-red); box-shadow: 3px 3px 5px rgba(0,0,0,0.3); transition: transform 0.5s ease-out, color 0.1s; }
    
    .dice-tray.rolling .dice {
        animation: tumble 1.5s ease-out forwards;
        color: transparent; 
    }

    @keyframes tumble { 0% { transform: scale(0.8) rotateX(0deg) rotateY(0deg) rotateZ(0deg); } 100% { transform: scale(1) rotateX(720deg) rotateY(1080deg) rotateZ(360deg); } }
    .betting-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .bet-spot {
        position: relative;
        border: 3px solid var(--gold);
        border-radius: 10px;
        height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s, filter 0.2s;
        background-size: cover;
        background-position: center;
    }
    .bet-spot:hover:not(.locked) {
        filter: brightness(1.2);
        transform: translateY(-3px);
    }
    .bet-spot.locked { cursor: not-allowed; opacity: 0.7; }
    .bet-symbol { position: absolute; left: 0px; bottom: 0px; }
    .bet-symbol img, .dice img { display: block; object-fit: contain; }
    .bet-symbol img { width: 50px; height: 50px; }
    .dice img { width: 40px; height: 40px; }
    .bet-amount { position: absolute; top: -10px; right: -10px; background-color: var(--deep-red); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px black; transform: scale(0); transition: transform 0.2s ease-out; }
    .bet-amount.visible { transform: scale(1); }
    .controls { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .chip-selector { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .chip { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #ccc; font-size: 1rem; font-weight: bold; cursor: pointer; background-color: #f8fafc; color: #334155; box-shadow: 0 4px #94a3b8; transition: all 0.1s ease-in-out; }
    .chip:active { transform: translateY(2px); box-shadow: 0 2px #94a3b8; }
    .chip.active { border-color: var(--gold); transform: scale(1.1); box-shadow: 0 4px var(--gold); }
    .clear-btn { background-color: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
    .clear-btn:disabled { background-color: #999; cursor: not-allowed; }

    /* ==================== FORM & UI STYLES ==================== */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: var(--gold); }
    .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--gold); background-color: var(--light-gold); color: var(--dark-gray); box-sizing: border-box; }
    .btn { display: block; width: 100%; padding: 12px; border: none; border-radius: 25px; background-color: var(--gold); color: var(--deep-red); font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; text-align: center; }
    .btn:hover { background-color: #e6c300; }
    .link-text { text-align: center; margin-top: 15px; }
    .link-text a { color: var(--gold); text-decoration: none; font-weight: bold; }
    
    .wallet-info { background-color: green ; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid var(--gold); }
    .wallet-balance-display { font-size: 0.8rem; color: var(--gold); font-weight: bold; margin: 0; }
    .wallet-label { font-size: 1rem; color: #eee; }
    .wallet-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }

    .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .data-table th, .data-table td { padding: 8px; border: 1px solid var(--gold); text-align: left; font-size: 0.7rem; }
    .data-table th { background-color: var(--deep-red); }
    .data-table td { word-break: break-all; }
    .action-btn { padding: 5px 8px; font-size: 0.8rem; margin: 2px; border-radius: 5px; width: auto; display: inline-block; }
    .approve-btn, .topup-action-btn { background-color: #22c55e; color: white; }
    .reject-btn, .delete-btn { background-color: #ef4444; color: white; }
    .ban-btn { background-color: #f97316; color: white;}
    .unban-btn, .details-btn { background-color: #3b82f6; color: white;}
    
    .audio-control-container { display: flex; justify-content: space-between; align-items: center; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
    input:checked + .slider { background-color: #22c55e; }
    input:focus + .slider { box-shadow: 0 0 1px #22c55e; }
    input:checked + .slider:before { transform: translateX(22px); }
    .slider.round { border-radius: 28px; }
    .slider.round:before { border-radius: 50%; }

    /* ==================== BOTTOM NAV BAR ==================== */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.8); border-top: 2px solid var(--gold); display: flex; justify-content: space-around; padding: 5px 0; box-shadow: 0 -5px 15px rgba(255, 215, 0, 0.2); z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: #ccc; text-decoration: none; padding: 5px 10px; font-size: 0.8rem; transition: color 0.2s; }
    .nav-item i { font-size: 1.5rem; margin-bottom: 3px; }
    .nav-item.active, .nav-item:hover { color: var(--gold); }

    /* ==================== MODAL STYLES (UPDATED) ==================== */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { background: var(--dark-red); color: white; padding: 20px; border-radius: 10px; border: 2px solid var(--gold); text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slide-in 0.3s ease-out; max-width: 95%; width: 500px; }
    .modal-content.large { width: 90%; max-width: 800px; } /* For user details */
    .modal-body { max-height: 70vh; overflow-y: auto; text-align: left; padding: 10px;}
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 15px; }
    .modal-header .page-title { border-bottom: none; padding-bottom: 0; font-size: 1.2rem; text-align: left;}
    .modal-close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

    @keyframes slide-in { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .result-icon-container { margin-bottom: 15px; }
    .result-icon { width: 80px; height: 80px; display: none; margin: 0 auto; }
    .modal-content.result-win .win-icon { display: block; color: var(--gold); }
    .modal-content.result-loss .loss-icon { display: block; color: #ef4444; }
    #modal-title { margin-top: 0; font-family: 'Cinzel Decorative', cursive; }
    #modal-text { font-size: 1.1rem; line-height: 1.5; }

    #payment-qr-code { max-width: 200px; margin: 15px auto; }
    #payment-details p { margin: 5px 0; font-weight: bold; }

    /* ==================== LOGIN LOADING & SUCCESS ANIMATION ==================== */
    .animation-container { text-align: center; color: white; transform: scale(0.7); opacity: 0; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s; }
    .modal-overlay.visible .animation-container { transform: scale(1); opacity: 1; }
    .animation-title { font-family: 'Cinzel Decorative', cursive; margin: 15px 0 5px; font-size: 1.8rem; color: var(--gold); text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
    .animation-text { margin: 0; font-size: 0.9rem; opacity: 0.8; }
    .login-animation { position: relative; width: 80px; height: 80px; margin: 0 auto 20px; }
    .loader { width: 80px; height: 80px; border: 5px solid rgba(255, 255, 255, 0.3); border-top-color: #ffffff; border-radius: 50%; animation: spin 1s linear infinite; transition: opacity 0.3s, transform 0.3s; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .checkmark { width: 80px; height: 80px; border-radius: 50%; display: block; stroke-width: 4; stroke: #fff; stroke-miterlimit: 10; position: absolute; top: 0; left: 0; opacity: 0; transform: scale(0.8); transition: opacity 0.3s 0.2s, transform 0.4s 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 4; stroke-miterlimit: 10; stroke: #fff; fill: none; }
    .animation-container.success .checkmark__circle { animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
    .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; }
    .animation-container.success .checkmark__check { animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    .animation-container.success .loader { opacity: 0; transform: scale(0); }
    .animation-container.success .checkmark { opacity: 1; transform: scale(1); }
</style>
</head>
<body>
    <!-- Audio element for the game countdown sound -->
    <audio id="game-audio" loop src="https://raw.githubusercontent.com/Anandkhuman/housie/main/lagao.mp3" preload="auto"></audio>
    <!-- ============================================== -->
    <!-- ============== PAGE CONTAINERS =============== -->
    <!-- ============================================== -->

<!-- PAGE: GAME -->
<main id="page-game" class="page">
    <div id="game-container" class="content-container">
        <header class="game-header">
            <h1 class="game-title">SINTHA LAGAO</h1>
            <div class="wallet">
                <span>Balance:</span>
                <span id="wallet-balance">₹0</span>
            </div>
        </header>
        <div class="game-state">
            <div class="period-info">Period: <span id="period-id-display">--</span></div>
            <div id="timer" class="timer-display">--</div>
            <div id="status-message" class="status-message">Connecting...</div>
        </div>
        <div id="dice-tray" class="dice-tray">
            <div class="dice">?</div><div class="dice">?</div><div class="dice">?</div>
            <div class="dice">?</div><div class="dice">?</div><div class="dice">?</div>
        </div>
        <div id="betting-grid" class="betting-grid"></div>
        <footer class="controls">
            <div class="chip-selector">
                <button class="chip" data-value="10">10</button>
                <button class="chip" data-value="20">20</button>
                <button class="chip" data-value="50">50</button>
                <button class="chip active" data-value="100">100</button>
                <button class="chip" data-value="200">200</button>
            </div>
            <button id="clear-bets-btn" class="clear-btn">Clear Bets</button>
        </footer>
    </div>
    
    <!-- NEW: Admin Real-Time Betting Status -->
    <div id="admin-betting-status-container" class="content-container" style="display: none; margin-top: 20px;">
        <h1 class="page-title">Live Betting Status</h1>
        
        <h3 style="color: var(--gold);">Dice Wise Totals</h3>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>Dice</th><th>Total Bet Amount</th></tr>
                </thead>
                <tbody id="admin-dice-totals">
                    <!-- Data will be injected here -->
                </tbody>
            </table>
        </div>

        <hr style="border-color: var(--gold); opacity: 0.5;">

        <h3 style="color: var(--gold);">User Wise Bets</h3>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>User</th><th>Total Bet Amount</th></tr>
                </thead>
                <tbody id="admin-user-totals">
                    <!-- Data will be injected here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- PAGE: WALLET -->
<main id="page-wallet" class="page">
    <div class="content-container">
        <h1 class="page-title">My Wallet</h1>
        <div class="wallet-info">
            <p class="wallet-label">Available Balance</p>
            <h2 id="wallet-balance-display" class="wallet-balance-display">₹0</h2>
        </div>
        <div id="topup-section">
             <h3 style="text-align: center; color: var(--gold);">Top-up</h3>
             <div class="form-group">
                <label for="topup-amount">Enter Amount (₹)</label>
                <input type="number" id="topup-amount" placeholder="e.g., 500">
            </div>
            <button id="topup-btn" class="btn">Add Funds</button>
        </div>
        <hr style="border-color: var(--gold); opacity: 0.5;">
        <div id="withdrawal-section">
            <h3 style="text-align: center; color: var(--gold);">Withdraw</h3>
            <div class="form-group">
                <label for="withdrawal-amount">Enter Amount (₹)</label>
                <input type="number" id="withdrawal-amount" placeholder="e.g., 200">
            </div>
            <p style="text-align:center; font-size:0.9rem; margin: -5px 0 10px;">Withdrawal Fee: ₹1 per ₹10. Min withdrawal ₹10.</p>
            <button id="withdrawal-btn" class="btn">Request Withdrawal</button>
        </div>
    </div>
</main>

<!-- PAGE: HISTORY (UPDATED) -->
<main id="page-history" class="page">
    <div class="content-container">
        <h1 class="page-title">History</h1>

        <h3 style="color: var(--gold);">Transaction History</h3>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr>
                </thead>
                <tbody id="transaction-history-list">
                    <!-- Transaction items will be injected here -->
                </tbody>
            </table>
        </div>
    
        <hr style="border-color: var(--gold); opacity: 0.5; margin: 20px 0;">
    
        <h3 style="color: var(--gold);">Betting History</h3>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>Period</th><th>My Bets</th><th>Result</th><th>Outcome</th></tr>
                </thead>
                <tbody id="betting-history-list">
                    <!-- Betting history will be injected here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- PAGE: PROFILE / SETTINGS -->
<main id="page-profile" class="page">
     <div class="content-container">
        <h1 class="page-title">Profile Settings</h1>
        <form id="profile-form">
            <div class="form-group">
                <label for="profile-name">Name</label>
                <input type="text" id="profile-name" required>
            </div>
             <div class="form-group">
                <label for="profile-phone">Phone</label>
                <input type="tel" id="profile-phone" required>
            </div>
            <div class="form-group">
                <label for="profile-email">Email</label>
                <input type="email" id="profile-email" readonly>
            </div>
            <div class="form-group">
                <label for="profile-upi">UPI ID</label>
                <input type="text" id="profile-upi" placeholder="yourname@upi" required>
            </div>
             <div class="form-group">
                <label for="profile-password">New Password (optional)</label>
                <input type="password" id="profile-password" placeholder="Leave blank to keep current">
            </div>
            <button type="submit" class="btn">Update Profile</button>
        </form>
    </div>
</main>

<!-- PAGE: LOGIN -->
<main id="page-login" class="page">
    <div class="content-container">
        <h1 class="page-title">Login</h1>
        <form id="login-form">
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit" class="btn">Login</button>
        </form>
        <p class="link-text" style="margin-bottom: -5px;"><a href="#" id="goto-forgot-password">Forgot Password?</a></p>
        <p class="link-text">Don't have an account? <a href="#" id="goto-register">Register here</a></p>
    </div>
</main>

<!-- PAGE: REGISTER -->
<main id="page-register" class="page">
     <div class="content-container">
        <h1 class="page-title">Create Account</h1>
        <form id="register-form">
            <div class="form-group">
                <label for="register-name">Full Name</label>
                <input type="text" id="register-name" required>
            </div>
            <div class="form-group">
                <label for="register-email">Email</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Password</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="register-upi">UPI ID (for withdrawals)</label>
                <input type="text" id="register-upi" placeholder="yourname@upi" required>
            </div>
            <div class="form-group">
                <label for="register-role">Account Type</label>
                <select id="register-role">
                    <option value="user">User</option>
                </select>
            </div>
            <button type="submit" class="btn">Register</button>
        </form>
        <p class="link-text">Already have an account? <a href="#" id="goto-login">Login here</a></p>
    </div>
</main>

<!-- PAGE: FORGOT PASSWORD -->
<main id="page-forgot-password" class="page">
    <div class="content-container">
        <h1 class="page-title">Reset Password</h1>
        <p style="text-align:center; font-size: 0.9rem; margin-top: -10px; margin-bottom: 20px;">Enter your email address and we will send you a link to reset your password.</p>
        <form id="forgot-password-form">
            <div class="form-group">
                <label for="forgot-password-email">Email</label>
                <input type="email" id="forgot-password-email" placeholder="Enter your registered email" required>
            </div>
            <button type="submit" class="btn">Send Reset Link</button>
        </form>
        <p class="link-text">Remember your password? <a href="#" id="goto-login-from-forgot">Login here</a></p>
    </div>
</main>

<!-- PAGE: ADMIN DASHBOARD -->
<main id="page-admin" class="page">
    <div class="content-container">
        <h1 class="page-title">Admin Dashboard</h1>
        <h3 style="color: var(--gold);">Pending Top-up Requests</h3>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>User</th><th>Amount</th><th>Tnx ID</th><th>Actions</th></tr>
                </thead>
                <tbody id="admin-topup-list"></tbody>
            </table>
        </div>
        <hr style="border-color: var(--gold); opacity: 0.5;">
        <h3 style="color: var(--gold);">Pending Withdrawal Requests</h3>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>User</th><th>Amount</th><th>UPI ID</th><th>Actions</th></tr>
                </thead>
                <tbody id="admin-withdrawal-list"></tbody>
            </table>
        </div>
        <hr style="border-color: var(--gold); opacity: 0.5;">
        <h3 style="color: var(--gold);">Payment Settings</h3>
        <form id="payment-settings-form">
            <div class="form-group">
                <label for="admin-upi-id">Receiving UPI ID</label>
                <input type="text" id="admin-upi-id" placeholder="your-upi@oksbi" required>
            </div>
            <button type="submit" class="btn">Update UPI</button>
        </form>
        <hr style="border-color: var(--gold); opacity: 0.5;">
        <h3 style="color: var(--gold);">Audio Settings</h3>
        <div class="audio-control-container">
            <span>Background Music</span>
            <label class="toggle-switch">
                <input type="checkbox" id="music-toggle-checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
</main>

<!-- PAGE: ADMIN USER MANAGEMENT -->
<main id="page-users" class="page">
    <div class="content-container" style="max-width: 90%;">
        <h1 class="page-title">User Management</h1>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr><th>User</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="admin-user-list"></tbody>
            </table>
        </div>
    </div>
</main>

<!-- ============================================== -->
<!-- ============== MODAL POPUPS ================== -->
<!-- ============================================== -->

<!-- Result Modal Popup -->
<div id="result-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="result-icon-container">
            <svg class="result-icon win-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.7.27a.75.75 0 00-1.4 0L8.43 5.92a.75.75 0 01-.56.41l-6.23.9a.75.75 0 00-.42 1.28l4.5 4.39a.75.75 0 01.22.66l-1.07 6.2a.75.75 0 001.09.79l5.57-2.93a.75.75 0 01.7 0l5.57 2.93a.75.75 0 001.09-.79l-1.07-6.2a.75.75 0 01.22-.66l4.5-4.39a.75.75 0 00-.42-1.28l-6.23-.9a.75.75 0 01-.56-.41L12.7.27z"></path></svg>
            <svg class="result-icon loss-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-2.625 6c-.54 0-.975.435-.975.975s.435.975.975.975.975-.435.975-.975S9.915 8.25 9.375 8.25zm5.25 0c-.54 0-.975.435-.975.975s.435.975.975.975.975-.435.975-.975-.435-.975-.975-.975zM12 18a6.75 6.75 0 006-3.75H6A6.75 6.75 0 0012 18z" clip-rule="evenodd"></path></svg>
        </div>
        <h2 id="modal-title"></h2>
        <p id="modal-text"></p>
    </div>
</div>

<!-- Payment Modal Popup -->
<div id="payment-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="page-title">Complete Your Top-up</h2>
        <p>Scan the QR code or use the UPI ID below to pay.</p>
        <img id="payment-qr-code" src="" alt="QR Code Loading...">
        <div id="payment-details">
            <p>Amount: <span id="payment-modal-amount"></span></p>
            <p>UPI ID: <span id="payment-upi-display">Loading...</span></p>
        </div>
        <form id="payment-form">
            <div class="form-group">
                <label for="transaction-id">Enter Transaction ID</label>
                <input type="text" id="transaction-id" required placeholder="12-digit UPI reference number">
            </div>
            <button type="submit" class="btn">Submit Request</button>
            <button type="button" id="payment-cancel-btn" class="btn" style="background-color:#999; margin-top:10px;">Cancel</button>
        </form>
    </div>
</div>

<!-- Admin Top-up Modal -->
<div id="admin-topup-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="page-title">Top-up User</h2>
        <p>Add funds directly to <strong id="admin-topup-username"></strong>'s account.</p>
        <form id="admin-topup-form">
            <input type="hidden" id="admin-topup-userid">
            <div class="form-group">
                <label for="admin-topup-amount">Amount (₹)</label>
                <input type="number" id="admin-topup-amount" required placeholder="e.g., 500">
            </div>
            <button type="submit" class="btn">Confirm Top-up</button>
            <button type="button" id="admin-topup-cancel-btn" class="btn" style="background-color:#999; margin-top:10px;">Cancel</button>
        </form>
    </div>
</div>

<!-- NEW: Admin User Details Modal -->
<div id="admin-user-details-modal" class="modal-overlay">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 id="user-details-modal-title" class="page-title" style="margin-bottom: 0;">User Details</h2>
            <button id="user-details-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <h3 style="color: var(--gold);">Transaction History</h3>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr>
                    </thead>
                    <tbody id="user-details-transactions"></tbody>
                </table>
            </div>
            <hr style="border-color: var(--gold); opacity: 0.5; margin: 20px 0;">
            <h3 style="color: var(--gold);">Betting History</h3>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr><th>Period</th><th>Bets</th><th>Result</th><th>Outcome</th></tr>
                    </thead>
                    <tbody id="user-details-bets"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Login Animation Modal -->
<div id="login-success-ticket" class="modal-overlay">
    <div class="animation-container">
        <div class="login-animation">
            <div class="loader"></div>
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h2 class="animation-title">Authenticating...</h2>
        <p class="animation-text">Please wait.</p>
    </div>
</div>

<!-- ============================================== -->
<!-- ============== BOTTOM NAV BAR ================ -->
<!-- ============================================== -->

<nav class="bottom-nav">
    <a href="#game" class="nav-item user-nav" data-page="game"><i class="fas fa-dice"></i> Game</a>
    <a href="#wallet" class="nav-item user-nav" data-page="wallet"><i class="fas fa-wallet"></i> Wallet</a>
    <a href="#history" class="nav-item user-nav" data-page="history"><i class="fas fa-history"></i> History</a>
    <a href="#profile" class="nav-item user-nav" data-page="profile"><i class="fas fa-user-cog"></i> Profile</a>
    <a href="#admin" class="nav-item admin-nav" data-page="admin"><i class="fas fa-user-shield"></i> Admin</a>
    <a href="#users" class="nav-item admin-nav" data-page="users"><i class="fas fa-users-cog"></i> Users</a>
    <a href="#login" class="nav-item" id="auth-link" data-page="login"><i class="fas fa-sign-in-alt"></i> Login</a>
</nav>

<!-- JS Library for confetti effect -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ================== FIREBASE CONFIGURATION ==================
    const firebaseConfig = {
        apiKey: "AIzaSyAjvI_Vl4trHwZAosaGLdEYQ87jJHeGYwc",
        authDomain: "studio-ahutj.firebaseapp.com",
        databaseURL: "https://studio-ahutj-default-rtdb.firebaseio.com",
        projectId: "studio-ahutj",
        storageBucket: "studio-ahutj.firebasestorage.app",
        messagingSenderId: "636752463109",
        appId: "1:636752463109:web:da78d4100720a39a20a36c"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const gameStateRef = db.ref('gameState'); 

    // ==================== GLOBAL STATE & CONFIG ====================
    const AppState = {
        currentUser: null, 
        currentUserAuth: null, 
        paymentSettings: { upiId: 'default-upi@provider' },
        audioSettings: { enabled: true }
    };
    
    db.ref('settings/paymentDetails').on('value', snapshot => {
        const settings = snapshot.val();
        if (settings && settings.upiId) {
            AppState.paymentSettings = settings;
        }
        const upiId = AppState.paymentSettings.upiId;
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=${upiId}`;
        
        const qrCodeImg = document.getElementById('payment-qr-code');
        if (qrCodeImg) qrCodeImg.src = qrCodeUrl;

        const upiDisplay = document.getElementById('payment-upi-display');
        if (upiDisplay) upiDisplay.textContent = upiId;
    });

    db.ref('settings/audio').on('value', snapshot => {
        const settings = snapshot.val();
        if (settings) {
            AppState.audioSettings = settings;
        }
        updateMusicSwitchUI();
    });
    
    let serverTimeOffset = 0;
    db.ref('.info/serverTimeOffset').on('value', snap => {
        serverTimeOffset = snap.val();
    });
    const estimatedServerTime = () => Date.now() + serverTimeOffset;

    const GAME_CONFIG = {
        SYMBOLS: [
            { id: 'club',    image: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/1.png', background: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/1bg.jpg' },
            { id: 'face',    image: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/2.png', background: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/2bg.jpg' },
            { id: 'spade',   image: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/3.png', background: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/3bg.jpg' },
            { id: 'diamond', image: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/4.png', background: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/4bg.jpg' },
            { id: 'flag',    image: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/5.png', background: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/5bg.jpg' },
            { id: 'heart',   image: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/6.png', background: 'https://raw.githubusercontent.com/Anandkhuman/housie/main/6bg.jpg' }
        ],
        BETTING_DURATION: 35,
        RESULT_VIEW_DURATION: 3,
        BETTING_LOCKED_TIME: 5,
        ANIMATION_DURATION: 1500
    };

    let gameState = {
        currentBets: {}, selectedChipValue: 100, serverState: null,
        lastProcessedPeriodId: null, isGameInitialized: false, uiUpdateInterval: null,
        isBettingLocked: false, hasCommittedBets: false, isTransitioning: false,
        currentBetListener: null
    };

    // ==================== DOM ELEMENT REFERENCES ====================
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const authLink = document.getElementById('auth-link');
    const userNavItems = document.querySelectorAll('.user-nav');
    const adminNavItems = document.querySelectorAll('.admin-nav');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const periodIdDisplayEl = document.getElementById('period-id-display');
    const timerEl = document.getElementById('timer');
    const statusMessageEl = document.getElementById('status-message');
    const diceTrayEl = document.getElementById('dice-tray');
    const bettingGridEl = document.getElementById('betting-grid');
    const chipSelectorEl = document.querySelector('.chip-selector');
    const clearBetsBtn = document.getElementById('clear-bets-btn');
    const gameDiceEls = () => diceTrayEl.querySelectorAll('.dice');
    const resultModalEl = document.getElementById('result-modal');
    const resultModalContentEl = resultModalEl.querySelector('.modal-content');
    const resultModalTitleEl = document.getElementById('modal-title');
    const resultModalTextEl = document.getElementById('modal-text');
    const walletBalanceDisplay = document.getElementById('wallet-balance-display');
    const topupAmountInput = document.getElementById('topup-amount');
    const withdrawalAmountInput = document.getElementById('withdrawal-amount');
    const profileForm = document.getElementById('profile-form');
    const profileNameInput = document.getElementById('profile-name');
    const profilePhoneInput = document.getElementById('profile-phone');
    const profileEmailInput = document.getElementById('profile-email');
    const profileUpiInput = document.getElementById('profile-upi');
    const profilePasswordInput = document.getElementById('profile-password');
    const adminTopupList = document.getElementById('admin-topup-list');
    const adminWithdrawalList = document.getElementById('admin-withdrawal-list');
    const adminUserList = document.getElementById('admin-user-list');
    const paymentModal = document.getElementById('payment-modal');
    const paymentModalAmount = document.getElementById('payment-modal-amount');
    const transactionIdInput = document.getElementById('transaction-id');
    const adminTopupModal = document.getElementById('admin-topup-modal');
    const adminTopupForm = document.getElementById('admin-topup-form');
    const loginSuccessTicket = document.getElementById('login-success-ticket');
    const withdrawalSection = document.getElementById('withdrawal-section'); 
    const gameAudio = document.getElementById('game-audio');
    const adminBettingStatusContainer = document.getElementById('admin-betting-status-container');
    const userDetailsModal = document.getElementById('admin-user-details-modal');

    // ==================== PAGE NAVIGATION & UI UPDATES ====================
    const showPage = (pageId) => {
        pages.forEach(page => page.classList.remove('active'));
        const pageToShow = document.getElementById(`page-${pageId}`);
        if (pageToShow) pageToShow.classList.add('active');

        navItems.forEach(item => {
            item.classList.toggle('active', item.dataset.page === pageId);
        });
        
        if (pageId === 'game' && AppState.currentUser) {
            if (!gameState.isGameInitialized) {
                initializeGame();
            }
        }
    };
    const updateUI = () => {
        const isAdmin = AppState.currentUser && AppState.currentUser.role === 'admin';
        
        if (AppState.currentUser) {
            authLink.innerHTML = `<i class="fas fa-sign-out-alt"></i> Logout`;
            authLink.dataset.page = 'logout';
            userNavItems.forEach(item => item.style.display = 'flex');
            adminNavItems.forEach(item => {
                item.style.display = isAdmin ? 'flex' : 'none';
            });

            if (isAdmin) {
                const walletNavItem = document.querySelector('.nav-item[data-page="wallet"]');
                if (walletNavItem) walletNavItem.style.display = 'none';
                adminBettingStatusContainer.style.display = 'block';
            } else {
                 adminBettingStatusContainer.style.display = 'none';
            }
            
            if (withdrawalSection) {
                withdrawalSection.style.display = isAdmin ? 'none' : 'block';
            }

            const balance = AppState.currentUser.balance || 0;
            const balanceText = `₹${balance.toLocaleString()}`;
            walletBalanceEl.textContent = balanceText;
            walletBalanceDisplay.textContent = balanceText;

        } else {
            authLink.innerHTML = `<i class="fas fa-sign-in-alt"></i> Login`;
            authLink.dataset.page = 'login';
            userNavItems.forEach(item => item.style.display = 'none');
            adminNavItems.forEach(item => item.style.display = 'none');
            if (withdrawalSection) withdrawalSection.style.display = 'block'; 
            adminBettingStatusContainer.style.display = 'none';
            showPage('login');
        }
    };
    const renderProfilePage = () => {
        const user = AppState.currentUser;
        if (!user) return;
        profileNameInput.value = user.name || '';
        profilePhoneInput.value = user.phone || '';
        profileEmailInput.value = user.email || '';
        profileUpiInput.value = user.upi || '';
        profilePasswordInput.value = '';
    };

    const updateMusicSwitchUI = () => {
        const musicToggleCheckbox = document.getElementById('music-toggle-checkbox');
        if (!musicToggleCheckbox) return;
        musicToggleCheckbox.checked = AppState.audioSettings.enabled;
    };


    // ==================== AUTH, PROFILE, WALLET, ADMIN ====================
    auth.onAuthStateChanged(user => {
        if (user) {
            AppState.currentUserAuth = user;
            db.ref('users/' + user.uid).on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    AppState.currentUser = { uid: user.uid, ...userData };
                    updateUI();
                    if (!document.querySelector('.page.active') || document.getElementById('page-login').classList.contains('active')) {
                       showPage(AppState.currentUser.role === 'admin' ? 'admin' : 'game');
                    }
                } else {
                    auth.signOut();
                }
            });
        } else {
            if(AppState.currentUserAuth) db.ref('users/' + AppState.currentUserAuth.uid).off();
            AppState.currentUser = null;
            AppState.currentUserAuth = null;
            updateUI();
        }
    });
    
    const handleLogin = (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        const animationModal = document.getElementById('login-success-ticket');
        const animationContainer = animationModal.querySelector('.animation-container');
        const animationTitle = animationModal.querySelector('.animation-title');
        const animationText = animationModal.querySelector('.animation-text');

        animationContainer.classList.remove('success');
        animationTitle.textContent = 'Authenticating...';
        animationText.textContent = 'Please wait.';
        animationModal.classList.add('visible');

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                db.ref('users/' + userCredential.user.uid).get().then(snapshot => {
                    const userData = snapshot.val();
                    if (userData && userData.isBanned) {
                        alert('Your account has been suspended. Please contact support.');
                        auth.signOut();
                        animationModal.classList.remove('visible');
                    } else {
                       document.getElementById('login-form').reset();
                       
                       setTimeout(() => {
                           animationContainer.classList.add('success');
                           animationTitle.textContent = 'Login Successful';
                           animationText.textContent = 'Welcome back! Preparing the game...';
                       }, 1000);

                       setTimeout(() => {
                           animationModal.classList.remove('visible');
                           setTimeout(() => {
                               animationContainer.classList.remove('success');
                           }, 500);
                           showPage(userData.role === 'admin' ? 'admin' : 'game');
                       }, 3500);
                    }
                });
            })
            .catch(error => {
                alert(error.message);
                animationModal.classList.remove('visible');
            });
    };

    const handleRegister = (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const role = document.getElementById('register-role').value;
        const upi = document.getElementById('register-upi').value;
        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                db.ref('users/' + user.uid).set({
                    name: name, email: email, role: role, balance: 1000, 
                    phone: '', upi: upi, isBanned: false,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    alert('Registration successful! Please log in.');
                    document.getElementById('register-form').reset();
                    showPage('login');
                });
            })
            .catch(error => alert(error.message));
    };
    const handleLogout = () => auth.signOut().catch(error => alert(error.message));
    const handleForgotPassword = (e) => {
        e.preventDefault();
        const email = document.getElementById('forgot-password-email').value;
        auth.sendPasswordResetEmail(email)
            .then(() => {
                alert('Password reset email sent! Please check your inbox.');
                document.getElementById('forgot-password-form').reset();
                showPage('login');
            })
            .catch(error => alert(`Error: ${error.message}`));
    };
    const handleProfileUpdate = (e) => {
        e.preventDefault();
        if(!AppState.currentUser) return;
        const updates = {
            name: profileNameInput.value,
            phone: profilePhoneInput.value,
            upi: profileUpiInput.value,
        };
        db.ref('users/' + AppState.currentUser.uid).update(updates)
            .then(() => {
                alert('Profile updated successfully!');
                const newPassword = profilePasswordInput.value;
                if(newPassword) {
                    AppState.currentUserAuth.updatePassword(newPassword)
                        .then(() => alert('Password updated successfully!'))
                        .catch(error => alert(`Password update failed: ${error.message}`));
                }
            })
            .catch(error => alert(`Profile update failed: ${error.message}`));
    };

    const handleTopupSubmit = (e) => {
        e.preventDefault();
        const amount = parseInt(paymentModalAmount.textContent.replace('₹', ''), 10);
        const transactionId = transactionIdInput.value;
        if (!transactionId) {
            alert('Please enter the transaction ID.');
            return;
        }

        const userId = AppState.currentUser.uid;
        const newRequestKey = db.ref('topupRequests').push().key;

        const newRequestData = {
            userId: userId,
            userEmail: AppState.currentUser.email,
            amount: amount,
            transactionId: transactionId,
            status: 'pending',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        const updates = {};
        updates[`/topupRequests/${newRequestKey}`] = newRequestData;
        updates[`/userTransactions/${userId}/all/${newRequestKey}`] = { ...newRequestData, type: 'Top-up' };

        db.ref().update(updates)
            .then(() => {
                paymentModal.classList.remove('visible');
                document.getElementById('payment-form').reset();
                topupAmountInput.value = '';
                alert('Top-up request submitted! It will be reviewed by an admin.');
            }).catch(err => alert(err.message));
    };

    const handleWithdrawalRequest = () => {
        const amount = parseInt(withdrawalAmountInput.value, 10);
        if (isNaN(amount) || amount < 10) {
            alert('Minimum withdrawal amount is ₹10.');
            return;
        }
        if (!AppState.currentUser.upi) {
            alert('Please update your UPI ID in your profile before making a withdrawal request.');
            showPage('profile');
            return;
        }
        const fee = Math.floor(amount / 10);
        const totalDeduction = amount + fee;
        const userId = AppState.currentUser.uid;
        const userBalanceRef = db.ref('users/' + userId + '/balance');

        userBalanceRef.transaction(currentBalance => {
            if (currentBalance >= totalDeduction) {
                return currentBalance - totalDeduction;
            }
            return; 
        }, (error, committed, snapshot) => {
            if (error) {
                alert('Withdrawal failed. Please try again.');
            } else if (committed) {
                const newRequestKey = db.ref('withdrawalRequests').push().key;
                
                const newRequestData = {
                    userId: userId,
                    userEmail: AppState.currentUser.email,
                    amount: amount,
                    fee: fee,
                    upi: AppState.currentUser.upi,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                const updates = {};
                updates[`/withdrawalRequests/${newRequestKey}`] = newRequestData;
                updates[`/userTransactions/${userId}/all/${newRequestKey}`] = { ...newRequestData, type: 'Withdrawal' };

                db.ref().update(updates)
                    .then(() => {
                         withdrawalAmountInput.value = '';
                         alert(`Withdrawal request for ₹${amount} submitted! Your balance has been updated.`);
                    });

            } else {
                alert(`Insufficient balance. You need ₹${totalDeduction} (including fee) to withdraw ₹${amount}.`);
            }
        });
    };
    
    const handleTopupRequest = () => {
        const amount = parseInt(topupAmountInput.value, 10);
        if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid amount.');
            return;
        }
        paymentModalAmount.textContent = `₹${amount}`;
        paymentModal.classList.add('visible');
    };

    const renderAdminDashboard = () => {
        db.ref('topupRequests').orderByChild('status').equalTo('pending').on('value', snapshot => {
            adminTopupList.innerHTML = '';
            if(snapshot.exists()){
                snapshot.forEach(childSnapshot => {
                    const req = childSnapshot.val();
                    const reqId = childSnapshot.key;
                    adminTopupList.innerHTML += `<tr><td>${req.userEmail.split('@')[0]}</td><td>₹${req.amount}</td><td>${req.transactionId}</td><td><button class="btn action-btn approve-btn" onclick="app.approveRequest('topup', '${reqId}')">Approve</button><button class="btn action-btn reject-btn" onclick="app.rejectRequest('topup', '${reqId}')">Reject</button></td></tr>`;
                });
            } else {
                adminTopupList.innerHTML = '<tr><td colspan="4">No pending requests.</td></tr>';
            }
        });
        db.ref('withdrawalRequests').orderByChild('status').equalTo('pending').on('value', snapshot => {
            adminWithdrawalList.innerHTML = '';
            if(snapshot.exists()){
                snapshot.forEach(childSnapshot => {
                    const req = childSnapshot.val();
                    const reqId = childSnapshot.key;
                    adminWithdrawalList.innerHTML += `<tr><td>${req.userEmail.split('@')[0]}</td><td>₹${req.amount} (Fee: ₹${req.fee})</td><td>${req.upi}</td><td><button class="btn action-btn approve-btn" onclick="app.approveRequest('withdrawal', '${reqId}')">Approve</button><button class="btn action-btn reject-btn" onclick="app.rejectRequest('withdrawal', '${reqId}')">Reject</button></td></tr>`;
                });
            } else {
                adminWithdrawalList.innerHTML = '<tr><td colspan="4">No pending requests.</td></tr>';
            }
        });
        const adminUpiInput = document.getElementById('admin-upi-id');
        if (adminUpiInput && AppState.paymentSettings) {
            adminUpiInput.value = AppState.paymentSettings.upiId;
        }
    };

    const renderUserManagementPage = () => {
         db.ref('users').on('value', snapshot => {
            adminUserList.innerHTML = '';
            if(snapshot.exists()){
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const userId = childSnapshot.key;
                    if(userId === AppState.currentUser.uid) return;
                    const status = user.isBanned ? '<span style="color:#ef4444; font-weight:bold;">Banned</span>' : '<span style="color:#22c55e; font-weight:bold;">Active</span>';
                    const banBtn = user.isBanned ? `<button class="btn action-btn unban-btn" onclick="app.toggleUserBan('${userId}', false)">Unban</button>` : `<button class="btn action-btn ban-btn" onclick="app.toggleUserBan('${userId}', true)">Ban</button>`;
                    adminUserList.innerHTML += `<tr><td>${user.name}<br><small>${user.email}</small></td><td>₹${(user.balance || 0).toLocaleString()}</td><td>${status}</td><td>${banBtn}<button class="btn action-btn topup-action-btn" onclick="app.openAdminTopupModal('${userId}', '${user.name}')">Top-up</button><button class="btn action-btn details-btn" onclick="app.showUserDetails('${userId}', '${user.name}')">Details</button><button class="btn action-btn delete-btn" onclick="app.deleteUser('${userId}')">Delete</button></td></tr>`;
                });
            } else {
                adminUserList.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
            }
        });
    };
    
    const renderHistoryPage = async () => {
        if (!AppState.currentUser) return;
        
        // Render Transaction History
        const transactionHistoryListEl = document.getElementById('transaction-history-list');
        transactionHistoryListEl.innerHTML = `<tr><td colspan="4">Loading transactions...</td></tr>`;
        try {
            const userTransactionsRef = db.ref(`userTransactions/${AppState.currentUser.uid}/all`);
            const snapshot = await userTransactionsRef.orderByChild('timestamp').limitToLast(100).get();
            let transactions = [];
            snapshot.forEach(snap => transactions.push(snap.val()));
            transactions.reverse(); // Newest first

            if (transactions.length === 0) {
                transactionHistoryListEl.innerHTML = `<tr><td colspan="4">No transactions found.</td></tr>`;
            } else {
                let html = '';
                transactions.forEach(tx => {
                    const date = new Date(tx.timestamp).toLocaleString();
                    const statusClass = tx.status === 'approved' ? 'approve-btn' : (tx.status === 'rejected' ? 'reject-btn' : '');
                    const statusText = tx.status.charAt(0).toUpperCase() + tx.status.slice(1);
                    html += `<tr><td>${date}</td><td>${tx.type}</td><td>₹${(tx.amount || 0).toLocaleString()}</td><td><span class="action-btn ${statusClass}" style="cursor:default;border:none;">${statusText}</span></td></tr>`;
                });
                transactionHistoryListEl.innerHTML = html;
            }
        } catch (error) {
            console.error("Error fetching transaction history:", error);
            transactionHistoryListEl.innerHTML = `<tr><td colspan="4">Error loading history.</td></tr>`;
        }

        // Render Betting History
        const bettingHistoryListEl = document.getElementById('betting-history-list');
        bettingHistoryListEl.innerHTML = `<tr><td colspan="4">Loading betting history...</td></tr>`;
        try {
            const userBetsRef = db.ref(`userBets/${AppState.currentUser.uid}`);
            const snapshot = await userBetsRef.orderByKey().limitToLast(100).get();
            let bets = [];
            snapshot.forEach(snap => bets.push({ periodId: snap.key, ...snap.val() }));
            bets.reverse(); // Newest first

            if (bets.length === 0) {
                bettingHistoryListEl.innerHTML = `<tr><td colspan="4">No betting history found.</td></tr>`;
            } else {
                let html = '';
                bets.forEach(bet => {
                    const betsPlaced = Object.entries(bet.bets).map(([symbol, amount]) => `${symbol}: ${amount}`).join('<br>');
                    const resultDice = bet.result ? bet.result.join(', ') : 'Pending';
                    const outcomeText = bet.outcome > 0 ? `<span style="color:#22c55e;">Win: ₹${bet.outcome}</span>` : (bet.outcome < 0 ? `<span style="color:#ef4444;">Loss: ₹${Math.abs(bet.outcome)}</span>` : (bet.result ? 'No Win' : 'Pending'));
                    html += `<tr><td>${bet.periodId}</td><td>${betsPlaced}</td><td>${resultDice}</td><td>${outcomeText}</td></tr>`;
                });
                bettingHistoryListEl.innerHTML = html;
            }
        } catch (error) {
            console.error("Error fetching betting history:", error);
            bettingHistoryListEl.innerHTML = `<tr><td colspan="4">Error loading history.</td></tr>`;
        }
    };

    window.app = {
        approveRequest: (type, reqId) => {
            const requestRef = db.ref(`${type}Requests/${reqId}`);
            requestRef.get().then(snapshot => {
                if (!snapshot.exists()) return;
                const req = snapshot.val();
                const updates = {};
                updates[`/${type}Requests/${reqId}/status`] = 'approved';
                updates[`/userTransactions/${req.userId}/all/${reqId}/status`] = 'approved';

                if(type === 'topup'){
                    const userRef = db.ref(`users/${req.userId}/balance`);
                    userRef.transaction(currentBalance => (currentBalance || 0) + req.amount, (err, comm, snap) => {
                        if (comm) db.ref().update(updates).then(() => alert(`Request approved.`));
                    });
                } else {
                     db.ref().update(updates).then(() => alert(`Request approved.`));
                }
            });
        },
        rejectRequest: (type, reqId) => {
            const requestRef = db.ref(`${type}Requests/${reqId}`);
            requestRef.get().then(snapshot => {
                if (!snapshot.exists()) return;
                const req = snapshot.val();
                const updates = {};
                updates[`/${type}Requests/${reqId}/status`] = 'rejected';
                updates[`/userTransactions/${req.userId}/all/${reqId}/status`] = 'rejected';

                if(type === 'withdrawal') {
                    const userRef = db.ref(`users/${req.userId}/balance`);
                    userRef.transaction(currentBalance => (currentBalance || 0) + req.amount + req.fee, (err, comm, snap) => {
                       if (comm) db.ref().update(updates).then(() => alert(`Request rejected.`));
                    });
                } else {
                     db.ref().update(updates).then(() => alert(`Request rejected.`));
                }
            });
        },
        toggleUserBan: (userId, shouldBeBanned) => {
            db.ref(`users/${userId}`).update({ isBanned: shouldBeBanned });
        },
        deleteUser: (userId) => {
            if(confirm('Are you sure you want to delete this user? This removes their database record permanently but does not delete their auth entry (for security reasons). They will not be able to log in.')) {
                db.ref(`users/${userId}`).remove()
                    .then(() => alert('User data deleted successfully.'))
                    .catch(e => alert(e.message));
            }
        },
        openAdminTopupModal: (userId, userName) => {
            document.getElementById('admin-topup-userid').value = userId;
            document.getElementById('admin-topup-username').textContent = userName;
            adminTopupModal.classList.add('visible');
        },
        showUserDetails: async (userId, userName) => {
            document.getElementById('user-details-modal-title').textContent = `History for ${userName}`;
            const transactionsBody = document.getElementById('user-details-transactions');
            const betsBody = document.getElementById('user-details-bets');

            transactionsBody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;
            betsBody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;
            userDetailsModal.classList.add('visible');

            // Fetch and render transactions
            try {
                const txSnap = await db.ref(`userTransactions/${userId}/all`).orderByChild('timestamp').limitToLast(100).get();
                let transactions = [];
                txSnap.forEach(s => transactions.push(s.val()));
                transactions.reverse();
                if (transactions.length > 0) {
                    transactionsBody.innerHTML = transactions.map(tx => `
                        <tr>
                            <td>${new Date(tx.timestamp).toLocaleString()}</td>
                            <td>${tx.type}</td>
                            <td>₹${tx.amount}</td>
                            <td>${tx.status}</td>
                        </tr>
                    `).join('');
                } else {
                    transactionsBody.innerHTML = `<tr><td colspan="4">No transactions found.</td></tr>`;
                }
            } catch (e) {
                transactionsBody.innerHTML = `<tr><td colspan="4">Error loading data.</td></tr>`;
            }

            // Fetch and render bets
            try {
                const betSnap = await db.ref(`userBets/${userId}`).orderByKey().limitToLast(100).get();
                let bets = [];
                betSnap.forEach(s => bets.push({ periodId: s.key, ...s.val() }));
                bets.reverse();
                if (bets.length > 0) {
                    betsBody.innerHTML = bets.map(bet => {
                        const betsPlaced = Object.entries(bet.bets).map(([s, a]) => `${s}: ${a}`).join('<br>');
                        const resultDice = bet.result ? bet.result.join(', ') : 'Pending';
                        const outcomeText = bet.outcome > 0 ? `<span style="color:#22c55e;">Win: ₹${bet.outcome}</span>` : (bet.outcome < 0 ? `<span style="color:#ef4444;">Loss: ₹${Math.abs(bet.outcome)}</span>` : (bet.result ? 'No Win' : 'Pending'));
                        return `<tr><td>${bet.periodId}</td><td>${betsPlaced}</td><td>${resultDice}</td><td>${outcomeText}</td></tr>`;
                    }).join('');
                } else {
                    betsBody.innerHTML = `<tr><td colspan="4">No betting history found.</td></tr>`;
                }
            } catch (e) {
                betsBody.innerHTML = `<tr><td colspan="4">Error loading data.</td></tr>`;
            }
        }
    };

    // ==========================================================
    // ==================== REAL-TIME GAME LOGIC ================
    // ==========================================================
    
    const playAudio = () => {
        if (!AppState.audioSettings.enabled) return;
        if (gameAudio.paused) {
            const playPromise = gameAudio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => { console.warn("Audio playback was prevented."); });
            }
        }
    };
    const pauseAudio = () => {
        if (!gameAudio.paused) {
            gameAudio.pause();
            gameAudio.currentTime = 0; 
        }
    };
    
    const initializeGame = () => {
        bettingGridEl.innerHTML = '';
        GAME_CONFIG.SYMBOLS.forEach(symbol => {
            gameState.currentBets[symbol.id] = 0;
            const spot = document.createElement('div');
            spot.className = 'bet-spot';
            spot.dataset.symbol = symbol.id;
            spot.style.backgroundImage = `url('${symbol.background}')`;
            spot.innerHTML = `<div class="bet-symbol"><img src="${symbol.image}" alt="${symbol.id}"></div><div class="bet-amount">0</div>`;
            spot.addEventListener('click', () => placeBet(symbol.id));
            bettingGridEl.appendChild(spot);
        });

        gameStateRef.on('value', snapshot => {
            const serverState = snapshot.val();
            if (serverState && serverState.status && serverState.roundEndTime) {
                handleServerStateUpdate(serverState);
            } else {
                initServerGameState();
            }
        });

        if (gameState.uiUpdateInterval) clearInterval(gameState.uiUpdateInterval);
        gameState.uiUpdateInterval = setInterval(gameTick, 250);

        gameState.isGameInitialized = true;
    };

    const initServerGameState = () => {
        const periodId = Date.now();
        gameStateRef.set({
            periodId: periodId, 
            lastResult: ['?','?','?','?','?','?'],
            status: 'betting',
            roundEndTime: estimatedServerTime() + (GAME_CONFIG.BETTING_DURATION * 1000)
        }).catch(e => console.error("Failed to initialize game state:", e));
    };

    const commitBetsToServer = () => {
        if (!AppState.currentUser || gameState.hasCommittedBets) return;
        
        const totalBetValue = Object.values(gameState.currentBets).reduce((sum, bet) => sum + bet, 0);

        if (totalBetValue > 0) {
            const betsToCommit = {};
            for (const [symbol, amount] of Object.entries(gameState.currentBets)) {
                if (amount > 0) betsToCommit[symbol] = amount;
            }

            if (Object.keys(betsToCommit).length > 0) {
                const currentPeriodId = gameState.serverState.periodId;
                const userId = AppState.currentUser.uid;
                const userName = AppState.currentUser.name || AppState.currentUser.email.split('@')[0];
                
                // Save to live betting pool for admin view
                db.ref(`currentBets/${currentPeriodId}/${userId}`).set({
                    userName: userName,
                    bets: betsToCommit,
                    totalBet: totalBetValue
                });
                
                // Save to user's permanent betting history
                db.ref(`userBets/${userId}/${currentPeriodId}`).set({
                    bets: betsToCommit,
                    totalBet: totalBetValue,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                const userBalanceRef = db.ref(`users/${AppState.currentUser.uid}/balance`);
                userBalanceRef.transaction(currentBalance => {
                    if (currentBalance >= totalBetValue) return currentBalance - totalBetValue;
                    return;
                }, (error, committed) => {
                    if (error || !committed) {
                        AppState.currentUser.balance += totalBetValue;
                        resetLocalBets();
                        alert("Error placing bets. They have been cleared.");
                        // Rollback bet entry
                        db.ref(`currentBets/${currentPeriodId}/${userId}`).remove();
                        db.ref(`userBets/${userId}/${currentPeriodId}`).remove();
                    }
                });
            }
        }
        gameState.hasCommittedBets = true;
    };
    
    const gameTick = () => {
        if (!AppState.currentUser || !gameState.serverState || gameState.isTransitioning) return;
        
        const { roundEndTime, status } = gameState.serverState;
        const now = estimatedServerTime();
        
        if (status === 'betting') {
            const timeLeft = Math.ceil((roundEndTime - now) / 1000);
            gameState.isBettingLocked = timeLeft <= GAME_CONFIG.BETTING_LOCKED_TIME;
            
            timerEl.textContent = Math.max(0, timeLeft);
            timerEl.classList.toggle('locked', gameState.isBettingLocked);
            statusMessageEl.textContent = gameState.isBettingLocked ? 'Bets Locked!' : 'Place Your Bets!';
            document.querySelectorAll('.bet-spot').forEach(spot => spot.classList.toggle('locked', gameState.isBettingLocked));
            clearBetsBtn.disabled = gameState.isBettingLocked;
            
            if (timeLeft <= 0) {
                gameState.isTransitioning = true;
                if (!gameState.hasCommittedBets) commitBetsToServer();
                processRoundEnd();
            }
        } else if (status === 'viewing_result') {
            const timeLeft = Math.ceil((roundEndTime - now) / 1000);
            const displayTime = Math.max(0, timeLeft - (GAME_CONFIG.ANIMATION_DURATION / 1000));
            
            timerEl.textContent = Math.ceil(displayTime);
            statusMessageEl.textContent = `Next round in ${Math.ceil(displayTime)}s`;
            timerEl.classList.add('locked');
            document.querySelectorAll('.bet-spot').forEach(spot => spot.classList.add('locked'));
            clearBetsBtn.disabled = true;
            
            if (timeLeft <= 0) {
                gameState.isTransitioning = true;
                startNewRound();
            }
        }
    };

    const handleServerStateUpdate = (serverState) => {
        if (gameState.serverState?.status !== 'betting' && serverState.status === 'betting') {
            playAudio();
            // Admin: Start listening to new period bets
            if (AppState.currentUser?.role === 'admin') {
                listenToCurrentBets(serverState.periodId);
            }
        }

        gameState.serverState = serverState;
        periodIdDisplayEl.textContent = serverState.periodId;

        if (serverState.status === 'betting' && Array.isArray(serverState.lastResult)) {
            gameDiceEls().forEach((diceEl, index) => {
                const symbolId = serverState.lastResult[index];
                const symbolData = GAME_CONFIG.SYMBOLS.find(s => s.id === symbolId);
                diceEl.innerHTML = symbolData ? `<img src="${symbolData.image}" alt="${symbolData.id}">` : '?';
                diceEl.style.color = '';
            });
        }
        
        if (gameState.lastProcessedPeriodId !== serverState.periodId && serverState.status === 'viewing_result') {
            gameState.lastProcessedPeriodId = serverState.periodId;
            const resultSymbols = serverState.lastResult;

            diceTrayEl.classList.add('rolling');

            setTimeout(() => {
                gameDiceEls().forEach((diceEl, index) => {
                    const symbolData = GAME_CONFIG.SYMBOLS.find(s => s.id === resultSymbols[index]);
                    diceEl.innerHTML = symbolData ? `<img src="${symbolData.image}" alt="${symbolData.id}">` : '?';
                    diceEl.style.color = '';
                });
                
                diceTrayEl.classList.remove('rolling');
                calculateWinningsAndShowModal(resultSymbols);
                
            }, GAME_CONFIG.ANIMATION_DURATION);
        }
    };

    const processRoundEnd = () => {
        const currentPeriodId = gameState.serverState.periodId;
        gameStateRef.transaction(currentData => {
            if (currentData && currentData.status === 'betting' && currentData.periodId === currentPeriodId ) {
                const resultSymbols = Array.from({length: 6}, () => GAME_CONFIG.SYMBOLS[Math.floor(Math.random() * GAME_CONFIG.SYMBOLS.length)].id);
                return {
                    ...currentData,
                    status: 'viewing_result',
                    lastResult: resultSymbols,
                    roundEndTime: estimatedServerTime() + GAME_CONFIG.ANIMATION_DURATION + (GAME_CONFIG.RESULT_VIEW_DURATION * 1000)
                };
            }
            return;
        }, (error, committed) => {
            if (error) console.error("ProcessRoundEnd transaction failed:", error);
            if (committed) {
                // Once committed, delete the temporary live betting data
                db.ref(`currentBets/${currentPeriodId}`).remove();
            }
            gameState.isTransitioning = false;
        });
    };

    const startNewRound = () => {
        gameStateRef.transaction(currentData => {
            if (currentData && currentData.status === 'viewing_result' && currentData.periodId === gameState.serverState.periodId) {
                const newPeriodId = Date.now();
                return {
                    ...currentData,
                    periodId: newPeriodId,
                    status: 'betting',
                    roundEndTime: estimatedServerTime() + (GAME_CONFIG.BETTING_DURATION * 1000)
                };
            }
            return; 
        }, (error, committed) => {
            if (error) gameState.isTransitioning = false;
            if (committed) resetLocalBets();
        });
    };
    
    const calculateWinningsAndShowModal = (resultSymbols) => {
        pauseAudio();
        if (!AppState.currentUser || AppState.currentUser.role === 'admin') return;

        const resultCounts = {};
        resultSymbols.forEach(symbolId => resultCounts[symbolId] = (resultCounts[symbolId] || 0) + 1);

        let totalPayout = 0, winningBetsPrincipal = 0;
        let totalBetValue = Object.values(gameState.currentBets).reduce((sum, bet) => sum + bet, 0);

        for (const symbolId in gameState.currentBets) {
            const betAmount = gameState.currentBets[symbolId];
            if (betAmount > 0 && resultCounts[symbolId] > 0) {
                totalPayout += betAmount * resultCounts[symbolId];
                winningBetsPrincipal += betAmount;
            }
        }
        
        const amountCredited = totalPayout + winningBetsPrincipal;
        if (amountCredited > 0) {
            db.ref(`users/${AppState.currentUser.uid}/balance`).transaction(bal => (bal || 0) + amountCredited);
        }

        // Update user's bet history with result
        if (totalBetValue > 0) {
            db.ref(`userBets/${AppState.currentUser.uid}/${gameState.lastProcessedPeriodId}`).update({
                result: resultSymbols,
                outcome: totalPayout - (totalBetValue - winningBetsPrincipal)
            });
        }
        
        if (totalBetValue > 0) {
            resultModalContentEl.classList.remove('result-win', 'result-loss');
            if (amountCredited > 0) {
                resultModalTitleEl.textContent = 'You Win!';
                resultModalTextEl.innerHTML = `Won: ₹${totalPayout.toLocaleString()}<br>Returned: ₹${winningBetsPrincipal.toLocaleString()}<br><b>Total Credit: ₹${amountCredited.toLocaleString()}</b>`;
                resultModalContentEl.classList.add('result-win');
                if (window.confetti) confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            } else {
                resultModalTitleEl.textContent = 'You Lose!';
                resultModalTextEl.textContent = `You lost ₹${totalBetValue.toLocaleString()}. Better luck next time.`;
                resultModalContentEl.classList.add('result-loss');
            }
            resultModalEl.classList.add('visible');
            setTimeout(() => {
                resultModalEl.classList.remove('visible');
            }, GAME_CONFIG.RESULT_VIEW_DURATION * 1000 - 200);
        }
    };

    const resetLocalBets = () => {
        GAME_CONFIG.SYMBOLS.forEach(symbol => gameState.currentBets[symbol.id] = 0);
        gameState.hasCommittedBets = false;
        gameState.isTransitioning = false;
        updateGameDisplay();
    };

    const placeBet = (symbolId) => {
        if (gameState.isBettingLocked || !AppState.currentUser || AppState.currentUser.role === 'admin') return;
        if (AppState.currentUser.balance < gameState.selectedChipValue) {
            alert("Insufficient balance for this bet!"); return;
        }
        AppState.currentUser.balance -= gameState.selectedChipValue; 
        gameState.currentBets[symbolId] += gameState.selectedChipValue;
        updateGameDisplay();
    };

    const updateGameDisplay = () => {
        if (!AppState.currentUser) return;
        walletBalanceEl.textContent = `₹${(AppState.currentUser.balance || 0).toLocaleString()}`;
        for (const symbolId in gameState.currentBets) {
            const spotEl = bettingGridEl.querySelector(`[data-symbol="${symbolId}"]`);
            if(spotEl){
                const amountEl = spotEl.querySelector('.bet-amount');
                const betValue = gameState.currentBets[symbolId];
                amountEl.textContent = betValue > 0 ? betValue.toLocaleString() : '0';
                amountEl.classList.toggle('visible', betValue > 0);
            }
        }
    };

    const listenToCurrentBets = (periodId) => {
        // Detach old listener if it exists
        if (gameState.currentBetListener) {
            gameState.currentBetListener.off();
        }

        const betsRef = db.ref(`currentBets/${periodId}`);
        gameState.currentBetListener = betsRef;

        betsRef.on('value', snapshot => {
            const allBetsForPeriod = snapshot.val() || {};
            const diceTotals = {};
            const userTotals = {};

            GAME_CONFIG.SYMBOLS.forEach(s => diceTotals[s.id] = 0);

            for (const userId in allBetsForPeriod) {
                const userBetData = allBetsForPeriod[userId];
                userTotals[userBetData.userName] = (userTotals[userBetData.userName] || 0) + userBetData.totalBet;
                for (const symbol in userBetData.bets) {
                    diceTotals[symbol] = (diceTotals[symbol] || 0) + userBetData.bets[symbol];
                }
            }

            // Render Dice Totals
            const diceTotalsBody = document.getElementById('admin-dice-totals');
            let diceHtml = '';
            for (const [symbol, total] of Object.entries(diceTotals)) {
                diceHtml += `<tr><td>${symbol}</td><td>₹${total.toLocaleString()}</td></tr>`;
            }
            diceTotalsBody.innerHTML = diceHtml || '<tr><td colspan="2">No bets yet.</td></tr>';
            
            // Render User Totals
            const userTotalsBody = document.getElementById('admin-user-totals');
            let userHtml = '';
            for (const [userName, total] of Object.entries(userTotals)) {
                userHtml += `<tr><td>${userName}</td><td>₹${total.toLocaleString()}</td></tr>`;
            }
            userTotalsBody.innerHTML = userHtml || '<tr><td colspan="2">No bets yet.</td></tr>';
        });
    };

    // ==================== EVENT LISTENERS ====================
    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            if (page === 'logout' || (page === 'login' && AppState.currentUser)) { 
                handleLogout(); 
            } else {
                if (page === 'profile') renderProfilePage();
                if (page === 'admin') renderAdminDashboard();
                if (page === 'users') renderUserManagementPage();
                if (page === 'history' && AppState.currentUser?.role !== 'admin') renderHistoryPage();
                showPage(page);
            }
        });
    });
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('register-form').addEventListener('submit', handleRegister);
    document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
    document.getElementById('goto-register').addEventListener('click', (e) => { e.preventDefault(); showPage('register'); });
    document.getElementById('goto-login').addEventListener('click', (e) => { e.preventDefault(); showPage('login'); });
    document.getElementById('goto-forgot-password').addEventListener('click', (e) => { e.preventDefault(); showPage('forgot-password'); });
    document.getElementById('goto-login-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showPage('login'); });
    profileForm.addEventListener('submit', handleProfileUpdate);
    document.getElementById('topup-btn').addEventListener('click', handleTopupRequest);
    document.getElementById('withdrawal-btn').addEventListener('click', handleWithdrawalRequest);
    document.getElementById('payment-form').addEventListener('submit', handleTopupSubmit);
    document.getElementById('payment-cancel-btn').addEventListener('click', () => paymentModal.classList.remove('visible'));
    document.getElementById('payment-settings-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (AppState.currentUser?.role !== 'admin') return;
        const newUpiId = document.getElementById('admin-upi-id').value.trim();
        if (newUpiId) {
            db.ref('settings/paymentDetails').set({ upiId: newUpiId })
                .then(() => alert('UPI ID updated successfully!'))
                .catch(err => alert('Error: ' + err.message));
        } else {
            alert('UPI ID cannot be empty.');
        }
    });
    adminTopupForm.addEventListener('submit', (e) => { 
        e.preventDefault(); 
        const userId = document.getElementById('admin-topup-userid').value; 
        const amount = parseInt(document.getElementById('admin-topup-amount').value, 10); 
        if(isNaN(amount) || amount <= 0) { 
            alert('Please enter a valid amount.'); 
            return; 
        } 
        db.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) + amount)
            .then(() => { 
                alert('Top-up successful!'); 
                adminTopupModal.classList.remove('visible'); 
                adminTopupForm.reset(); 
            }); 
    });
    document.getElementById('admin-topup-cancel-btn').addEventListener('click', () => adminTopupModal.classList.remove('visible'));
    document.getElementById('user-details-close-btn').addEventListener('click', () => userDetailsModal.classList.remove('visible'));
    chipSelectorEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('chip')) {
            chipSelectorEl.querySelector('.active').classList.remove('active');
            e.target.classList.add('active');
            gameState.selectedChipValue = parseInt(e.target.dataset.value, 10);
        }
    });
    clearBetsBtn.addEventListener('click', () => {
        if (gameState.isBettingLocked || !AppState.currentUser) return;
        let totalBetValue = Object.values(gameState.currentBets).reduce((sum, bet) => sum + bet, 0);
        AppState.currentUser.balance += totalBetValue;
        resetLocalBets();
    });

    const musicToggleCheckbox = document.getElementById('music-toggle-checkbox');
    if (musicToggleCheckbox) {
        musicToggleCheckbox.addEventListener('change', (e) => {
            const newStatus = e.target.checked;
            db.ref('settings/audio').set({ enabled: newStatus })
                .catch(err => alert('Error updating setting: ' + err.message));
            
            if (!newStatus) {
                pauseAudio();
            }
        });
    }
});
</script>

<script>
  (function(){function _0x1a3c(_0x12, _0x34){return _0x1a3c=_0x34?function(_0x56){return _0x56.toString(36)}:function(_0x56){return _0x56};return _0x1a3c(_0x12,_0x34);}document'addEventListener';document['addEventListener']('keydown',function(_0x2){if(_0x2['key']==='F12'){_0x2'preventDefault';}if((_0x2['ctrlKey']&&_0x2['shiftKey']&&['I','J','C']'includes')||(_0x2['ctrlKey']&&['U','S']'includes')){_0x2'preventDefault';}});})();</script>

</body>
</html>
