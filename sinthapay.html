
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sintha PayApp - by Sintha Team</title>
    <link rel="icon" href="https://img.icons8.com/fluency/48/000000/wallet.png" type="image/x-icon">
    
    <!-- FONT AWESOME CDN ADDED -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary-purple: #6739B7;
            --primary-purple-dark: #502896;
            --gradient-start: #6739B7;
            --gradient-end: #4D258A;
            --accent-green: #35a865;
            --accent-blue: #3E8BFF;
            --accent-red: #E74C3C;
            --text-light: #FFFFFF;
            --text-dark: #333333;
            --bg-light: #F4F5F9;
            --bg-dark: #1A1A2E;
            --card-bg-light: #FFFFFF;
            --card-bg-dark: #2A2A45;
            --border-light: #E0E0E0;
            --border-dark: #404060;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            --text-dark: var(--text-light);
            --bg-light: var(--bg-dark);
            --card-bg-light: var(--card-bg-dark);
            --border-light: var(--border-dark);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }

        .app-container {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-light);
            position: relative;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            animation: fadeIn 0.4s ease-in-out;
            min-height: 100vh;
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .content-area {
            flex-grow: 1;
            padding: 20px 15px 80px 15px;
        }

        .hidden { display: none !important; }
        .card {
            background-color: var(--card-bg-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary {
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            color: var(--text-light);
        }
        .btn-secondary {
            background-color: #e9e5f3;
            color: var(--primary-purple);
        }
        .input-field {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            background-color: var(--bg-light);
            color: var(--text-dark);
            box-sizing: border-box;
        }
        .input-group { position: relative; }
        .input-group label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            display: block;
        }
        
        /* Flash Screen Styles */
        #flashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #flashScreen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .flash-content {
            animation: zoomIn 1s ease-in-out;
        }
        .flash-content i { /* UPDATED from svg */
            color: white;
            font-size: 80px;
        }
        .flash-content h1 {
            font-size: 48px;
            margin: 10px 0 0 0;
            letter-spacing: 2px;
        }
        .flash-content p {
            font-size: 16px;
            opacity: 0.8;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Verification Screen Styles */
        #verificationScreen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }
        .verification-container {
            width: 100%;
            max-width: 380px;
            padding: 40px 30px;
            background-color: var(--card-bg-light);
            border-radius: 20px;
            text-align: center;
        }
        .verification-container h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: var(--text-dark);
        }
        .verification-container p {
            color: #888;
            margin-bottom: 25px;
        }
        #verificationPinContainer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        #verificationPinContainer .pin-digit {
            width: 50px;
            height: 60px;
            font-size: 28px;
            text-align: center;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            background-color: var(--bg-light);
            color: var(--text-dark);
            -webkit-text-security: disc;
        }
        #verificationLogoutBtn {
            display: inline-block;
            margin-top: 20px;
            font-size: 14px;
            color: var(--primary-purple);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* === PROFILE PICTURE STYLES START === */
        /* Base profile pic is now a container */
        .profile-pic {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            background-color: #e9e5f3; /* Default background for icon */
            color: var(--primary-purple); /* Default color for icon */
        }

        /* The actual image inside the container */
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Header variant */
        .app-header .profile-pic {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border: 2px solid yellow;
            box-shadow: 0 0 0 2px black;
            background-color: rgba(255,255,255,0.3);
            color: white;
            font-size: 20px;
        }

        /* Verification screen variant */
        .verification-container .profile-pic {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px auto;
            border: 3px solid yellow;
            box-shadow: 0 0 0 2px black;
            font-size: 40px; /* Icon size */
        }
        /* === PROFILE PICTURE STYLES END === */

        .app-header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--text-light);
            padding: 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; }
        .header-info h4, .header-info p { margin: 0; }
        .header-info h4 { font-size: 16px; font-weight: 600; }
        .header-info p { font-size: 12px; opacity: 0.8; }
        .header-right .icon { font-size: 24px; margin-left: 20px; cursor: pointer; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 450px;
            width: 100%;
            height: 65px;
            background-color: var(--card-bg-light);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            border-top: 1px solid var(--border-light);
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }
        .nav-item.active { color: var(--primary-purple); }
        .nav-item i { /* UPDATED from svg */
            font-size: 22px; 
            width: 24px; /* maintain layout */
            height: 24px; /* maintain layout */
            margin-bottom: 4px; 
            text-align: center;
        }
        .nav-item span { font-size: 11px; font-weight: 500; }

        #authScreen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }
        .auth-container {
            width: 100%;
            max-width: 380px;
            padding: 40px 30px;
            background-color: var(--card-bg-light);
            border-radius: 20px;
            text-align: center;
        }
        .auth-icon {
            color: var(--primary-purple);
            margin-bottom: 20px;
            font-size: 48px;
        }
        .auth-container h2 {
            text-align: center;
            color: var(--primary-purple);
            margin-top: 0;
            margin-bottom: 30px;
        }
        .auth-container .input-group {
            text-align: left;
        }
        .auth-container .btn {
            margin-top: 10px;
        }
        .auth-toggle { text-align: center; margin-top: 20px; font-size: 14px; }
        .auth-toggle a { color: var(--primary-purple); text-decoration: none; font-weight: 600; cursor: pointer; }

        .wallet-balance-card {
            background: linear-gradient(90deg, #4d258a, #7a5fba);
            color: var(--text-light);
            text-align: center;
        }
        .wallet-balance-card p { margin: 0; opacity: 0.8; font-size: 14px; }
        .wallet-balance-card h1 { margin: 10px 0; font-size: 36px; }
        .wallet-actions { display: flex; justify-content: space-around; }
        .wallet-actions button { flex: 1; margin: 0 5px; background: rgba(255,255,255,0.2); color: white; border: none; }
        
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            text-align: center;
        }
        .menu-item { display: flex; flex-direction: column; align-items: center; cursor: pointer;}
        .menu-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            background-color: #e9e5f3;
            color: var(--primary-purple);
            font-size: 22px; /* Adjusted for Font Awesome */
        }
        .menu-item span { font-size: 12px; font-weight: 500; color: var(--text-dark); }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .page-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .back-btn { font-size: 24px; margin-right: 15px; cursor: pointer; color: var(--text-dark); }
        .page-header h3 { margin: 0; font-size: 20px; }

        #historyScreen .filters { display: flex; gap: 10px; margin-bottom: 20px; }
        #historyScreen .filters select { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-light); }
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .transaction-item:last-child { border-bottom: none; }
        .txn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        .txn-icon.sent { background-color: var(--accent-red); }
        .txn-icon.received { background-color: var(--accent-green); }
        .txn-icon.topup { background-color: var(--accent-blue); }
        .txn-icon.bill { background-color: var(--primary-purple); }
        .txn-details { flex-grow: 1; }
        .txn-details p { margin: 0; }
        .txn-description { font-weight: 500; }
        .txn-date { font-size: 12px; color: #888; }
        .txn-amount-container { text-align: right; }
        .txn-amount { font-weight: 600; }
        .txn-amount.sent { color: var(--accent-red); }
        .txn-amount.received { color: var(--accent-green); }
        .txn-status { font-size: 11px; font-weight: 500; display: block; margin-top: 2px; text-transform: capitalize; }
        .txn-status.pending { color: #f39c12; }
        .txn-status.declined { color: var(--accent-red); }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        /* Profile page header variant */
        .profile-header .profile-pic {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px auto;
            border: 4px solid yellow;
            box-shadow: 0 0 0 3px black;
            cursor: pointer;
            font-size: 50px; /* Icon size */
        }
        .profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .profile-info-item span:first-child { color: #888; }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--card-bg-light);
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h4 { margin: 0; font-size: 18px; }
        .close-modal { font-size: 24px; cursor: pointer; color: #999; }
        #qrCodeContainer { text-align: center; }
        #qrCodeImage { margin-top: 15px; }
        
        #pinInputContainer { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .pin-digit {
            width: 40px;
            height: 50px;
            font-size: 24px;
            text-align: center;
            border: 1px solid var(--border-light);
            border-radius: 8px;
        }

        #adminPanel .content-area {
            background-color: #e9e5f3;
        }
        .admin-stat-card {
            background: linear-gradient(45deg, var(--accent-blue), #69b3ff);
            color: white;
            padding: 15px;
        }
        .admin-stat-card h2 { margin: 0 0 5px 0; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
            vertical-align: middle;
        }
        .admin-table th { font-weight: 600; }
        .admin-table button {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 6px;
            margin-right: 5px;
        }

        #toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            border-radius: 25px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, transform 0.3s;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }

        /* Animation Overlay Styles */
        .animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .animation-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .animation-content {
            background-color: var(--card-bg-light);
            color: var(--text-dark);
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 200px;
        }
        .animation-content p {
            margin: 20px 0 0 0;
            font-size: 16px;
            font-weight: 500;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .animation-icon {
            width: 80px;
            height: 80px;
        }

        /* Checkmark Styles */
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: var(--accent-green);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px var(--accent-green);
            animation: fill-green .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        /* Crossmark Styles */
        .crossmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: var(--accent-red);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .crossmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px var(--accent-red);
            animation: fill-red .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .crossmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }


        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        @keyframes scale {
            0%, 100% { transform: none; }
            50% { transform: scale3d(1.1, 1.1, 1); }
        }
        @keyframes fill-green {
            100% { box-shadow: inset 0px 0px 0px 40px var(--accent-green); }
        }
        @keyframes fill-red {
            100% { box-shadow: inset 0px 0px 0px 40px var(--accent-red); }
        }

        /* === NEW AND UPDATED STYLES START HERE === */

        /* User Grid Styles */
        #userListContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 20px;
            text-align: center;
        }
        .user-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        /* NEW: User grid picture container */
        .user-grid-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 2px solid yellow;
            box-shadow: 0 0 0 2px black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary-purple);
            background-color: #e9e5f3;
            overflow: hidden;
        }
        .user-grid-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-grid-item span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        
        /* Updated Chat Screen Layout */
        #chatScreen {
            height: 100vh;
            padding-bottom: 65px;
            box-sizing: border-box;
        }
        #chatScreen .content-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            overflow: hidden; 
            padding: 0;
            height: 100%;
        }
        #chatScreen .app-header {
            flex-shrink: 0;
        }
        #chatBody {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        #chatMessages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .message-bubble {
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 75%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
        }
        .message-sent {
            background-color: var(--primary-purple);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message-received {
            background-color: #e9e5f3;
            color: var(--text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .message-timestamp {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
            text-align: right;
            display: block;
        }
        .message-sent .message-timestamp {
            color: rgba(255, 255, 255, 0.7);
        }
        .message-system {
            align-self: center;
            background-color: var(--bg-light);
            color: #888;
            font-size: 12px;
            padding: 6px 14px;
            border-radius: 15px;
            max-width: 80%;
            text-align: center;
        }

        /* Chat Input Container */
        #chatInputContainer {
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
            padding: 10px 15px;
            background-color: var(--card-bg-light);
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #chatMessageInput {
            flex-grow: 1;
            margin-bottom: 0;
        }
        #sendMessageBtn {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            padding: 0;
            margin-left: 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #sendMessageBtn i { /* UPDATED from svg */
            font-size: 20px;
        }

        /* Modern Payment Input for Modals */
        .payment-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .payment-modal-content p {
            color: #888;
            font-size: 14px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .modern-payment-input-container {
            display: flex;
            align-items: baseline;
            justify-content: center;
            border-bottom: 2px solid var(--primary-purple);
            padding-bottom: 5px;
            margin-bottom: 30px;
            width: 90%;
        }
        .modern-payment-input-container .currency-symbol {
            font-size: 36px;
            font-weight: 300;
            color: #888;
            margin-right: 8px;
        }
        .modern-payment-input {
            font-size: 48px;
            font-weight: 600;
            color: var(--text-dark);
            border: none;
            background: transparent;
            width: 100%;
            text-align: center;
            outline: none;
        }
        .modern-payment-input::-webkit-outer-spin-button,
        .modern-payment-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .modern-payment-input[type=number] {
            -moz-appearance: textfield;
        }
        /* === END OF NEW AND UPDATED STYLES === */
    </style>
</head>
<body>
    
    <div id="flashScreen">
        <div class="flash-content">
            <i class="fas fa-wallet"></i>
            <h1>Sintha PayApp</h1>
            <p>secure payment</p>
        </div>
    </div>
    
    <div class="app-container">
        
        <div id="verificationScreen" class="screen">
            <div class="verification-container">
                <!-- MODIFIED: Changed from <img> to <div> for icon fallback -->
                <div id="verificationUserPicContainer" class="profile-pic"></div>
                <h3 id="verificationUserName">Welcome Back</h3>
                <p>Enter your 4-digit PIN to continue</p>
                <div id="verificationPinContainer">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                </div>
                <p id="verificationError" style="color:var(--accent-red); height: 1em;"></p>
                <a id="verificationLogoutBtn">Logout & Use Another Account</a>
            </div>
        </div>

        <div id="authScreen" class="screen">
            <div class="auth-container">
                <div class="auth-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <form id="loginForm">
                    <h2>Welcome Back</h2>
                    <div class="input-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="input-field" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <p class="auth-toggle">New here? <a id="showSignup">Create an account</a></p>
                </form>

                <form id="signupForm" class="hidden">
                    <h2>Create Account</h2>
                    <div class="input-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="signupPhone">Phone Number</label>
                        <input type="tel" id="signupPhone" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="signupPin">Set 4-Digit PIN</label>
                        <input type="password" id="signupPin" class="input-field" required maxlength="4" pattern="\d{4}" inputmode="numeric">
                    </div>
                    <button type="submit" class="btn btn-primary">Sign Up</button>
                    <p class="auth-toggle">Already have an account? <a id="showLogin">Login</a></p>
                </form>
            </div>
        </div>

        <div id="userApp" class="hidden">
            <div id="homeScreen" class="screen">
                <header class="app-header">
                    <div class="header-left">
                        <!-- MODIFIED: Changed from <img> to <div> for icon fallback -->
                        <div id="userProfilePicContainer" class="profile-pic"></div>
                        <div class="header-info">
                            <h4 id="userName">Loading...</h4>
                            <p>Welcome to PayApp</p>
                        </div>
                    </div>
                    <div class="header-right">
                        <i class="fas fa-bell icon" id="notificationBtn"></i>
                    </div>
                </header>
                <div class="content-area">
                    <div class="card wallet-balance-card">
                        <p>Total Wallet Balance</p>
                        <h1 id="walletBalance">₹ 0.00</h1>
                        <div class="wallet-actions">
                            <button class="btn" id="topupBtn">Top-up Wallet</button>
                            <button class="btn" id="sendMoneyHomeBtn">Send Money</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="grid-menu">
                            <div class="menu-item" id="transferMoneyMenu">
                                <div class="menu-item-icon"><i class="fas fa-exchange-alt"></i></div>
                                <span>Transfer Money</span>
                            </div>
                            <div class="menu-item" id="receiveMoneyMenu">
                                <div class="menu-item-icon"><i class="fas fa-qrcode"></i></div>
                                <span>Receive Money</span>
                            </div>
                            <div class="menu-item" id="scanPayMenu">
                                <div class="menu-item-icon"><i class="fas fa-camera"></i></div>
                                <span>Scan & Pay</span>
                            </div>
                             <div class="menu-item" id="withdrawMenu">
                                <div class="menu-item-icon"><i class="fas fa-university"></i></div>
                                <span>Withdraw</span>
                            </div>
                        </div>
                    </div>

                    <!-- All Users in a Grid -->
                    <div class="card">
                        <h3 class="section-title">All Users</h3>
                        <div id="userListContainer">
                            <p style="text-align: center; color: #888; grid-column: 1 / -1;">Loading users...</p>
                            <!-- User grid will be populated here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="historyScreen" class="screen">
                <div class="content-area">
                    <div class="page-header">
                        <h3>Transaction History</h3>
                    </div>
                    <div class="filters">
                        <select id="historyFilterType">
                            <option value="all">All Types</option>
                            <option value="P2P">P2P</option>
                            <option value="TOPUP">Top-up</option>
                            <option value="WITHDRAWAL">Withdrawal</option>
                            <option value="BILL">Bill Payment</option>
                            <option value="CASHBACK">Cashback</option>
                        </select>
                        <select id="historyFilterDate">
                            <option value="all">All Time</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                        </select>
                    </div>
                    <div id="transactionList" class="card">
                        <p>No transactions found.</p>
                    </div>
                </div>
            </div>
            
            <div id="analyticsScreen" class="screen">
                <div class="content-area">
                     <div class="page-header">
                        <h3>Spend Analytics</h3>
                    </div>
                    <div class="card">
                        <canvas id="spendChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="profileScreen" class="screen">
                 <div class="content-area">
                     <div class="page-header">
                        <h3>My Profile</h3>
                    </div>
                    <div class="card">
                        <div class="profile-header">
                             <!-- MODIFIED: Changed from <img> to <div> for icon fallback -->
                            <div id="profilePagePicContainer" class="profile-pic"></div>
                            <input type="file" id="profilePicUpload" class="hidden" accept="image/*">
                            <h3 id="profilePageName">Loading...</h3>
                            <p id="profilePageEmail">loading@email.com</p>
                        </div>
                        <div class="profile-info">
                            <div class="profile-info-item">
                                <span>Phone Number</span>
                                <span id="profilePagePhone"></span>
                            </div>
                            <div class="profile-info-item">
                                <span>Account Status</span>
                                <span id="profilePageStatus" style="color:var(--accent-green); font-weight: bold;">Active</span>
                            </div>
                            <div class="profile-info-item">
                                <span>Theme</span>
                                <label class="switch">
                                    <input type="checkbox" id="themeToggle">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                 </div>
            </div>

            <!-- CHAT SCREEN - FULLY IMPLEMENTED -->
            <div id="chatScreen" class="screen">
                <div class="content-area">
                    <header class="app-header" id="chatHeader">
                        <span class="back-btn" id="chatBackBtn" style="color: white; margin-right: 0;"><i class="fas fa-arrow-left"></i></span>
                        <div class="header-left" style="margin-left: 10px; flex-grow: 1;">
                            <!-- MODIFIED: Changed from <img> to <div> for icon fallback -->
                            <div id="chatUserPicContainer" class="profile-pic"></div>
                            <div class="header-info">
                                <h4 id="chatUserName">User Name</h4>
                            </div>
                        </div>
                        <button id="chatPayBtn" class="btn" style="background-color: var(--accent-green); color: white; width: auto; padding: 8px 15px; font-size: 14px; margin-left: 10px;">Pay</button>
                    </header>
                    <div id="chatBody">
                        <!-- Chat messages and transactions will appear here, merged and sorted -->
                        <div id="chatMessages"></div>
                    </div>
                    <!-- Chat input container at the bottom -->
                    <div id="chatInputContainer">
                        <input type="text" id="chatMessageInput" class="input-field" placeholder="Type a message...">
                        <button id="sendMessageBtn" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <nav class="bottom-nav">
                <div class="nav-item active" data-screen="homeScreen">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </div>
                <div class="nav-item" data-screen="historyScreen">
                   <i class="fas fa-history"></i>
                    <span>History</span>
                </div>
                 <div class="nav-item" data-screen="analyticsScreen">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" data-screen="profileScreen">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
            </nav>
        </div>

        <div id="adminPanel" class="screen">
            <header class="app-header">
                 <div class="header-left">
                    <div class="header-info">
                        <h4>Admin Dashboard</h4>
                        <p id="adminName">Admin</p>
                    </div>
                </div>
                <div class="header-right">
                    <i class="fas fa-sign-out-alt icon" id="adminLogoutBtn"></i>
                </div>
            </header>
            <div class="content-area">
                <div class="card admin-stat-card">
                    <p>Total Users</p>
                    <h2 id="adminTotalUsers">0</h2>
                </div>
                <div class="card admin-stat-card" style="background: linear-gradient(45deg, #28a745, #5fcf80);">
                    <p>Total Transaction Value</p>
                    <h2 id="adminTotalTxnValue">₹ 0</h2>
                </div>
                
                 <div class="card">
                    <h3 class="section-title">Pending Top-Up Requests</h3>
                    <div id="adminPendingTopups">
                        <p>No pending top-up requests.</p>
                    </div>
                </div>
                
                 <div class="card">
                    <h3 class="section-title">Pending Withdrawal Requests</h3>
                    <div id="adminPendingWithdrawals">
                        <p>No pending withdrawal requests.</p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">High-Value Transfer Approvals</h3>
                    <div id="adminPendingApprovals">
                        <p>No pending approvals.</p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">Manage Users</h3>
                    <div style="overflow-x:auto;">
                        <table class="admin-table" id="adminUsersTable">
                            <thead><tr><th>Name</th><th>Email</th><th>Balance</th><th>Actions</th></tr></thead>
                            <tbody><tr><td colspan="4">Loading users...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">App Configuration</h3>
                    <div class="input-group">
                        <label for="adminAnnouncement">Broadcast Announcement</label>
                        <input type="text" id="adminAnnouncement" class="input-field" placeholder="Enter announcement text">
                        <button id="adminUpdateAnnouncement" class="btn btn-secondary" style="width:auto; padding: 8px 15px;">Broadcast</button>
                    </div>
                    <div class="input-group">
                        <label>Cashback Rule (e.g., for Recharges)</label>
                        <input type="number" id="adminCashbackMin" class="input-field" placeholder="Min Amount (e.g., 100)">
                        <input type="number" id="adminCashbackPercent" class="input-field" placeholder="Percentage (e.g., 2 for 2%)">
                        <button id="adminUpdateCashback" class="btn btn-secondary" style="width:auto; padding: 8px 15px;">Update Rule</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="scannerModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Scan QR Code</h4>
                    <span class="close-modal">&times;</span>
                </div>
                <div id="scannerBody">
                    <div id="qr-reader" style="width:100%; border-radius: 12px; overflow: hidden;"></div>
                    <p style="text-align:center; margin-top:15px; color:#888;">Point your camera at a QR code to pay.</p>
                </div>
            </div>
        </div>

        <div id="genericModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="modalTitle">Modal Title</h4>
                    <span class="close-modal">&times;</span>
                </div>
                <div id="modalBody">
                </div>
            </div>
        </div>

        <div id="pinModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Enter Your UPI PIN</h4>
                    <span class="close-modal">&times;</span>
                </div>
                <div id="pinModalBody">
                    <p>Enter your 4-digit security PIN to complete this transaction.</p>
                    <div id="pinInputContainer">
                        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
                    </div>
                    <button id="pinConfirmBtn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    
    <!-- Transaction Animation Overlay -->
    <div id="animationOverlay" class="animation-overlay">
        <div class="animation-content">
            <div class="spinner"></div>
            <div class="animation-icon success hidden">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <div class="animation-icon fail hidden">
                <svg class="crossmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="crossmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="crossmark__check" stroke-linecap="round" fill="none" d="M16 16 36 36 M36 16 16 36"/>
                </svg>
            </div>
            <p id="animationMessage">Processing...</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const firebaseConfig = {
              apiKey: "AIzaSyB2imEIvh_bWbYD_yPB7p3af7bV9OWdA5A",
              authDomain: "sinthahousie-1dd3b.firebaseapp.com",
              databaseURL: "https://sinthahousie-1dd3b-default-rtdb.firebaseio.com",
              projectId: "sinthahousie-1dd3b",
              storageBucket: "sinthahousie-1dd3b.firebasestorage.app",
              messagingSenderId: "76567991256",
              appId: "1:76567991256:web:c58b127b8d86d8a1c598ad",
              measurementId: "G-MGW406NKBY"
            };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let currentUserData = null;
        let currentPinCallback = null;
        let spendChartInstance = null;
        let html5QrCode = null;
        let currentChatListener = null; 
        let currentChatId = null; 

        const screens = document.querySelectorAll('.screen');
        const flashScreen = document.getElementById('flashScreen');
        const verificationScreen = document.getElementById('verificationScreen');
        const authScreen = document.getElementById('authScreen');
        const userApp = document.getElementById('userApp');
        const adminPanel = document.getElementById('adminPanel');

        const genericModal = document.getElementById('genericModal');
        const pinModal = document.getElementById('pinModal');
        const scannerModal = document.getElementById('scannerModal');
        const toast = document.getElementById('toast');

        const animationOverlay = document.getElementById('animationOverlay');
        const spinner = animationOverlay.querySelector('.spinner');
        const successIcon = animationOverlay.querySelector('.animation-icon.success');
        const failIcon = animationOverlay.querySelector('.animation-icon.fail');
        const animationMessage = document.getElementById('animationMessage');
        
        // NEW: Helper function to set profile picture or default icon
        const setProfilePicture = (containerElement, picUrl) => {
            if (picUrl) {
                containerElement.innerHTML = `<img src="${picUrl}" alt="Profile Picture">`;
            } else {
                containerElement.innerHTML = `<i class="fas fa-user-tie"></i>`;
            }
        };
        
        const detachChatListener = () => {
            if (currentChatListener && currentChatId) {
                db.ref('chats/' + currentChatId).off('child_added', currentChatListener);
                currentChatListener = null;
                currentChatId = null;
            }
        };

        const showScreen = (screenId) => {
            // Cleanup logic for chat screen when navigating away
            if (document.getElementById('chatScreen').classList.contains('active') && screenId !== 'chatScreen') {
                detachChatListener();
            }

            document.querySelectorAll('.screen.active').forEach(s => s.classList.remove('active'));
            userApp.classList.add('hidden'); // Default hide userApp container

            if (screenId === 'adminPanel') {
                adminPanel.classList.add('active');
            } else if (screenId === 'authScreen' || screenId === 'verificationScreen') {
                document.getElementById(screenId).classList.add('active');
            } else {
                userApp.classList.remove('hidden');
                document.getElementById(screenId).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.screen === screenId);
                });
            }
        };

        const showAnimationOverlay = (message) => {
            animationMessage.textContent = message || 'Processing...';
            spinner.classList.remove('hidden');
            successIcon.classList.add('hidden');
            failIcon.classList.add('hidden');
            animationOverlay.classList.add('active');
        };

        const showSuccessAnimation = (message) => {
            animationMessage.textContent = message || 'Success!';
            spinner.classList.add('hidden');
            successIcon.classList.remove('hidden');
            failIcon.classList.add('hidden');
            setTimeout(() => {
                animationOverlay.classList.remove('active');
            }, 2500);
        };

        const showFailAnimation = (message) => {
            animationMessage.textContent = message || 'Failed!';
            spinner.classList.add('hidden');
            successIcon.classList.add('hidden');
            failIcon.classList.remove('hidden');
            setTimeout(() => {
                animationOverlay.classList.remove('active');
            }, 3000);
        };
        
        auth.onAuthStateChanged(user => {
            setTimeout(() => {
                flashScreen.classList.add('hidden');
                
                if (user) {
                    currentUser = user;
                    db.ref('users/' + user.uid).once('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            auth.signOut();
                            return;
                        }
                        const userData = snapshot.val();
                        if (userData.role === 'admin') {
                            startAdminSession(userData);
                        } else {
                            setupAndShowVerificationScreen(userData);
                        }
                    });
                } else {
                    currentUser = null;
                    currentUserData = null;
                    showScreen('authScreen');
                }
            }, 2500);
        });

        function setupAndShowVerificationScreen(userData) {
            document.getElementById('verificationUserName').textContent = `Welcome Back, ${userData.name.split(' ')[0]}`;
            // MODIFIED: Use the helper function to set the profile picture or icon
            const picContainer = document.getElementById('verificationUserPicContainer');
            setProfilePicture(picContainer, userData.profilePicture);

            showScreen('verificationScreen');

            document.getElementById('verificationError').textContent = '';
            const pinInputs = verificationScreen.querySelectorAll('.pin-digit');
            pinInputs.forEach(input => input.value = '');
            pinInputs[0].focus();

            const verifyPinHandler = () => verifyPin(userData);

            pinInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value && index < pinInputs.length - 1) {
                        pinInputs[index + 1].focus();
                    }
                    if (Array.from(pinInputs).every(i => i.value)) {
                        verifyPinHandler();
                    }
                });
                 input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        pinInputs[index - 1].focus();
                    }
                });
            });

            document.getElementById('verificationLogoutBtn').addEventListener('click', () => {
                auth.signOut();
            }, { once: true });
        }

        function verifyPin(userData) {
            const pinInputs = verificationScreen.querySelectorAll('.pin-digit');
            const enteredPin = Array.from(pinInputs).map(i => i.value).join('');
            const errorEl = document.getElementById('verificationError');

            if (enteredPin === userData.pin) {
                errorEl.textContent = '';
                startUserSession();
            } else {
                errorEl.textContent = 'Incorrect PIN. Please try again.';
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();
                const container = document.getElementById('verificationPinContainer');
                container.classList.add('shake');
                setTimeout(() => container.classList.remove('shake'), 500);
            }
        }

        function startUserSession() {
            db.ref('users/' + currentUser.uid).on('value', (snapshot) => {
                currentUserData = snapshot.val();
                if (!currentUserData) return;
                if(currentUserData.isBlocked) {
                    alert('Your account has been blocked. Please contact support.');
                    auth.signOut();
                    return;
                }
                updateUserUI();
            });
            listenForTransactions();
            listenForNotifications();
            initializeUserApp();
            loadUserList(); 
        }
        
        function startAdminSession(adminData) {
            currentUserData = adminData;
            showScreen('adminPanel');
            initializeAdminPanel();
        }

        const showToast = (message) => {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        
        const openModal = (title, content) => {
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = content;
            genericModal.classList.add('active');
        };

        const closeModal = () => {
            if (scannerModal.classList.contains('active')) {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Error stopping scanner on close.", err));
                }
                scannerModal.classList.remove('active');
            }
            genericModal.classList.remove('active');
            pinModal.classList.remove('active');
        };

        const openPinModal = (callback) => {
            currentPinCallback = callback;
            const pinInputs = pinModal.querySelectorAll('.pin-digit');
            pinInputs.forEach(input => input.value = '');
            pinInputs[0].focus();
            pinModal.classList.add('active');
        };
        
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => showToast(`Error: ${err.message}`));
        });
        
        document.getElementById('signupForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const phone = document.getElementById('signupPhone').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const pin = document.getElementById('signupPin').value;

            if(pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showToast("PIN must be exactly 4 digits.");
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    db.ref('users/' + user.uid).set({
                        name: name,
                        email: email,
                        phone: phone,
                        pin: pin,
                        walletBalance: 0,
                        role: 'user',
                        isBlocked: false,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                })
                .catch(err => showToast(`Error: ${err.message}`));
        });

        document.getElementById('showSignup').addEventListener('click', () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        });
        document.getElementById('showLogin').addEventListener('click', () => {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        });

        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('adminLogoutBtn').addEventListener('click', () => auth.signOut());

        const initializeUserApp = () => {
            showScreen('homeScreen');
            document.getElementById('profilePagePicContainer').addEventListener('click', () => {
                document.getElementById('profilePicUpload').click();
            });
            document.getElementById('profilePicUpload').addEventListener('change', handleProfilePicUpload);
        };
        
        const updateUserUI = () => {
            if (!currentUserData) return;
            document.getElementById('userName').textContent = currentUserData.name;
            document.getElementById('walletBalance').textContent = `₹ ${currentUserData.walletBalance.toFixed(2)}`;
            document.getElementById('profilePageName').textContent = currentUserData.name;
            document.getElementById('profilePageEmail').textContent = currentUserData.email;
            document.getElementById('profilePagePhone').textContent = currentUserData.phone;
            document.getElementById('profilePageStatus').textContent = currentUserData.isBlocked ? 'Blocked' : 'Active';
            if(currentUserData.isBlocked) document.getElementById('profilePageStatus').style.color = 'var(--accent-red)';

            // MODIFIED: Use helper function to set profile pictures or icons
            const headerPicContainer = document.getElementById('userProfilePicContainer');
            setProfilePicture(headerPicContainer, currentUserData.profilePicture);

            const profilePagePicContainer = document.getElementById('profilePagePicContainer');
            setProfilePicture(profilePagePicContainer, currentUserData.profilePicture);
        };

        const handleProfilePicUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result;
                db.ref('users/' + currentUser.uid + '/profilePicture').set(base64String)
                    .then(() => showToast("Profile picture updated!"))
                    .catch(err => showToast("Error updating picture: " + err.message));
            };
            reader.readAsDataURL(file);
        };

        document.querySelector('.bottom-nav').addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                showScreen(navItem.dataset.screen);
                if(navItem.dataset.screen === 'analyticsScreen') {
                    renderSpendAnalytics();
                }
            }
        });

        document.getElementById('topupBtn').addEventListener('click', () => {
            const amount = prompt("Enter amount to request for top-up:", "500");
            if (amount && !isNaN(amount) && amount > 0) {
                const reqId = db.ref().child('topupRequests').push().key;
                const txnId = db.ref().child('transactions').push().key;

                const requestData = {
                    userId: currentUser.uid,
                    userName: currentUserData.name,
                    amount: parseFloat(amount),
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    transactionId: txnId
                };
                
                const transactionData = {
                    type: 'TOPUP',
                    amount: parseFloat(amount),
                    to: currentUser.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending',
                    description: 'Wallet Top-up Request'
                };

                const updates = {};
                updates['/topupRequests/' + reqId] = requestData;
                updates['/transactions/' + txnId] = transactionData;
                
                db.ref().update(updates)
                    .then(() => showToast('Top-up request sent for approval.'))
                    .catch(err => showToast(`Error: ${err.message}`));
            }
        });

        document.getElementById('withdrawMenu').addEventListener('click', () => {
            const content = `
                <p>Enter the amount and your UPI ID. The request will be sent to an admin for approval.</p>
                <div class="input-group">
                    <label>Amount (₹)</label>
                    <input type="number" id="withdrawAmount" class="input-field" placeholder="e.g., 500">
                </div>
                <div class="input-group">
                    <label>UPI ID</label>
                    <input type="text" id="withdrawUpiId" class="input-field" placeholder="e.g., yourname@bank">
                </div>
                <button id="withdrawConfirmBtn" class="btn btn-primary">Request Withdrawal</button>
            `;
            openModal('Withdraw Funds', content);

            document.getElementById('withdrawConfirmBtn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const upiId = document.getElementById('withdrawUpiId').value;
                const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;

                if (isNaN(amount) || amount <= 0) {
                    showToast("Please enter a valid amount."); return;
                }
                if (amount > currentUserData.walletBalance) {
                    showToast("Withdrawal amount cannot exceed your balance."); return;
                }
                if (!upiId || !upiRegex.test(upiId)) {
                    showToast("Please enter a valid UPI ID."); return;
                }

                showAnimationOverlay('Submitting request...');
                const reqId = db.ref().child('withdrawalRequests').push().key;
                const txnId = db.ref().child('transactions').push().key;
                const requestData = {
                    userId: currentUser.uid, userName: currentUserData.name, amount: amount,
                    upiId: upiId, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP,
                    transactionId: txnId
                };
                const transactionData = {
                    type: 'WITHDRAWAL', amount: amount, from: currentUser.uid,
                    description: `Withdrawal to ${upiId}`, timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending'
                };
                const updates = {};
                updates['/withdrawalRequests/' + reqId] = requestData;
                updates['/transactions/' + txnId] = transactionData;
                
                db.ref().update(updates)
                    .then(() => {
                        closeModal();
                        showSuccessAnimation('Withdrawal request sent!');
                    })
                    .catch(err => showFailAnimation(`Error: ${err.message}`));
            });
        });

        const initiateP2PTransfer = () => {
            const content = `
                <div class="input-group">
                    <label>Recipient Phone Number</label>
                    <input type="tel" id="recipientPhone" class="input-field">
                </div>
                <div class="input-group">
                    <label>Amount (₹)</label>
                    <input type="number" id="transferAmount" class="input-field">
                </div>
                <div class="input-group">
                    <label>Description (Optional)</label>
                    <input type="text" id="transferDescription" class="input-field">
                </div>
                <button id="sendMoneyConfirmBtn" class="btn btn-primary">Send Money</button>
            `;
            openModal('Transfer Money', content);

            document.getElementById('sendMoneyConfirmBtn').addEventListener('click', () => {
                const recipientPhone = document.getElementById('recipientPhone').value;
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const description = document.getElementById('transferDescription').value || 'P2P Transfer';
                
                if(!recipientPhone || isNaN(amount) || amount <= 0) {
                    showToast("Please fill all fields correctly."); return;
                }
                if(amount > currentUserData.walletBalance) {
                    showToast("Insufficient balance."); return;
                }

                closeModal();
                openPinModal((pin) => {
                    if (pin === currentUserData.pin) {
                        performP2PTransfer(recipientPhone, amount, description);
                    } else {
                        showFailAnimation("Incorrect PIN. Transaction failed.");
                    }
                });
            });
        };

        const performP2PTransfer = (recipientPhone, amount, description) => {
            showAnimationOverlay('Sending money...');
            db.ref('users').orderByChild('phone').equalTo(recipientPhone).once('value', snapshot => {
                if(!snapshot.exists()) { 
                    showFailAnimation("Recipient not found."); 
                    return; 
                }

                const recipientUid = Object.keys(snapshot.val())[0];
                const recipientData = snapshot.val()[recipientUid];

                if(recipientUid === currentUser.uid) { 
                    showFailAnimation("You cannot send money to yourself."); 
                    return; 
                }

                const transactionData = {
                    from: currentUser.uid, to: recipientUid, fromName: currentUserData.name, toName: recipientData.name,
                    amount: amount, description: description, type: 'P2P',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                const highValueThreshold = 10000;
                if (amount >= highValueThreshold) {
                    transactionData.status = 'pending_approval';
                    const txnId = db.ref().child('transactions').push().key;
                    const updates = {};
                    updates[`/transactions/${txnId}`] = transactionData;
                    updates[`/highValueTransfers/${txnId}`] = {
                        from: currentUser.uid, to: recipientUid, fromName: currentUserData.name,
                        toName: recipientData.name, amount: amount
                    };
                    db.ref().update(updates)
                        .then(() => showSuccessAnimation('High-value transfer submitted for approval.'))
                        .catch(err => showFailAnimation(`Error: ${err.message}`));
                    return;
                }
                
                transactionData.status = 'completed';
                const newSenderBalance = currentUserData.walletBalance - amount;
                const newRecipientBalance = recipientData.walletBalance + amount;
                const txnId = db.ref().child('transactions').push().key;

                const updates = {};
                updates['/users/' + currentUser.uid + '/walletBalance'] = newSenderBalance;
                updates['/users/' + recipientUid + '/walletBalance'] = newRecipientBalance;
                updates['/transactions/' + txnId] = transactionData;
                updates[`/notifications/${recipientUid}/${db.ref().push().key}`] = {
                    message: `You received ₹${amount} from ${currentUserData.name}.`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP, read: false
                };
                db.ref().update(updates)
                    .then(() => showSuccessAnimation(`₹${amount} sent to ${recipientData.name}!`))
                    .catch(err => showFailAnimation(`Transaction failed: ${err.message}`));
            });
        };
        
        document.getElementById('sendMoneyHomeBtn').addEventListener('click', initiateP2PTransfer);
        document.getElementById('transferMoneyMenu').addEventListener('click', initiateP2PTransfer);

        document.getElementById('receiveMoneyMenu').addEventListener('click', () => {
            const qrData = JSON.stringify({ phone: currentUserData.phone, name: currentUserData.name });
            const content = `<div id="qrCodeContainer"><p>Scan this QR code to receive money.</p><div id="qrCodeImage"></div><h4>${currentUserData.name}</h4><p>${currentUserData.phone}</p></div>`;
            openModal('Receive Money', content);
            new QRCode(document.getElementById("qrCodeImage"), { text: qrData, width: 200, height: 200 });
        });
        
        const processScannedData = (qrData) => {
            closeModal();
            if (qrData) {
                try {
                    const data = JSON.parse(qrData);
                    if (data.phone) {
                        const recipientName = data.name || data.phone;
                        const amount = prompt(`Enter amount to pay to ${recipientName}:`);
                        if (amount && !isNaN(amount) && amount > 0) {
                            openPinModal((pin) => {
                                if (pin === currentUserData.pin) {
                                    performP2PTransfer(data.phone, parseFloat(amount), "QR Payment");
                                } else {
                                    showFailAnimation("Incorrect PIN. Transaction failed.");
                                }
                            });
                        }
                    } else { showToast("Invalid QR code data."); }
                } catch (e) { showToast("Failed to parse QR data."); }
            }
        };

        document.getElementById('scanPayMenu').addEventListener('click', () => {
            scannerModal.classList.add('active');
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop()
                        .then(() => {
                            processScannedData(decodedText);
                        })
                        .catch(err => console.error("QR Code stop error", err));
                }
            };
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            Html5Qrcode.getCameras().then(cameras => {
                if (cameras && cameras.length) {
                    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                        .catch(err => {
                            console.error("QR Scanner start error:", err);
                            showToast("Failed to start scanner. Please try again.");
                            closeModal();
                        });
                } else {
                    showToast("No camera found on this device.");
                    closeModal();
                }
            }).catch(err => {
                showToast("Camera permission may be denied.");
                console.error("Camera access error:", err);
                closeModal();
            });
        });

        // --- CHAT AND USER LIST LOGIC ---
        const loadUserList = () => {
            const container = document.getElementById('userListContainer');
            db.ref('users').on('value', snapshot => {
                container.innerHTML = ''; 

                const adminPicElement = `<div class="user-grid-pic"><i class="fas fa-user-tie"></i></div>`;
                const adminItem = `
                    <div class="user-grid-item" data-uid="admin" data-name="Admin Help" data-pic="">
                        ${adminPicElement}
                        <span>Admin Help</span>
                    </div>`;
                container.innerHTML += adminItem;

                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const uid = childSnapshot.key;
                    if (uid === currentUser.uid || user.role === 'admin') return;

                    // MODIFIED: Generate icon or image based on profilePicture existence
                    const userPicUrl = user.profilePicture || '';
                    const picElement = userPicUrl 
                        ? `<img src="${userPicUrl}" alt="${user.name}">` 
                        : `<i class="fas fa-user-tie"></i>`;

                    const userItem = `
                        <div class="user-grid-item" data-uid="${uid}" data-name="${user.name}" data-pic="${userPicUrl}">
                            <div class="user-grid-pic">
                                ${picElement}
                            </div>
                            <span>${user.name.split(' ')[0]}</span>
                        </div>`;
                    container.innerHTML += userItem;
                });
            });
        };

        document.getElementById('userListContainer').addEventListener('click', (e) => {
            const userItem = e.target.closest('.user-grid-item');
            if (userItem) {
                const uid = userItem.dataset.uid;
                const name = userItem.dataset.name;
                const pic = userItem.dataset.pic;
                openChatScreen(uid, name, pic);
            }
        });

        const openChatScreen = (otherUserId, otherUserName, otherUserPic) => {
            showScreen('chatScreen');

            document.getElementById('chatUserName').textContent = otherUserName;
            
            // MODIFIED: Use helper function to set chat profile picture or icon
            const chatPicContainer = document.getElementById('chatUserPicContainer');
            setProfilePicture(chatPicContainer, otherUserPic);
            
            const payBtn = document.getElementById('chatPayBtn');
            payBtn.style.display = (otherUserId === 'admin') ? 'none' : 'block';

            payBtn.onclick = () => {
                if (otherUserId === 'admin') return;
                
                db.ref('users/' + otherUserId).once('value', snapshot => {
                    if (!snapshot.exists()) { showToast("Recipient not found."); return; }
                    const recipientData = snapshot.val();
                    const recipientPhone = recipientData.phone;
                    
                    const modalContent = `
                        <div class="payment-modal-content">
                            <p>You are paying <strong>${otherUserName}</strong></p>
                            <div class="modern-payment-input-container">
                                <span class="currency-symbol">₹</span>
                                <input type="number" id="modernPaymentAmount" class="modern-payment-input" placeholder="0" inputmode="numeric" pattern="[0-9]*">
                            </div>
                            <button id="confirmPaymentBtn" class="btn btn-primary">Proceed to Pay</button>
                        </div>
                    `;
                    openModal(`Send Money`, modalContent);

                    const amountInput = document.getElementById('modernPaymentAmount');
                    amountInput.focus();

                    document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
                        const amount = parseFloat(amountInput.value);

                        if (isNaN(amount) || amount <= 0) {
                            showToast("Please enter a valid amount.");
                            return;
                        }
                        if (amount > currentUserData.walletBalance) {
                            showToast("Insufficient balance.");
                            return;
                        }
                        
                        closeModal();
                        openPinModal((pin) => {
                            if (pin === currentUserData.pin) {
                                performP2PTransfer(recipientPhone, amount, "Payment from chat");
                            } else {
                                showFailAnimation("Incorrect PIN. Transaction failed.");
                            }
                        });
                    });
                });
            };

            currentChatId = (otherUserId === 'admin') ? 
                (currentUser.uid + '_admin') : 
                ([currentUser.uid, otherUserId].sort().join('_'));

            loadAndListenForChat(currentChatId, otherUserId);

            document.getElementById('sendMessageBtn').onclick = () => {
                const messageInput = document.getElementById('chatMessageInput');
                const text = messageInput.value.trim();
                if (text) {
                    const message = { senderId: currentUser.uid, text: text, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    db.ref('chats/' + currentChatId).push(message);
                    messageInput.value = '';
                }
            };
            
            document.getElementById('chatMessageInput').onkeyup = (event) => {
                if (event.key === 'Enter') {
                    document.getElementById('sendMessageBtn').click();
                }
            };

            document.getElementById('chatBackBtn').onclick = () => showScreen('homeScreen');
        };
        
        const renderChatItem = (item, container) => {
            const chatBody = document.getElementById('chatBody');
            const el = document.createElement('div');

            if (item.itemType === 'message') {
                const isSent = item.senderId === currentUser.uid;
                el.classList.add('message-bubble', isSent ? 'message-sent' : 'message-received');
                const messageDate = new Date(item.timestamp).toLocaleString([], { hour: '2-digit', minute: '2-digit' });
                el.innerHTML = `
                    <span>${item.text}</span>
                    <span class="message-timestamp">${messageDate}</span>`;
            } else if (item.itemType === 'transaction') {
                 el.classList.add('message-system');
                 let summaryText = '';
                 if (item.status === 'completed') {
                    summaryText = (item.from === currentUser.uid) ? `You sent ₹${item.amount.toFixed(2)}` : `You received ₹${item.amount.toFixed(2)}`;
                 } else {
                    summaryText = `Transaction of ₹${item.amount.toFixed(2)} is ${item.status.replace('_', ' ')}`;
                 }
                 const date = new Date(item.timestamp).toLocaleDateString();
                 el.textContent = `${summaryText} on ${date}`;
            }

            container.appendChild(el);
            chatBody.scrollTop = chatBody.scrollHeight;
        };
        
        const loadAndListenForChat = (chatId, otherUserId) => {
            detachChatListener();
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            let initialItemsLoaded = false;
            let lastTimestamp = 0;

            let mergedItems = [];
            const relevantTxns = (otherUserId === 'admin') ? [] : allTransactions.filter(txn => 
                txn.type === 'P2P' &&
                ((txn.from === currentUser.uid && txn.to === otherUserId) || (txn.to === currentUser.uid && txn.from === otherUserId))
            );
            relevantTxns.forEach(txn => mergedItems.push({ ...txn, itemType: 'transaction' }));
            
            const chatRef = db.ref('chats/' + chatId);
            chatRef.orderByChild('timestamp').once('value', snapshot => {
                snapshot.forEach(child => {
                    mergedItems.push({ ...child.val(), itemType: 'message' });
                });

                mergedItems.sort((a, b) => a.timestamp - b.timestamp);
                mergedItems.forEach(item => renderChatItem(item, messagesContainer));
                
                lastTimestamp = mergedItems.length > 0 ? mergedItems[mergedItems.length - 1].timestamp : 0;
                initialItemsLoaded = true;

                currentChatListener = chatRef.orderByChild('timestamp').startAt(lastTimestamp + 1).on('child_added', newMessageSnapshot => {
                    if (initialItemsLoaded) {
                        const message = newMessageSnapshot.val();
                        renderChatItem({ ...message, itemType: 'message' }, messagesContainer);
                    }
                });
            });
        };

        let allTransactions = [];
        const listenForTransactions = () => {
            db.ref('transactions').orderByChild('timestamp').on('value', snapshot => {
                allTransactions = [];
                snapshot.forEach(childSnapshot => {
                    const txn = childSnapshot.val();
                    if(txn.from === currentUser.uid || txn.to === currentUser.uid || (txn.type === 'TOPUP' && txn.userId === currentUser.uid)) {
                        allTransactions.push({id: childSnapshot.key, ...txn});
                    }
                });
                allTransactions.reverse(); 
                renderTransactionHistory();
            });
        };
        
        const renderTransactionHistory = () => {
            const listEl = document.getElementById('transactionList');
            const typeFilter = document.getElementById('historyFilterType').value;
            const dateFilter = document.getElementById('historyFilterDate').value;
            let filtered = allTransactions;
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }
            if (dateFilter !== 'all') {
                const daysAgo = new Date();
                daysAgo.setDate(daysAgo.getDate() - parseInt(dateFilter));
                filtered = filtered.filter(t => t.timestamp > daysAgo.getTime());
            }

            if(filtered.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888;">No transactions found.</p>';
                return;
            }

            listEl.innerHTML = filtered.map(txn => {
                const date = new Date(txn.timestamp).toLocaleString();
                let direction = 'received', icon = 'R', amountClass = 'received', description = `From ${txn.fromName || 'System'}`;
                
                if (txn.from === currentUser.uid) {
                    direction = 'sent'; icon = 'S'; amountClass = 'sent'; description = `To ${txn.toName || 'Merchant'}`;
                }
                if (txn.type === 'TOPUP') { direction = 'topup'; icon = 'T'; description = 'Wallet Top-up'; amountClass = 'received'; }
                if (txn.type === 'BILL') { direction = 'bill'; icon = 'B'; description = txn.description; amountClass = 'sent'; }
                if (txn.type === 'CASHBACK') { direction = 'received'; icon = 'C'; description = 'Cashback Received'; }
                if (txn.type === 'WITHDRAWAL') { direction = 'sent'; icon = 'W'; description = txn.description; }
                
                const amountSign = (direction === 'sent' || txn.type === 'BILL' || txn.type === 'WITHDRAWAL') ? '-' : '+';
                
                return `
                    <div class="transaction-item">
                        <div class="txn-icon ${direction}">${icon}</div>
                        <div class="txn-details">
                            <p class="txn-description">${description}</p>
                            <p class="txn-date">${date}</p>
                        </div>
                        <div class="txn-amount-container">
                            <span class="txn-amount ${amountClass}">${amountSign} ₹${txn.amount.toFixed(2)}</span>
                            ${txn.status !== 'completed' ? `<span class="txn-status ${txn.status.replace('_', ' ')}">${txn.status.replace('_', ' ')}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        };
        document.getElementById('historyFilterType').addEventListener('change', renderTransactionHistory);
        document.getElementById('historyFilterDate').addEventListener('change', renderTransactionHistory);

        const renderSpendAnalytics = () => {
            const ctx = document.getElementById('spendChart').getContext('2d');
            const spendData = { 'P2P Sent': 0, 'Bill Payments': 0, 'Withdrawals': 0 };
            allTransactions.forEach(txn => {
                if (txn.from === currentUser.uid && txn.status === 'completed') {
                    if (txn.type === 'P2P') spendData['P2P Sent'] += txn.amount;
                    else if (txn.type === 'BILL') spendData['Bill Payments'] += txn.amount;
                    else if (txn.type === 'WITHDRAWAL') spendData['Withdrawals'] += txn.amount;
                }
            });
            if (spendChartInstance) spendChartInstance.destroy();
            spendChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(spendData), datasets: [{ label: 'Spend by Category', data: Object.values(spendData), backgroundColor: ['#6739B7', '#3E8BFF', '#E74C3C'], borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Your Spending Breakdown' } } } });
        };
        
        const listenForNotifications = () => {
             db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(10).on('value', snapshot => {
                snapshot.forEach(child => {
                    const notif = child.val();
                    if (!notif.read) {
                        showToast(notif.message);
                        db.ref(`notifications/${currentUser.uid}/${child.key}/read`).set(true);
                    }
                });
             });
        };
        
        const pinInputs = pinModal.querySelectorAll('.pin-digit');
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                if (input.value && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !input.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
                if (!/^[0-9]$/.test(e.key) && !['Backspace', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) {
                     e.preventDefault();
                }
            });

            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const digits = paste.replace(/\D/g, '');
                
                if (digits) {
                    for (let i = 0; i < digits.length; i++) {
                        if (index + i < pinInputs.length) {
                            pinInputs[index + i].value = digits[i];
                        }
                    }
                }
                
                const lastFilledIndex = Math.min(index + digits.length, pinInputs.length);
                if (pinInputs[lastFilledIndex - 1]) {
                    pinInputs[lastFilledIndex - 1].focus();
                }
            });
        });

        document.getElementById('pinConfirmBtn').addEventListener('click', () => {
            const pin = Array.from(pinInputs).map(i => i.value).join('');
            if(pin.length === 4 && currentPinCallback) {
                closeModal();
                currentPinCallback(pin);
            } else {
                showToast("Please enter a 4-digit PIN.");
            }
        });

        // --- Admin Panel Logic ---
        const initializeAdminPanel = () => {
            document.getElementById('adminName').textContent = currentUserData.name;
            loadAdminStats();
            loadAdminUsers();
            loadPendingApprovals();
            loadPendingTopups();
            loadPendingWithdrawals();
            loadAppConfig();
        };

        const loadAdminStats = () => {
            db.ref('users').on('value', snapshot => {
                document.getElementById('adminTotalUsers').textContent = snapshot.numChildren();
            });
            db.ref('transactions').on('value', snapshot => {
                let totalValue = 0;
                snapshot.forEach(child => {
                    if (child.val().status === 'completed') totalValue += child.val().amount || 0;
                });
                document.getElementById('adminTotalTxnValue').textContent = `₹ ${totalValue.toLocaleString()}`;
            });
        };

        const loadAdminUsers = () => {
            db.ref('users').on('value', snapshot => {
                const tableBody = document.getElementById('adminUsersTable').querySelector('tbody');
                tableBody.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const uid = childSnapshot.key;
                    if (user.role !== 'admin') {
                        const row = `<tr><td>${user.name}</td><td>${user.email}</td><td>₹${user.walletBalance.toFixed(2)}</td><td><button class="btn btn-secondary" onclick="adjustBalance('${uid}')">Adjust</button><button class="btn ${user.isBlocked ? 'btn-primary' : 'btn-secondary'}" onclick="toggleBlockUser('${uid}', ${user.isBlocked})">${user.isBlocked ? 'Unblock' : 'Block'}</button></td></tr>`;
                        tableBody.innerHTML += row;
                    }
                });
            });
        };
        
        const loadPendingApprovals = () => {
            db.ref('highValueTransfers').on('value', snapshot => {
                const container = document.getElementById('adminPendingApprovals');
                container.innerHTML = '';
                if (!snapshot.exists()) {
                    container.innerHTML = '<p>No pending approvals.</p>';
                    return;
                }
                snapshot.forEach(child => {
                    const req = child.val();
                    const txnId = child.key;
                    container.innerHTML += `<div class="transaction-item"><div class="txn-details" style="flex-grow:1;"><p><strong>From:</strong> ${req.fromName} to ${req.toName}</p><p><strong>Amount:</strong> ₹${req.amount.toFixed(2)}</p></div><div><button class="btn btn-primary" onclick="approveTransfer('${txnId}')">Approve</button><button class="btn btn-secondary" onclick="declineTransfer('${txnId}')">Decline</button></div></div>`;
                });
            });
        };

        const loadAppConfig = () => {
            db.ref('config/cashbackRules').on('value', snapshot => {
                const rules = snapshot.val();
                if (rules) {
                    document.getElementById('adminCashbackMin').value = rules.rechargeMin || '';
                    document.getElementById('adminCashbackPercent').value = rules.rechargePercent || '';
                }
            });
        };
        document.getElementById('adminUpdateAnnouncement').addEventListener('click', () => {
            const text = document.getElementById('adminAnnouncement').value;
            if (!text) { showToast("Announcement text cannot be empty."); return; }
            db.ref('users').once('value', snapshot => {
                const updates = {};
                snapshot.forEach(child => {
                    const uid = child.key;
                    if(child.val().role !== 'admin'){
                        updates[`/notifications/${uid}/${db.ref().push().key}`] = {
                            message: `📢 Announcement: ${text}`,
                            timestamp: firebase.database.ServerValue.TIMESTAMP, read: false
                        };
                    }
                });
                db.ref().update(updates).then(() => showToast("Announcement broadcasted to all users."));
                document.getElementById('adminAnnouncement').value = '';
            });
        });
        document.getElementById('adminUpdateCashback').addEventListener('click', () => {
            const min = parseFloat(document.getElementById('adminCashbackMin').value);
            const percent = parseFloat(document.getElementById('adminCashbackPercent').value);
            if (isNaN(min) || isNaN(percent) || min < 0 || percent < 0) { showToast("Please enter valid positive numbers for cashback rules."); return; }
            db.ref('config/cashbackRules').set({ rechargeMin: min, rechargePercent: percent })
                .then(() => showToast("Cashback rules updated."));
        });
        
        const loadPendingTopups = () => {
            db.ref('topupRequests').orderByChild('status').equalTo('pending').on('value', snapshot => {
                const container = document.getElementById('adminPendingTopups');
                container.innerHTML = '';
                if (!snapshot.exists()) { container.innerHTML = '<p>No pending top-up requests.</p>'; return; }
                snapshot.forEach(child => {
                    const req = child.val(); const key = child.key;
                    container.innerHTML += `<div class="transaction-item"><div class="txn-details" style="flex-grow:1;"><p><strong>User:</strong> ${req.userName}</p><p><strong>Amount:</strong> ₹${req.amount.toFixed(2)}</p></div><div><button class="btn btn-primary" onclick="approveTopup('${key}')">Approve</button><button class="btn btn-secondary" onclick="declineTopup('${key}')">Decline</button></div></div>`;
                });
            });
        };
        
        const loadPendingWithdrawals = () => {
            db.ref('withdrawalRequests').orderByChild('status').equalTo('pending').on('value', snapshot => {
                const container = document.getElementById('adminPendingWithdrawals');
                container.innerHTML = '';
                if (!snapshot.exists()) { container.innerHTML = '<p>No pending withdrawal requests.</p>'; return; }
                snapshot.forEach(child => {
                    const req = child.val(); const key = child.key;
                    container.innerHTML += `<div class="transaction-item"><div class="txn-details" style="flex-grow:1;"><p><strong>User:</strong> ${req.userName}</p><p><strong>Amount:</strong> ₹${req.amount.toFixed(2)}</p><p><strong>UPI:</strong> ${req.upiId}</p></div><div><button class="btn btn-primary" onclick="approveWithdrawal('${key}')">Approve</button><button class="btn btn-secondary" onclick="declineWithdrawal('${key}')">Decline</button></div></div>`;
                });
            });
        };

        window.approveTopup = (key) => {
            const reqRef = db.ref('topupRequests/' + key);
            reqRef.once('value', snapshot => {
                if (!snapshot.exists()) return;
                const req = snapshot.val();
                db.ref(`users/${req.userId}/walletBalance`).transaction(balance => (balance || 0) + req.amount);
                const updates = {};
                updates[`/transactions/${req.transactionId}/status`] = 'completed';
                updates[`/notifications/${req.userId}/${db.ref().push().key}`] = { message: `Your top-up request of ₹${req.amount} has been approved.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };
                db.ref().update(updates).then(() => { showToast('Top-up approved.'); reqRef.remove(); });
            });
        };
        window.declineTopup = (key) => {
            const reqRef = db.ref('topupRequests/' + key);
            reqRef.once('value', snapshot => {
                if (!snapshot.exists()) return;
                const req = snapshot.val();
                const updates = {};
                updates[`/transactions/${req.transactionId}/status`] = 'declined';
                updates[`/notifications/${req.userId}/${db.ref().push().key}`] = { message: `Your top-up request of ₹${req.amount} has been declined.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };
                db.ref().update(updates).then(() => { showToast('Top-up declined.'); reqRef.remove(); });
            });
        };

        window.approveWithdrawal = (key) => {
            const reqRef = db.ref('withdrawalRequests/' + key);
            reqRef.once('value', snapshot => {
                if (!snapshot.exists()) return;
                const req = snapshot.val();
                db.ref(`users/${req.userId}/walletBalance`).transaction(balance => {
                    return (balance >= req.amount) ? balance - req.amount : undefined;
                }, (error, committed) => {
                    if (error) { showToast('Transaction failed: ' + error); }
                    else if (committed) {
                        const updates = {};
                        updates[`/transactions/${req.transactionId}/status`] = 'completed';
                        updates[`/notifications/${req.userId}/${db.ref().push().key}`] = { message: `Your withdrawal of ₹${req.amount} has been approved.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };
                        db.ref().update(updates).then(() => { showToast('Withdrawal approved.'); reqRef.remove(); });
                    } else { showToast('Withdrawal failed: Insufficient user balance.'); }
                });
            });
        };
        window.declineWithdrawal = (key) => {
            const reqRef = db.ref('withdrawalRequests/' + key);
            reqRef.once('value', snapshot => {
                if (!snapshot.exists()) return;
                const req = snapshot.val();
                const updates = {};
                updates[`/transactions/${req.transactionId}/status`] = 'declined';
                updates[`/notifications/${req.userId}/${db.ref().push().key}`] = { message: `Your withdrawal of ₹${req.amount} was declined.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };
                db.ref().update(updates).then(() => { showToast('Withdrawal declined.'); reqRef.remove(); });
            });
        };

        window.adjustBalance = (uid) => {
            const newAmount = prompt("Enter new wallet balance for this user:");
            if (newAmount && !isNaN(newAmount)) {
                db.ref(`users/${uid}/walletBalance`).set(parseFloat(newAmount)).then(() => showToast('Balance updated.'));
            }
        };

        window.toggleBlockUser = (uid, isBlocked) => {
            db.ref(`users/${uid}/isBlocked`).set(!isBlocked).then(() => showToast(`User ${!isBlocked ? 'blocked' : 'unblocked'}.`));
        };
        
        window.approveTransfer = (txnId) => {
            db.ref('transactions/' + txnId).once('value', txnSnapshot => {
                if (!txnSnapshot.exists() || txnSnapshot.val().status !== 'pending_approval') { showToast("Transaction not found or already processed."); return; }
                const txnData = txnSnapshot.val();

                db.ref('users/' + txnData.from + '/walletBalance').transaction(balance => {
                    if (balance >= txnData.amount) { return balance - txnData.amount; } return undefined;
                }, (error, committed) => {
                    if (error) { showToast("Sender balance update failed: " + error); return; }
                    if (!committed) { showToast('Sender has insufficient funds. Transaction declined.'); declineTransfer(txnId); return; }
                    
                    db.ref('users/' + txnData.to + '/walletBalance').transaction(balance => (balance || 0) + txnData.amount);
                    
                    const updates = {};
                    updates[`/transactions/${txnId}/status`] = 'completed';
                    updates[`/notifications/${txnData.from}/${db.ref().push().key}`] = { message: `Your transfer of ₹${txnData.amount} to ${txnData.toName} was approved.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };
                    updates[`/notifications/${txnData.to}/${db.ref().push().key}`] = { message: `You received ₹${txnData.amount} from ${txnData.fromName}.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };

                    db.ref().update(updates).then(() => {
                        showToast('Transfer approved.');
                        db.ref('highValueTransfers/' + txnId).remove();
                    });
                });
            });
        };
        window.declineTransfer = (txnId) => {
            db.ref('transactions/' + txnId).once('value', snapshot => {
                if (!snapshot.exists()) return;
                const txnData = snapshot.val();
                const updates = {};
                updates[`/transactions/${txnId}/status`] = 'declined';
                updates[`/notifications/${txnData.from}/${db.ref().push().key}`] = { message: `Your high-value transfer of ₹${txnData.amount} was declined by admin.`, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false };

                db.ref().update(updates).then(() => {
                    showToast('Transfer declined.');
                    db.ref('highValueTransfers/' + txnId).remove();
                });
            });
        };
        
        document.querySelectorAll('.close-modal').forEach(el => el.addEventListener('click', closeModal));
        document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        }));

        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode', themeToggle.checked);
            localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
        });
        
        if(localStorage.getItem('theme') === 'dark') {
            themeToggle.checked = true;
            document.body.classList.add('dark-mode');
        }
    });
    </script>
</body>
</html>
