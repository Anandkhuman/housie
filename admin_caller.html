<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Manual Caller</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
    /* Using styles from the main dashboard for consistency */
    :root {
        --primary-bg-dash: #2c3e50; /* Wet Asphalt */
        --secondary-bg-dash: #34495e; /* Midnight Blue */
        --accent-color-dash: #1abc9c; /* Green Sea */
        --success-color-dash: #2ecc71; /* Emerald */
        --error-color-dash: #e74c3c; /* Alizarin */
        --muted-color-dash: #7f8c8d;  /* Asbestos */
        --light-text-dash: #ecf0f1;   /* Clouds */
        --font-family-ui: 'Rajdhani', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: var(--font-family-ui);
        color: var(--light-text-dash);
        background-color: var(--primary-bg-dash);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        text-align: center;
        padding: 1rem;
    }

    #loading-screen, #access-denied {
        display: none;
    }

    #caller-container {
        display: none; /* Hidden by default until auth check passes */
        width: 100%;
        max-width: 500px;
        background-color: var(--secondary-bg-dash);
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        border-top: 5px solid var(--accent-color-dash);
    }

    .caller-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--light-text-dash);
    }

    .caller-subtitle {
        font-size: 1rem;
        margin-bottom: 2rem;
        color: var(--muted-color-dash);
    }

    .input-group {
        margin-bottom: 1.5rem;
    }

    .number-input {
        width: 100%;
        height: 60px;
        font-size: 2.5rem;
        text-align: center;
        font-family: var(--font-family-ui);
        font-weight: 700;
        background-color: var(--primary-bg-dash);
        border: 2px solid var(--muted-color-dash);
        color: var(--light-text-dash);
        border-radius: 6px;
        outline: none;
        transition: border-color 0.3s;
    }
    .number-input:focus {
        border-color: var(--accent-color-dash);
    }
    .number-input::-webkit-outer-spin-button,
    .number-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .number-input[type=number] {
        -moz-appearance: textfield;
    }


    .call-button {
        width: 100%;
        padding: 1rem;
        font-size: 1.2rem;
        font-weight: 700;
        letter-spacing: 1px;
        font-family: var(--font-family-ui);
        color: var(--primary-bg-dash);
        background-color: var(--accent-color-dash);
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }
    .call-button:hover:not(:disabled) {
        background-color: #1fe0b3;
        transform: translateY(-2px);
    }
    .call-button:disabled {
        background-color: var(--muted-color-dash);
        cursor: not-allowed;
    }

    .status-display {
        min-height: 120px;
        margin-top: 2rem;
        padding: 1rem;
        border: 2px dashed var(--muted-color-dash);
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: border-color 0.5s ease;
    }
    .status-display.success {
        border-color: var(--success-color-dash);
    }

    .count-up-timer {
        font-size: 4rem;
        font-weight: 700;
        color: var(--light-text-dash);
        margin-top: 0.5rem;
        display: none; /* Hidden by default */
    }

    .status-text {
        font-size: 1.1rem;
        color: var(--light-text-dash);
    }
    .status-text .error {
        color: var(--error-color-dash);
        font-weight: 600;
    }
     .status-text .success {
        color: var(--success-color-dash);
        font-weight: 600;
    }

    .logout-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: 1px solid var(--muted-color-dash);
        color: var(--muted-color-dash);
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .logout-button:hover {
        background-color: var(--error-color-dash);
        border-color: var(--error-color-dash);
        color: var(--light-text-dash);
    }

</style>
</head>
<body>

<!-- Main container for the caller interface -->
<div id="caller-container">
    <h1 class="caller-title">Manual Caller</h1>
    <p class="caller-subtitle">Enter a number and click call to announce it instantly.</p>

    <div class="input-group">
        <input type="number" id="numberInput" class="number-input" min="1" max="90" placeholder="1-90">
    </div>

    <button id="callButton" class="call-button">CALL NUMBER</button>

    <div class="status-display" id="statusDisplay">
        <p class="status-text" id="statusText">Waiting for a number...</p>
        <div class="count-up-timer" id="countUpTimer">00:00</div>
    </div>

    <button id="logoutButton" class="logout-button">Logout</button>
</div>

<!-- Screen for loading state -->
<div id="loading-screen">
    <h1><i class="fas fa-spinner fa-spin"></i> Verifying Admin Access...</h1>
</div>

<!-- Screen for unauthorized access -->
<div id="access-denied">
    <h1>Access Denied</h1>
    <p>You must be logged in as an admin to use this page. Redirecting...</p>
</div>


<script>
// =================================================================================
// PASTE YOUR FIREBASE CONFIGURATION HERE (Same as your main file)
// =================================================================================
const firebaseConfig = {
  apiKey: "AIzaSyB2imEIvh_bWbYD_yPB7p3af7bV9OWdA5A",
  authDomain: "sinthahousie-1dd3b.firebaseapp.com",
  databaseURL: "https://sinthahousie-1dd3b-default-rtdb.firebaseio.com",
  projectId: "sinthahousie-1dd3b",
  storageBucket: "sinthahousie-1dd3b.firebasestorage.app",
  messagingSenderId: "76567991256",
  appId: "1:76567991256:web:c58b127b8d86d8a1c598ad",
  measurementId: "G-MGW406NKBY"
};

// --- INITIALIZATION ---
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// --- UI ELEMENTS ---
const loadingScreen = document.getElementById('loading-screen');
const accessDeniedScreen = document.getElementById('access-denied');
const callerContainer = document.getElementById('caller-container');
const numberInput = document.getElementById('numberInput');
const callButton = document.getElementById('callButton');
const statusDisplay = document.getElementById('statusDisplay');
const statusText = document.getElementById('statusText');
const countUpTimer = document.getElementById('countUpTimer');
const logoutButton = document.getElementById('logoutButton');

// --- GLOBAL STATE ---
let countUpInterval = null; // For the new count-up timer
let secondsSinceLastCall = 0;
let gameStateCache = {};
let allTicketsData = [];
let gameSettingsData = {};

// --- AUTHENTICATION ---
auth.onAuthStateChanged(async (user) => {
    callerContainer.style.display = 'none';
    accessDeniedScreen.style.display = 'none';
    loadingScreen.style.display = 'block';

    if (user) {
        try {
            const userSnapshot = await db.ref('users/' + user.uid).once('value');
            const userData = userSnapshot.val();
            
            if (userData && userData.role === 'admin') {
                loadingScreen.style.display = 'none';
                callerContainer.style.display = 'block';
                setupRealtimeListeners();
            } else {
                throw new Error("User is not an admin.");
            }
        } catch (error) {
            await auth.signOut();
            showAccessDenied();
        }
    } else {
        showAccessDenied();
    }
});

function showAccessDenied() {
    loadingScreen.style.display = 'none';
    accessDeniedScreen.style.display = 'block';
    setTimeout(() => {
        window.location.href = 'index.html'; // Redirect to your main game page
    }, 3000);
}

// --- DATA LISTENERS ---
function setupRealtimeListeners() {
    db.ref('gameState/currentState').on('value', snapshot => {
        gameStateCache = snapshot.val() || { calledNumbers: [], winners: {} };
    });
    db.ref('tickets').on('value', snapshot => {
        const ticketsObject = snapshot.val();
        allTicketsData = ticketsObject ? Object.values(ticketsObject) : [];
    });
    db.ref('settings/gameConfig').on('value', snapshot => {
        gameSettingsData = snapshot.val() || {};
    });
}

// --- CORE FUNCTIONALITY ---
function handleCallNumber() {
    // Stop any previous timer
    if (countUpInterval) {
        clearInterval(countUpInterval);
    }
    
    const numberToCall = parseInt(numberInput.value, 10);

    // --- Validation ---
    if (isNaN(numberToCall) || numberToCall < 1 || numberToCall > 90) {
        updateStatus("Please enter a valid number between 1 and 90.", true);
        return;
    }
    if (gameStateCache.calledNumbers && gameStateCache.calledNumbers.includes(numberToCall)) {
        updateStatus(`Number ${numberToCall} has already been called.`, true);
        return;
    }
    
    // Disable controls and announce immediately
    callButton.disabled = true;
    numberInput.disabled = true;
    updateStatus(`Announcing <span class="success">${numberToCall}</span>...`, false);
    announceNumberToFirebase(numberToCall);
}


async function announceNumberToFirebase(number) {
    const gameStateRef = db.ref('gameState/currentState');
    try {
        await gameStateRef.transaction(currentState => {
            if (!currentState) {
                currentState = { calledNumbers: [], winners: {} };
            }
            if (!currentState.calledNumbers || !currentState.calledNumbers.includes(number)) {
                currentState.calledNumbers = [...(currentState.calledNumbers || []), number];
                currentState.winners = checkAllWinners(currentState.calledNumbers, currentState.winners || {});
            }
            return currentState;
        });

        // --- Success ---
        updateStatus(`Number <span class="success">${number}</span> was announced!`, false, true);
        startCountUpTimer(); // Start the new timer
        resetControls();

    } catch (error) {
        console.error("Firebase announcement failed:", error);
        updateStatus(`Failed to announce ${number}. Please try again.`, true);
        resetControls();
    }
}

function startCountUpTimer() {
    secondsSinceLastCall = 0;
    countUpTimer.style.display = 'block';
    countUpTimer.textContent = '00:00';

    countUpInterval = setInterval(() => {
        secondsSinceLastCall++;
        const minutes = Math.floor(secondsSinceLastCall / 60).toString().padStart(2, '0');
        const seconds = (secondsSinceLastCall % 60).toString().padStart(2, '0');
        countUpTimer.textContent = `${minutes}:${seconds}`;
    }, 1000);
}

function updateStatus(message, isError = false, isSuccess = false) {
    let textClass = '';
    if (isError) {
        textClass = 'error';
        statusDisplay.classList.remove('success');
    } else if (isSuccess) {
        textClass = 'success';
        statusDisplay.classList.add('success');
    } else {
        statusDisplay.classList.remove('success');
    }
    statusText.innerHTML = `<span class="${textClass}">${message}</span>`;
}


function resetControls() {
    callButton.disabled = false;
    numberInput.disabled = false;
    numberInput.value = '';
    numberInput.focus();
}


// --- WINNER CHECKING LOGIC (Copied from main file, no changes needed) ---
function checkAllWinners(calledNumbers, currentWinners) {
    let updatedWinners = { ...currentWinners };
    const activeDividends = gameSettingsData.dividends || [];
    const soldTickets = allTicketsData.filter(t => t.is_sold);
    const check = (numbers) => numbers.every(n => calledNumbers.includes(n));
    const countMarked = (ticket) => ticket.numbers.flat().filter(n => n > 0 && calledNumbers.includes(n)).length;
    const ticketsByOwner = {};
    for (const ticket of soldTickets) {
        if (ticket.owner_phone) {
            if (!ticketsByOwner[ticket.owner_phone]) {
                ticketsByOwner[ticket.owner_phone] = [];
            }
            ticketsByOwner[ticket.owner_phone].push(ticket);
        }
    }
    for (const dividend of activeDividends) {
        if (updatedWinners[dividend.name]) continue;
        if (dividend.name === 'Full Sheet Bonus' || dividend.name === 'Half Sheet Bonus') {
            for (const ownerPhone in ticketsByOwner) {
                const ownerTickets = ticketsByOwner[ownerPhone];
                const ownerName = ownerTickets[0].owner_name;
                const ticketsBySheet = {};
                for (const ticket of ownerTickets) {
                    const sheetNum = Math.floor((ticket.id - 1) / 6);
                    if (!ticketsBySheet[sheetNum]) {
                        ticketsBySheet[sheetNum] = [];
                    }
                    ticketsBySheet[sheetNum].push(ticket);
                }
                let winnerFound = false;
                for (const sheetNum in ticketsBySheet) {
                    const sheetTickets = ticketsBySheet[sheetNum];
                    if (dividend.name === 'Full Sheet Bonus' && sheetTickets.length === 6) {
                        const allTicketsMeetCondition = sheetTickets.every(t => countMarked(t) >= 2);
                        if (allTicketsMeetCondition) {
                            updatedWinners[dividend.name] = { name: ownerName, ticketId: `Sheet ${parseInt(sheetNum) + 1}`, won_at: firebase.database.ServerValue.TIMESTAMP };
                            winnerFound = true;
                            break;
                        }
                    }
                    if (dividend.name === 'Half Sheet Bonus' && sheetTickets.length >= 3) {
                         const validHalfSheets = [[sheetTickets[0], sheetTickets[1], sheetTickets[2]], [sheetTickets[3], sheetTickets[4], sheetTickets[5]]].filter(Boolean);
                         for(const halfSheet of validHalfSheets){
                             if(halfSheet && halfSheet.length === 3){
                                const allTicketsMeetCondition = halfSheet.every(t => countMarked(t) >= 2);
                                if (allTicketsMeetCondition) {
                                    updatedWinners[dividend.name] = { name: ownerName, ticketId: `Half Sheet in ${parseInt(sheetNum) + 1}`, won_at: firebase.database.ServerValue.TIMESTAMP };
                                    winnerFound = true;
                                    break;
                                }
                             }
                         }
                    }
                }
                if (winnerFound) break;
            }
            continue;
        }
        for (const ticket of soldTickets) {
            let isWinner = false;
            const allTicketNumbers = ticket.numbers.flat().filter(n => n > 0);
            if (dividend.name.startsWith("Early") || dividend.name.startsWith("Quick")) {
                const count = parseInt(dividend.name.match(/\d+/)[0], 10);
                if (countMarked(ticket) >= count) isWinner = true;
            } else if (dividend.name.includes("Full House")) {
                const fullHouseClaimedCount = Object.keys(updatedWinners).filter(w => w.includes("Full House")).length;
                if (check(allTicketNumbers)) {
                    if (dividend.name === "First Full House" && fullHouseClaimedCount === 0) isWinner = true;
                    else if (dividend.name === "Second Full House" && fullHouseClaimedCount === 1) isWinner = true;
                    else if (dividend.name === "Third Full House" && fullHouseClaimedCount === 2) isWinner = true;
                }
            } else {
                const numbersInRow1 = ticket.numbers[0].filter(n => n > 0);
                const numbersInRow2 = ticket.numbers[1].filter(n => n > 0);
                const numbersInRow3 = ticket.numbers[2].filter(n => n > 0);
                const findFirstNum = (row) => row.find(n => n > 0);
                const findLastNum = (row) => [...row].reverse().find(n => n > 0);
                const corners = [findFirstNum(ticket.numbers[0]), findLastNum(ticket.numbers[0]), findFirstNum(ticket.numbers[2]), findLastNum(ticket.numbers[2])].filter(Boolean);
                if (dividend.name === "Top Line" && numbersInRow1.length > 0 && check(numbersInRow1)) isWinner = true;
                else if (dividend.name === "Middle Line" && numbersInRow2.length > 0 && check(numbersInRow2)) isWinner = true;
                else if (dividend.name === "Bottom Line" && numbersInRow3.length > 0 && check(numbersInRow3)) isWinner = true;
                else if (dividend.name === "Corners (4)") {
                    if (corners.length === 4 && check(corners)) isWinner = true;
                } else if (dividend.name === "Star") {
                    const centerNumber = ticket.numbers[1][4];
                    const starNumbers = [...corners];
                    if (centerNumber > 0) starNumbers.push(centerNumber);
                    if (starNumbers.length === 5 && check(starNumbers)) isWinner = true;
                }
            }
            if (isWinner) {
                updatedWinners[dividend.name] = { name: ticket.owner_name, ticketId: ticket.id, won_at: firebase.database.ServerValue.TIMESTAMP };
                break;
            }
        }
    }
    return updatedWinners;
}


// --- EVENT LISTENERS ---
callButton.addEventListener('click', handleCallNumber);
numberInput.addEventListener('keyup', (e) => {
    if (e.key === "Enter") {
        handleCallNumber();
    }
});
logoutButton.addEventListener('click', () => {
    auth.signOut();
});

</script>

</body>
</html>
